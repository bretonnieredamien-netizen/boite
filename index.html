<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoÃ®te Magique âœ¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Short+Stack&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Short Stack', cursive; background: #fffdf2; }
        .pulsate { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body class="flex flex-col items-center p-6 min-h-screen">

    <h1 class="text-3xl font-bold text-amber-600 mb-6">BoÃ®te Magique âœ¨</h1>

    <div class="w-full max-w-md bg-white p-4 rounded-2xl shadow-sm border border-amber-100 text-center mb-6">
        <p id="status-text" class="text-amber-900 font-bold">PrÃªt pour l'aventure !</p>
    </div>

    <div class="w-full max-w-md flex gap-2 mb-6">
        <input type="text" id="userInput" placeholder="Ex: Un petit chat..." 
               class="flex-1 border-2 border-amber-200 p-4 rounded-2xl outline-none focus:border-amber-500 shadow-inner">
        <button onclick="lancerMagie()" class="bg-amber-500 text-white px-6 py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-all">OK</button>
    </div>

    <button id="mic-btn" onclick="lancerMicro()" class="bg-amber-400 p-12 rounded-full shadow-2xl border-8 border-white mb-8 transition-all">
        <span class="text-6xl">ðŸŽ¤</span>
    </button>

    <div id="result-card" class="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl p-8 hidden border-2 border-amber-50">
        <div id="story-text" class="text-xl leading-relaxed text-gray-800 italic mb-6"></div>
        <img id="story-img" class="w-full rounded-3xl shadow-lg hidden">
    </div>

    <div id="console" class="mt-8 w-full max-w-md bg-black text-green-400 p-3 rounded-lg font-mono text-[10px] opacity-70 overflow-auto max-h-32">
        > SystÃ¨me prÃªt (Mode Direct PRO).
    </div>

    <button onclick="localStorage.clear(); location.reload();" class="mt-6 text-[10px] text-gray-400 underline">RÃ‰INITIALISER LA CLÃ‰</button>

    <script>
        // RÃ‰CUPÃ‰RATION DE LA CLÃ‰
        let API_KEY = localStorage.getItem('BOITE_STABLE_2026');
        if (!API_KEY) {
            API_KEY = prompt("Entre ta clÃ© API Gemini :");
            if(API_KEY) localStorage.setItem('BOITE_STABLE_2026', API_KEY);
        }

        const MODEL_ID = "gemini-1.5-pro"; // On force le modÃ¨le Pro
        const log = (msg) => {
            const c = document.getElementById('console');
            c.innerHTML += `<div>> ${msg}</div>`;
            c.scrollTop = c.scrollHeight;
        };

        // 1. FONCTION PRINCIPALE
        async function lancerMagie() {
            const input = document.getElementById('userInput');
            const theme = input.value.trim();
            if (!theme) return;

            document.getElementById('status-text').innerText = "La magie opÃ¨re...";
            log(`Demande : ${theme}`);

            // URL STABLE
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_ID}:generateContent?key=${API_KEY}`;
            
            try {
                log("Envoi Ã  Google...");
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: "Raconte une histoire trÃ¨s courte et magique pour enfant sur : " + theme }]
                        }],
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                        ]
                    })
                });

                const data = await response.json();

                if (data.candidates && data.candidates[0].content) {
                    const texte = data.candidates[0].content.parts[0].text;
                    log("SuccÃ¨s !");
                    afficherResultat(texte, theme);
                } else if (data.error) {
                    log("ERREUR : " + data.error.message);
                    alert("Erreur de clÃ© : " + data.error.message);
                } else {
                    log("Blocage de sÃ©curitÃ©. Essaie un autre mot.");
                    alert("Google bloque ce sujet. Essaie quelque chose de plus doux.");
                }
            } catch (e) {
                log("Erreur rÃ©seau.");
            }
        }

        function afficherResultat(texte, sujet) {
            document.getElementById('status-text').innerText = "Il Ã©tait une fois...";
            document.getElementById('result-card').classList.remove('hidden');
            document.getElementById('story-text').innerText = texte;
            
            const img = document.getElementById('story-img');
            img.src = `https://image.pollinations.ai/prompt/drawing_child_illustration_${encodeURIComponent(sujet)}?nologo=true`;
            img.classList.remove('hidden');

            const utter = new SpeechSynthesisUtterance(texte);
            utter.lang = 'fr-FR';
            window.speechSynthesis.speak(utter);
        }

        function lancerMicro() {
            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!Speech) return alert("Micro non supportÃ©.");
            const rec = new Speech();
            rec.lang = 'fr-FR';
            rec.onstart = () => document.getElementById('status-text').innerText = "Je t'Ã©coute...";
            rec.onresult = (e) => {
                const text = e.results[0][0].transcript;
                document.getElementById('userInput').value = text;
                lancerMagie();
            };
            rec.start();
        }
    </script>
</body>
</html>