<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ta boite magique ✨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;500;800;900&display=swap" rel="stylesheet">
    <style>
        /* Fond Moderne Animé */
        body { 
            font-family: 'Lexend', sans-serif; 
            background: linear-gradient(-45deg, #fff7ed, #fef9c3, #ede9fe, #fae8ff);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            touch-action: manipulation; 
            overflow-x: hidden;
            min-height: 100vh;
            margin: 0;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .hidden { display: none !important; }
        .content-layer { position: relative; z-index: 10; width: 100%; display: flex; flex-direction: column; align-items: center; }

        /* --- LOGO BRANDING --- */
        .brand-header { position: absolute; top: 1.5rem; left: 1.5rem; display: flex; align-items: center; gap: 0.5rem; z-index: 20; }
        .mini-logo-text { font-weight: 900; font-size: 1.2rem; background: linear-gradient(135deg, #22d3ee, #818cf8, #c084fc, #34d399); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -0.03em; text-transform: lowercase; }

        /* --- LOGO CENTRAL --- */
        .modern-logo {
            font-weight: 900; font-size: 3.2rem;
            background: linear-gradient(135deg, #22d3ee, #818cf8, #c084fc, #34d399);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 4px 15px rgba(129, 140, 248, 0.4));
            letter-spacing: -0.04em; text-transform: lowercase; line-height: 1.2;
            opacity: 0; animation: introFade 2s ease-out forwards, slowBeat 5s ease-in-out infinite 2s;
        }
        @keyframes introFade { 0% { opacity: 0; transform: translateY(15px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes slowBeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.04); } }

        /* --- ORBES DE CONTRÔLE --- */
        .orbe-base {
            position: relative; width: 110px; height: 110px;
            background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(15px);
            border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.8);
            display: flex; align-items: center; justify-content: center;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer;
        }
        .orbe-base svg { width: 40px; height: 40px; transition: all 0.5s ease; }

        #btn-mic { box-shadow: 0 10px 30px rgba(129, 140, 248, 0.2), inset 0 0 20px rgba(255, 255, 255, 0.5); }
        #btn-mic svg { fill: #6366f1; filter: drop-shadow(0 0 8px rgba(99, 102, 241, 0.4)); }
        
        #btn-stop { box-shadow: 0 10px 30px rgba(248, 113, 113, 0.1), inset 0 0 20px rgba(255, 255, 255, 0.5); border-color: rgba(248, 113, 113, 0.4); }
        #btn-stop svg { fill: #f87171; filter: drop-shadow(0 0 8px rgba(248, 113, 113, 0.4)); }

        .mic-listening { background: rgba(99, 102, 241, 0.15) !important; border-color: #818cf8 !important; box-shadow: 0 0 50px rgba(99, 102, 241, 0.6) !important; transform: scale(1.1); }
        
        /* --- ÉCRAN D'IMAGE --- */
        #story-display {
            width: 100%; max-width: 500px; aspect-ratio: 1/1;
            /* Fond de secours coloré pendant le chargement */
            background: linear-gradient(135deg, #e0e7ff, #f5f3ff);
            backdrop-filter: blur(20px);
            border-radius: 3rem; border: 4px solid white;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.2);
            overflow: hidden; position: relative; margin-top: 2rem;
            display: flex; align-items: center; justify-content: center;
        }

        #story-image {
            width: 100%; height: 100%; object-fit: cover;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            animation: slowZoom 60s linear infinite;
        }

        @keyframes slowZoom {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }

        .image-visible { opacity: 1 !important; }

        /* --- UI --- */
        .status-box { background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); padding: 0.6rem 1.8rem; border-radius: 9999px; border: 1px solid rgba(255, 255, 255, 0.5); margin-top: 1.5rem; }
        .status-animating { animation: status-glow 1.5s infinite ease-in-out; color: #6366f1 !important; }
        @keyframes status-glow { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; transform: scale(1.02); } }
        
        .understood-flash { animation: success-pulse 0.8s ease-out !important; background: rgba(16, 185, 129, 0.2) !important; border-color: #10b981 !important; }
        @keyframes success-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); box-shadow: 0 0 60px #10b981; } 100% { transform: scale(1); } }
        
        .glass-ui { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); border: 1px solid white; }
    </style>
</head>
<body class="p-6">

    <div class="content-layer min-h-screen">
        
        <div class="brand-header">
            <svg class="w-8 h-8" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 12V8H4V12" stroke="#818cf8" stroke-width="2" stroke-linecap="round"/>
                <path d="M4 12L2.5 17C2.2 18 3 19 4 19H20C21 19 21.8 18 21.5 17L20 12H4Z" fill="rgba(129,140,248,0.2)" stroke="#818cf8" stroke-width="2"/>
            </svg>
            <span class="mini-logo-text">tbm.</span>
        </div>

        <header class="text-center flex flex-col items-center mt-12">
            <h1 class="modern-logo">ta boite magique</h1>
            <div class="status-box">
                <p id="status" class="text-indigo-900/60 font-semibold italic text-sm">Que veux-tu écouter comme histoire ?</p>
            </div>
        </header>

        <main class="w-full max-w-md flex flex-col items-center gap-10 mt-10">
            
            <div class="flex items-center justify-center gap-12 w-full">
                <div class="flex flex-col items-center gap-4">
                    <button id="btn-mic" class="orbe-base shadow-2xl">
                        <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                    </button>
                    <span class="text-indigo-900/40 text-[11px] font-bold uppercase tracking-widest">Écouter</span>
                </div>

                <div id="stop-container" class="flex flex-col items-center gap-4 opacity-20 pointer-events-none transition-all duration-500">
                    <button id="btn-stop" class="orbe-base shadow-xl">
                        <svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
                    </button>
                    <span class="text-red-900/40 text-[11px] font-bold uppercase tracking-widest">Arrêter</span>
                </div>
            </div>

            <div id="story-display" class="hidden">
                <img id="story-image" src="" alt="Illustration de l'aventure">
            </div>

            <div id="keyboard-area" class="w-full flex gap-2 glass-ui p-2 rounded-2xl shadow-xl hidden">
                <input type="text" id="manualInput" placeholder="Sujet de l'aventure..." class="flex-1 bg-white/40 p-4 rounded-xl outline-none text-sm font-medium">
                <button id="btn-ok" class="bg-indigo-500 text-white px-7 py-4 rounded-xl font-bold">OK</button>
            </div>

            <button id="toggle-input" class="p-4 rounded-full shadow-sm active:scale-90 opacity-40">
                <span class="text-2xl">⌨️</span>
            </button>
        </main>

        <footer class="mt-auto py-10">
            <button onclick="reinitialiserCle()" class="text-gray-400 text-[10px] uppercase underline tracking-widest opacity-30">Réinitialiser la clé API</button>
        </footer>
    </div>

    <script>
        let API_KEY = localStorage.getItem('BOITE_FINAL_KEY_2026');
        const MODEL_ID = "models/gemini-2.5-flash"; 
        const synth = window.speechSynthesis;
        let speechQueue = [];
        let isSpeaking = false;
        let audioCtx = null;

        function playChime() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(1244.51, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1567.98, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.5);
        }

        function loadVoices() {
            const voices = synth.getVoices();
            bestVoice = voices.find(v => v.lang.includes('fr') && (v.name.includes('Siri') || v.name.includes('Premium') || v.name.includes('Google')))
                       || voices.find(v => v.lang.includes('fr'));
        }
        synth.onvoiceschanged = loadVoices; loadVoices();

        async function genererImage(sujet) {
            const imgEl = document.getElementById('story-image');
            imgEl.classList.remove('image-visible');
            
            // On nettoie le sujet pour l'URL
            const cleanSujet = sujet.replace(/[^\w\s]/gi, '').trim();
            const promptImage = `Cinematic 3d digital art for children, vivid aurora colors, soft lighting, magical atmosphere, high definition, ${cleanSujet}`;
            const seed = Math.floor(Math.random() * 1000000);
            
            // URL Directe
            const url = `https://pollinations.ai/p/${encodeURIComponent(promptImage)}?width=1024&height=1024&seed=${seed}&model=flux&nologo=true`;
            
            imgEl.src = url;
            imgEl.onload = () => {
                imgEl.classList.add('image-visible');
            };
            imgEl.onerror = () => {
                console.error("Erreur de chargement d'image");
                document.getElementById('story-display').style.background = "linear-gradient(45deg, #818cf8, #34d399)";
            };
        }

        function stopAudio() {
            synth.cancel(); speechQueue = []; isSpeaking = false;
            document.getElementById('status').classList.remove('status-animating');
            toggleStopButton(false);
            document.getElementById('story-display').classList.add('hidden');
        }

        function toggleStopButton(active) {
            const container = document.getElementById('stop-container');
            if (active) { container.classList.remove('opacity-20', 'pointer-events-none'); container.classList.add('opacity-100'); }
            else { container.classList.add('opacity-20', 'pointer-events-none'); container.classList.remove('opacity-100'); }
        }

        async function appelIA(sujet) {
            if (!API_KEY) return;
            stopAudio();
            const btnMic = document.getElementById('btn-mic');
            const statusLabel = document.getElementById('status');
            const display = document.getElementById('story-display');

            playChime();
            btnMic.classList.add('understood-flash');
            statusLabel.innerText = "Je tisse ton aventure...";
            statusLabel.classList.add('status-animating');
            
            // Afficher et lancer l'image
            display.classList.remove('hidden');
            genererImage(sujet);

            setTimeout(() => { btnMic.classList.remove('understood-flash'); toggleStopButton(true); }, 800);

            const url = `https://generativelanguage.googleapis.com/v1beta/${MODEL_ID}:streamGenerateContent?alt=sse&key=${API_KEY}`;
            const promptIA = `Raconte une aventure réaliste et captivante pour un enfant sur : "${sujet}". Pas de magie. STRUCTURE : Début, milieu, fin positive. Termine par le mot "FIN".`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: promptIA }] }], generationConfig: { temperature: 0.7 } })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let currentSentence = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) { 
                        if (currentSentence.trim()) speechQueue.push(currentSentence.trim()); 
                        parler(); 
                        break; 
                    }
                    const chunk = decoder.decode(value);
                    const lines = chunk.split("\n");
                    for (const line of lines) {
                        if (line.startsWith("data: ")) {
                            try {
                                const json = JSON.parse(line.substring(6));
                                const text = json.candidates[0].content.parts[0].text;
                                currentSentence += text;
                                if (/[.!?\n]/.test(text)) {
                                    speechQueue.push(currentSentence.trim());
                                    currentSentence = "";
                                    parler();
                                }
                            } catch(e) {}
                        }
                    }
                }
            } catch (e) { statusLabel.innerText = "Erreur technique..."; }
        }

        function parler() {
            if (isSpeaking || speechQueue.length === 0) return;
            isSpeaking = true;
            let txt = speechQueue.shift().replace(/[#*`_]/g, '');
            const utter = new SpeechSynthesisUtterance(txt);
            utter.lang = 'fr-FR'; utter.pitch = 1.05; utter.rate = 0.83; 
            utter.onend = () => { 
                isSpeaking = false; 
                if(speechQueue.length === 0) { 
                    toggleStopButton(false); 
                    document.getElementById('status').innerText = "Histoire terminée ✨"; 
                    document.getElementById('status').classList.remove('status-animating');
                } 
                parler(); 
            };
            window.speechSynthesis.speak(utter);
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('toggle-input').onclick = () => document.getElementById('keyboard-area').classList.toggle('hidden');
            document.getElementById('btn-ok').onclick = () => { const val = document.getElementById('manualInput').value.trim(); if(val) appelIA(val); };
            document.getElementById('btn-mic').onclick = () => {
                const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!Speech) return alert("Micro non supporté.");
                const rec = new Speech(); rec.lang = 'fr-FR';
                rec.onstart = () => { document.getElementById('btn-mic').classList.add('mic-listening'); document.getElementById('status').innerText = "Je t'écoute..."; };
                rec.onresult = (e) => appelIA(e.results[0][0].transcript);
                rec.onend = () => document.getElementById('btn-mic').classList.remove('mic-listening');
                try { rec.start(); } catch (e) {}
            };
            document.getElementById('btn-stop').onclick = stopAudio;
        });
        function reinitialiserCle() { localStorage.removeItem('BOITE_FINAL_KEY_2026'); location.reload(); }
    </script>
</body>
</html>