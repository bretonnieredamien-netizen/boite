<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R√™veur - Histoires du soir</title>
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- BASE & TYPO --- */
        body { font-family: 'Quicksand', sans-serif; background-color: #020617; color: #e2e8f0; overflow-x: hidden; }
        h1, h2, h3, .brand-font { font-family: 'Fredoka', sans-serif; }
        
        /* --- BACKGROUND √âTOIL√â --- */
        .stars-bg {
            background: radial-gradient(circle at 50% 0%, #312e81 0%, #0f172a 60%, #020617 100%);
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
        }
        .star { position: absolute; background: white; border-radius: 50%; opacity: 0.3; animation: twinkle 4s infinite ease-in-out; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(1); } 50% { opacity: 0.8; transform: scale(1.2); } }

        /* --- GLASSMORPHISM --- */
        .glass { 
            background: rgba(30, 41, 59, 0.4); 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        /* --- INPUTS --- */
        .modern-input {
            width: 100%; background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255, 255, 255, 0.1);
            color: white; padding: 1rem 1rem 1rem 3rem; border-radius: 1rem;
            transition: all 0.3s ease; outline: none; font-size: 1rem;
        }
        .modern-input:focus { border-color: #818cf8; background: rgba(15, 23, 42, 0.9); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }
        .input-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #818cf8; font-size: 1.2rem; }

        /* --- UI UTILS --- */
        .gender-btn {
            flex: 1; padding: 0.8rem; border-radius: 0.8rem; border: 1px solid rgba(255,255,255,0.1);
            background: rgba(15, 23, 42, 0.6); color: #94a3b8; font-weight: 600; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .gender-btn.active { background: #4f46e5; color: white; border-color: #6366f1; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }

        .hidden-panel { display: none; }
        .fade-in { animation: fadeInUp 0.6s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- STORY TEXT --- */
        .story-text { line-height: 1.9; font-size: 1.15rem; color: #e2e8f0; white-space: pre-wrap; }
        .chapter-marker { text-align: center; margin: 3rem 0 1.5rem 0; position: relative; opacity: 0.8; }
        .chapter-marker::before { content: ""; position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, #6366f1, transparent); opacity: 0.5; }
        .chapter-badge { position: relative; background: #0f172a; padding: 0 1.5rem; color: #818cf8; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; font-weight: bold; border-radius: 99px; border: 1px solid rgba(99, 102, 241, 0.3); }

        /* Scrollbar Hide */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div class="stars-bg">
        <div class="star" style="top: 10%; left: 20%; width: 2px; height: 2px;"></div>
        <div class="star" style="top: 30%; left: 80%; width: 3px; height: 3px; animation-delay: 1s;"></div>
        <div class="star" style="top: 70%; left: 10%; width: 2px; height: 2px; animation-delay: 2s;"></div>
        <div class="star" style="top: 50%; left: 50%; width: 1px; height: 1px;"></div>
    </div>

    <div class="text-center mb-6 z-10">
        <div class="inline-block p-3 rounded-full bg-indigo-500/20 mb-2 border border-indigo-400/20 backdrop-blur-sm">
            <i class="fa-solid fa-moon text-3xl text-indigo-300"></i>
        </div>
        <h1 class="text-4xl font-bold text-white tracking-wide drop-shadow-lg brand-font">R√™veur</h1>
    </div>

    <div id="setup-panel" class="w-full max-w-md hidden-panel fade-in">
        <div class="glass rounded-3xl p-6 md:p-8">
            <h2 class="text-xl text-center text-white mb-6 font-semibold">Qui √©coute l'histoire ?</h2>
            
            <div class="space-y-5 mb-8">
                <div class="relative">
                    <i class="fa-solid fa-child input-icon"></i>
                    <input type="text" id="childName" placeholder="Pr√©nom de l'enfant" class="modern-input">
                </div>
                <div class="flex gap-3">
                    <div class="relative w-1/3">
                        <i class="fa-solid fa-cake-candles input-icon text-sm"></i>
                        <input type="number" id="childAge" placeholder="√Çge" class="modern-input pl-10 text-center">
                    </div>
                    <div class="flex flex-1 gap-2">
                        <button onclick="setGender('gar√ßon')" id="btn-boy" class="gender-btn active"><i class="fa-solid fa-mars"></i> Gar√ßon</button>
                        <button onclick="setGender('fille')" id="btn-girl" class="gender-btn"><i class="fa-solid fa-venus"></i> Fille</button>
                    </div>
                </div>
                <div class="h-px w-full bg-white/10 my-4"></div>
                <div class="relative">
                    <i class="fa-solid fa-paw input-icon"></i>
                    <input type="text" id="doudouName" placeholder="Nom du doudou" class="modern-input">
                </div>
                <div class="relative">
                    <i class="fa-solid fa-wand-sparkles input-icon"></i>
                    <input type="text" id="doudouDesc" placeholder="Il est comment ? (ex: Ours bleu)" class="modern-input">
                </div>
            </div>

            <button onclick="saveProfile()" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white font-bold rounded-2xl shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                <span>Cr√©er le profil</span> <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <div id="request-panel" class="w-full max-w-md hidden-panel fade-in">
        <div class="glass p-4 rounded-2xl mb-6 flex items-center justify-between border-indigo-500/30">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center text-lg">üß∏</div>
                <div>
                    <h3 class="font-bold text-white text-sm" id="profile-summary">Profil</h3>
                    <p class="text-xs text-indigo-300">Pr√™t pour le dodo</p>
                </div>
            </div>
            <button onclick="resetProfile()" class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-gray-400 transition"><i class="fa-solid fa-pen"></i></button>
        </div>

        <div class="glass rounded-3xl p-6">
            <h2 class="text-lg text-center text-white mb-4">De quoi parle l'histoire ce soir ?</h2>
            
            <div class="relative mb-4">
                <textarea id="storyRequest" rows="4" placeholder="Ex: Peppa Pig et Lucas font un pique-nique sur la lune..." class="w-full bg-slate-900/50 border border-slate-700 rounded-2xl p-4 text-white placeholder-slate-500 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition outline-none resize-none"></textarea>
                <div class="absolute bottom-3 right-3 text-indigo-500 text-xl"><i class="fa-solid fa-magic"></i></div>
            </div>

            <label class="flex items-center gap-3 p-3 rounded-xl bg-slate-800/50 border border-white/5 cursor-pointer mb-6 hover:bg-slate-800 transition">
                <div class="relative flex items-center">
                    <input type="checkbox" id="includeChild" class="peer sr-only" checked>
                    <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                </div>
                <span class="text-sm text-gray-300 select-none">Inclure <span id="label-child-name" class="font-bold text-white">l'enfant</span> dans l'aventure ?</span>
            </label>

            <div class="flex flex-wrap gap-2 mb-6">
                <button onclick="addTag('Dinosaures')" class="px-3 py-1 rounded-full bg-white/5 border border-white/10 text-xs text-indigo-200 hover:bg-white/10 transition">ü¶ï Dinosaures</button>
                <button onclick="addTag('L\'espace')" class="px-3 py-1 rounded-full bg-white/5 border border-white/10 text-xs text-indigo-200 hover:bg-white/10 transition">üöÄ L'espace</button>
                <button onclick="addTag('La Ferme')" class="px-3 py-1 rounded-full bg-white/5 border border-white/10 text-xs text-indigo-200 hover:bg-white/10 transition">üöú La Ferme</button>
            </div>

            <button onclick="startStory()" class="w-full py-4 bg-indigo-500 hover:bg-indigo-400 text-white font-bold rounded-2xl shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                <i class="fa-solid fa-book-open"></i> <span>Raconter l'histoire</span>
            </button>
            
            <button onclick="openLibrary()" class="w-full mt-4 py-3 bg-white/5 hover:bg-white/10 text-indigo-200 text-sm font-bold rounded-2xl border border-white/5 transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-bookmark"></i> <span>Ma Biblioth√®que</span>
            </button>
        </div>
    </div>
    
    <div id="library-panel" class="w-full max-w-md hidden-panel fade-in">
        <div class="glass rounded-3xl p-6 min-h-[50vh]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl text-white font-bold brand-font">Mes Histoires</h2>
                <button onclick="showPanel('request-panel')" class="text-sm text-indigo-300 hover:text-white bg-white/5 px-3 py-1 rounded-full">Retour</button>
            </div>
            <div id="library-list" class="space-y-3 max-h-[60vh] overflow-y-auto scrollbar-hide"></div>
        </div>
    </div>

    <div id="reading-panel" class="w-full max-w-lg hidden-panel fade-in pb-24">
        <div class="flex justify-between items-center mb-6 px-2 sticky top-0 z-20 py-2 bg-slate-900/0 backdrop-blur-sm rounded-xl">
            <div class="flex items-center gap-2 text-indigo-300">
                <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                <span class="text-xs font-bold uppercase tracking-widest">Lecture en cours</span>
            </div>
            <button onclick="closeStory()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-white/50 hover:bg-red-500/20 hover:text-red-200 transition"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <div id="story-scroll-area" class="space-y-8 min-h-[50vh]"></div>

        <div id="initial-loader" class="hidden flex-col items-center py-12">
            <div class="relative w-16 h-16">
                <div class="absolute inset-0 border-4 border-indigo-500/30 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
            </div>
            <p class="text-indigo-300 mt-4 text-sm animate-pulse font-medium">L'histoire commence...</p>
        </div>

        <div class="mt-8 px-4 fixed bottom-6 left-0 right-0 max-w-lg mx-auto z-30 pointer-events-none">
            <button id="next-chapter-btn" onclick="revealNextChapter()" class="hidden w-full py-4 bg-indigo-600/90 backdrop-blur shadow-2xl shadow-indigo-900/50 border border-indigo-400/30 rounded-2xl text-white font-bold transition flex items-center justify-center gap-2 pointer-events-auto transform hover:scale-[1.02]">
                <span>Lire la suite</span> <i class="fa-solid fa-arrow-down"></i>
            </button>
            <p id="preload-status" class="text-center text-[10px] text-indigo-400 mt-2 h-4 uppercase tracking-widest opacity-0 transition-opacity duration-500"></p>
        </div>

        <div id="the-end" class="hidden mt-16 mb-10 text-center opacity-0 transition-opacity duration-1000">
            <div class="inline-block p-4 rounded-full bg-indigo-500/10 mb-4 text-4xl">üò¥</div>
            <h3 class="text-2xl font-bold text-white mb-1 brand-font">Fin de l'histoire</h3>
            <p class="text-indigo-400 text-sm">Fais de beaux r√™ves...</p>
            <button id="save-btn" onclick="saveCurrentStory()" class="mt-8 mb-4 px-6 py-3 bg-pink-500/20 text-pink-200 border border-pink-500/30 rounded-full text-sm font-bold hover:bg-pink-500/40 transition flex items-center justify-center gap-2 mx-auto">
                <i class="fa-solid fa-heart"></i> Sauvegarder l'histoire
            </button>
            <button onclick="closeStory()" class="mt-4 px-6 py-2 rounded-full border border-white/10 text-sm text-white/40 hover:text-white hover:bg-white/5 transition">Retour au menu</button>
        </div>
    </div>

    <script>
        // --- VARIABLES ---
        let userProfile = null;
        let selectedGender = 'gar√ßon';
        let currentRequest = "";
        let isChildIncluded = true; // NOUVEAU
        
        let currentChapterIndex = 1;
        let totalChapters = 5; 
        let nextChapterContent = null;
        let isPreloading = false;
        let storySummary = "";
        let currentFullStory = [];

        // --- UI HELPERS ---
        function setGender(g) {
            selectedGender = g;
            document.getElementById('btn-boy').className = `gender-btn ${g === 'gar√ßon' ? 'active' : ''}`;
            document.getElementById('btn-girl').className = `gender-btn ${g === 'fille' ? 'active' : ''}`;
        }
        function addTag(tag) {
            const area = document.getElementById('storyRequest');
            if(area.value.length > 0) area.value += " ";
            area.value += tag;
        }
        function showPanel(id) {
            ['setup-panel', 'request-panel', 'reading-panel', 'library-panel'].forEach(p => {
                const el = document.getElementById(p);
                if (p === id) { el.style.display = 'block'; el.classList.add('fade-in'); } else { el.style.display = 'none'; }
            });
        }

        // --- PROFILE ---
        function loadProfile() {
            const saved = localStorage.getItem('reveur_profile');
            if (saved) {
                userProfile = JSON.parse(saved);
                showPanel('request-panel');
                document.getElementById('profile-summary').innerText = `${userProfile.childName} & ${userProfile.doudouName}`;
                document.getElementById('label-child-name').innerText = userProfile.childName; // Mise √† jour du label du switch
            } else {
                showPanel('setup-panel');
            }
        }
        function saveProfile() {
            const name = document.getElementById('childName').value;
            if(!name) return alert("Comment s'appelle l'enfant ?");
            const profile = {
                childName: name, childAge: document.getElementById('childAge').value || '3',
                childGender: selectedGender, doudouName: document.getElementById('doudouName').value || 'Doudou',
                doudouDesc: document.getElementById('doudouDesc').value || 'tout doux'
            };
            localStorage.setItem('reveur_profile', JSON.stringify(profile));
            loadProfile();
        }
        function resetProfile() { localStorage.removeItem('reveur_profile'); loadProfile(); }

        // --- STORY ENGINE ---
        async function startStory() {
            currentRequest = document.getElementById('storyRequest').value;
            if (!currentRequest) return alert("Il manque le th√®me de l'histoire !");
            
            // R√©cup√®re l'√©tat du switch
            isChildIncluded = document.getElementById('includeChild').checked;

            // Reset UI
            currentChapterIndex = 1; totalChapters = 5; storySummary = ""; nextChapterContent = null; currentFullStory = [];
            document.getElementById('story-scroll-area').innerHTML = "";
            document.getElementById('the-end').classList.add('hidden');
            document.getElementById('the-end').style.opacity = '0';
            document.getElementById('save-btn').style.display = 'flex';
            document.getElementById('next-chapter-btn').classList.add('hidden');
            
            showPanel('reading-panel');
            await fetchAndDisplayChapter(1);
        }

        async function fetchAndDisplayChapter(chapterNum) {
            document.getElementById('initial-loader').classList.remove('hidden');
            document.getElementById('next-chapter-btn').classList.add('hidden');
            document.getElementById('preload-status').style.opacity = '0';

            try {
                let text = "";
                if (chapterNum > 1 && nextChapterContent) {
                    text = nextChapterContent;
                    nextChapterContent = null;
                } else {
                    text = await callAI(chapterNum);
                }

                addTextToPage(text, chapterNum);
                document.getElementById('initial-loader').classList.add('hidden');

                if (chapterNum < totalChapters) {
                    preloadNextChapter(chapterNum + 1);
                } else {
                    document.getElementById('the-end').classList.remove('hidden');
                    setTimeout(() => { document.getElementById('the-end').style.opacity = '1'; }, 100);
                }
            } catch (e) { alert("Oups : " + e.message); closeStory(); }
        }

        async function preloadNextChapter(nextChapterNum) {
            if (isPreloading) return;
            isPreloading = true;
            document.getElementById('preload-status').style.opacity = '1';
            document.getElementById('preload-status').innerText = "La suite s'√©crit...";
            try {
                nextChapterContent = await callAI(nextChapterNum);
                document.getElementById('next-chapter-btn').classList.remove('hidden');
                document.getElementById('preload-status').style.opacity = '0';
            } catch (e) { console.error(e); } finally { isPreloading = false; }
        }

        async function callAI(chapter) {
            const res = await fetch('/api/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    profile: userProfile, 
                    request: currentRequest, 
                    chapter: chapter, 
                    previousSummary: storySummary,
                    includeChild: isChildIncluded // Envoi du param√®tre
                })
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            if (data.totalChapters) totalChapters = data.totalChapters;
            storySummary = data.text.slice(-300);
            return data.text;
        }

        function addTextToPage(text, chapterNum) {
            currentFullStory[chapterNum - 1] = text; 
            const container = document.getElementById('story-scroll-area');
            if (chapterNum > 1) {
                const marker = document.createElement('div'); marker.className = "chapter-marker fade-in";
                marker.innerHTML = `<span class="chapter-badge">Chapitre ${chapterNum} / ${totalChapters}</span>`;
                container.appendChild(marker);
            }
            const p = document.createElement('div');
            p.className = "story-text fade-in glass p-6 md:p-8 rounded-2xl border-l-4 border-indigo-500 shadow-lg";
            p.innerText = text;
            container.appendChild(p);
            if(chapterNum > 1) setTimeout(() => { p.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
        }

        function revealNextChapter() { if (nextChapterContent) { currentChapterIndex++; fetchAndDisplayChapter(currentChapterIndex); } }
        function closeStory() { showPanel('request-panel'); document.getElementById('storyRequest').value = ""; }

        // --- LIBRARY ---
        function saveCurrentStory() {
            if(currentFullStory.length === 0) return;
            const title = currentRequest.substring(0, 30) + "...";
            const storyData = { id: Date.now(), title: title, date: new Date().toLocaleDateString(), fullText: currentFullStory, profile: userProfile.childName, totalChapters: totalChapters };
            let library = JSON.parse(localStorage.getItem('reveur_library') || '[]');
            library.unshift(storyData);
            localStorage.setItem('reveur_library', JSON.stringify(library));
            alert("Sauvegard√© ! ‚ù§Ô∏è");
            document.getElementById('save-btn').style.display = 'none';
        }

        function openLibrary() {
            showPanel('library-panel');
            const list = document.getElementById('library-list');
            const library = JSON.parse(localStorage.getItem('reveur_library') || '[]');
            list.innerHTML = "";
            if(library.length === 0) { list.innerHTML = '<div class="text-center mt-10 text-indigo-400/50">Aucune histoire.</div>'; return; }
            library.forEach(story => {
                const item = document.createElement('div');
                item.className = "p-4 bg-slate-800/50 rounded-xl border border-white/5 flex justify-between items-center mb-3 cursor-pointer hover:bg-slate-700/50";
                item.innerHTML = `<div onclick="readSavedStory(${story.id})" class="flex-1"><h3 class="text-white font-bold text-sm">${story.title}</h3><p class="text-xs text-indigo-400">${story.date}</p></div><button onclick="deleteStory(${story.id})" class="text-slate-500 hover:text-red-400"><i class="fa-solid fa-trash"></i></button>`;
                list.appendChild(item);
            });
        }

        function readSavedStory(id) {
            const story = JSON.parse(localStorage.getItem('reveur_library') || '[]').find(s => s.id === id);
            if(!story) return;
            showPanel('reading-panel');
            document.getElementById('story-scroll-area').innerHTML = "";
            document.getElementById('next-chapter-btn').classList.add('hidden');
            document.getElementById('initial-loader').classList.add('hidden');
            document.getElementById('the-end').classList.remove('hidden');
            document.getElementById('the-end').style.opacity = '1';
            document.getElementById('save-btn').style.display = 'none';
            const container = document.getElementById('story-scroll-area');
            story.fullText.forEach((text, i) => {
                const num = i + 1;
                if (num > 1) { const m = document.createElement('div'); m.className = "chapter-marker"; m.innerHTML = `<span class="chapter-badge">Chapitre ${num} / ${story.totalChapters}</span>`; container.appendChild(m); }
                const p = document.createElement('div'); p.className = "story-text glass p-6 rounded-2xl border-l-4 border-indigo-500 mb-6"; p.innerText = text; container.appendChild(p);
            });
        }

        function deleteStory(id) {
            if(!confirm("Supprimer ?")) return;
            let lib = JSON.parse(localStorage.getItem('reveur_library') || '[]');
            localStorage.setItem('reveur_library', JSON.stringify(lib.filter(s => s.id !== id)));
            openLibrary();
        }

        loadProfile();
    </script>
</body>
</html>