<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>La Bo√Æte Magique ‚ú®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Short+Stack&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Short Stack', cursive; background: #fffdf2; }
        .hidden { display: none !important; }
        #debug-log { background: #000; color: #0f0; font-family: monospace; font-size: 10px; padding: 10px; border-radius: 10px; margin-top: 20px; max-height: 100px; overflow-y: auto; width: 100%; }
    </style>
</head>
<body class="flex flex-col items-center p-6 min-h-screen">

    <h1 class="text-3xl font-bold text-amber-600 mb-8">Ma Bo√Æte Magique ‚ú®</h1>

    <div id="status-box" class="w-full max-w-md bg-white p-4 rounded-2xl shadow-md border-2 border-amber-100 text-center mb-6">
        <p id="status-text" class="text-amber-900">En attente de ton id√©e...</p>
    </div>

    <div class="w-full max-w-md flex gap-2 mb-10">
        <input type="text" id="manualInput" placeholder="Ex: Un petit robot..." 
               class="flex-1 border-2 border-amber-200 p-3 rounded-xl outline-none focus:border-amber-500">
        <button id="ok-btn" onclick="validerSaisie()" class="bg-amber-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg active:scale-90">OK</button>
    </div>

    <button id="mic-btn" onclick="ecouter()" class="bg-amber-400 p-12 rounded-full shadow-2xl border-8 border-white mb-8 opacity-50" disabled>
        <span class="text-5xl">üé§</span>
    </button>

    <div id="result-card" class="bg-white w-full max-w-md rounded-3xl shadow-xl p-6 hidden">
        <div id="story-display" class="text-lg text-gray-800 leading-relaxed italic mb-4"></div>
        <img id="story-img" class="w-full rounded-2xl shadow-inner hidden">
    </div>

    <div id="debug-log">> Syst√®me pr√™t.</div>

    <script>
        const API_KEY = localStorage.getItem('BOITE_MAGIQUE_KEY_2026');
        let modelFound = "";

        function log(msg) {
            const div = document.getElementById('debug-log');
            div.innerHTML += `<div>> ${msg}</div>`;
            div.scrollTop = div.scrollHeight;
        }

        // 1. Initialisation : Trouver le mod√®le
        async function init() {
            log("Recherche du mod√®le...");
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`);
                const data = await res.json();
                const m = data.models.find(m => m.name.includes('gemini-1.5-pro')) || data.models[0];
                modelFound = m.name;
                log("Mod√®le OK : " + modelFound);
                document.getElementById('mic-btn').disabled = false;
                document.getElementById('mic-btn').classList.remove('opacity-50');
                document.getElementById('status-text').innerText = "C'est pr√™t ! Tape un mot ou parle.";
            } catch (e) { log("Erreur Init : Cl√© API peut-√™tre invalide."); }
        }

        // 2. Fonction de validation (Appel√©e par le bouton OK)
        function validerSaisie() {
            const input = document.getElementById('manualInput');
            const theme = input.value.trim();
            
            if (!theme) {
                alert("√âcris quelque chose d'abord !");
                return;
            }

            log("Bouton OK cliqu√© : " + theme);
            document.getElementById('status-text').innerText = "Analyse de ton id√©e...";
            genererMagie(theme);
        }

        // 3. Appel IA (Simplifi√© au maximum)
        async function genererMagie(sujet) {
            log("Appel Google en cours...");
            const url = `https://generativelanguage.googleapis.com/v1beta/${modelFound}:generateContent?key=${API_KEY}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: `Raconte une histoire tr√®s courte (3 lignes), magique et gentille pour un enfant sur : ${sujet}.` }]
                        }]
                    })
                });

                const data = await response.json();
                log("R√©ponse re√ßue.");

                if (data.candidates && data.candidates[0].content) {
                    const texte = data.candidates[0].content.parts[0].text;
                    afficher(texte, sujet);
                } else {
                    log("Erreur : Google a renvoy√© une r√©ponse vide.", true);
                    alert("Google refuse de r√©pondre √† ce sujet. Essaie autre chose !");
                }
            } catch (error) {
                log("Erreur r√©seau ou API.");
                alert("La connexion a √©chou√©.");
            }
        }

        function afficher(texte, sujet) {
            document.getElementById('status-text').innerText = "Il √©tait une fois...";
            document.getElementById('result-card').classList.remove('hidden');
            document.getElementById('story-display').innerText = texte;
            
            const img = document.getElementById('story-img');
            img.src = `https://image.pollinations.ai/prompt/fairytale_illustration_${encodeURIComponent(sujet)}?nologo=true`;
            img.classList.remove('hidden');

            const utter = new SpeechSynthesisUtterance(texte);
            utter.lang = 'fr-FR';
            window.speechSynthesis.speak(utter);
        }

        // Lancement
        if (!API_KEY) {
            const key = prompt("Entre ta cl√© API Gemini :");
            localStorage.setItem('BOITE_MAGIQUE_KEY_2026', key);
            location.reload();
        } else {
            init();
        }
    </script>
</body>
</html>