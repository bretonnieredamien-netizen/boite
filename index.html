<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>La Bo√Æte √† Aventures ‚ú®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Short+Stack&display=swap" rel="stylesheet">
    <style>
        /* Fond Moderne Anim√© */
        body { 
            font-family: 'Short Stack', cursive; 
            background: linear-gradient(-45deg, #fff7ed, #fef9c3, #ede9fe, #fae8ff);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            touch-action: manipulation; 
            overflow-x: hidden;
            min-height: 100vh;
            margin: 0;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .hidden { display: none !important; }
        .content-layer { position: relative; z-index: 10; width: 100%; display: flex; flex-direction: column; align-items: center; }

        /* EFFET DE VALIDATION LUMINEUSE */
        .understood-flash {
            animation: success-pulse 0.8s ease-out !important;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            border-color: #ecfdf5 !important;
        }

        @keyframes success-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); box-shadow: 0 0 50px #10b981; }
            100% { transform: scale(1); }
        }

        /* Aura de la bo√Æte qui parle */
        .speaking-glow { box-shadow: 0 0 40px rgba(251, 191, 36, 0.5); border: 4px solid #fbbf24 !important; }

        /* STYLE COMMUN AUX ORBES (Micro et Stop) */
        .control-orbe {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 5px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        /* ORBE MICRO (AMBRE) */
        #btn-mic {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            box-shadow: 0 15px 35px rgba(245, 158, 11, 0.4);
        }

        /* ORBE STOP (ROUGE) */
        #btn-stop {
            background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
            box-shadow: 0 15px 35px rgba(239, 68, 68, 0.4);
        }

        .mic-listening {
            animation: pulse-mic 1.5s infinite ease-in-out;
            background: linear-gradient(135deg, #f87171 0%, #ef4444 100%) !important;
        }

        @keyframes pulse-mic { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        .glass-ui { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(8px); border: 1px solid white; }
        #toggle-input { background: rgba(255, 255, 255, 0.3); border: 1px solid rgba(255, 255, 255, 0.5); }
    </style>
</head>
<body class="p-6">

    <div class="content-layer min-h-screen">
        
        <header class="text-center my-10">
            <h1 class="text-4xl font-bold text-amber-600 drop-shadow-md">La Bo√Æte √† Aventures ‚ú®</h1>
            <p id="status" class="text-amber-800 mt-2 font-medium italic text-sm">Pr√™te pour une nouvelle exploration...</p>
        </header>

        <main class="w-full max-w-md flex flex-col items-center gap-10">
            
            <div class="flex items-center justify-center gap-8 w-full">
                <div class="flex flex-col items-center gap-3">
                    <button id="btn-mic" class="control-orbe active:scale-90 shadow-2xl">
                        <span id="mic-icon" class="text-6xl drop-shadow-sm">üé§</span>
                    </button>
                    <span class="text-amber-900/60 text-[10px] font-bold uppercase tracking-widest">Parler</span>
                </div>

                <div id="stop-container" class="flex flex-col items-center gap-3 opacity-30 pointer-events-none transition-all duration-500">
                    <button id="btn-stop" class="control-orbe active:scale-90 shadow-2xl">
                        <span class="text-5xl drop-shadow-sm">‚èπ</span>
                    </button>
                    <span class="text-red-900/60 text-[10px] font-bold uppercase tracking-widest">Arr√™ter</span>
                </div>
            </div>

            <div id="keyboard-area" class="w-full flex gap-2 glass-ui p-2 rounded-2xl shadow-xl hidden">
                <input type="text" id="manualInput" placeholder="√âcris ici..." 
                       class="flex-1 bg-white/90 p-4 rounded-xl outline-none text-sm">
                <button id="btn-ok" class="bg-amber-500 text-white px-6 py-4 rounded-xl font-bold active:scale-95 shadow-md">OK</button>
            </div>

            <button id="toggle-input" class="p-4 rounded-full shadow-sm active:scale-90">
                <span class="text-2xl">‚å®Ô∏è</span>
            </button>

            <div id="story-card" class="bg-white w-full rounded-[2.5rem] shadow-2xl border-4 border-white p-8 hidden max-h-[60vh] overflow-y-auto">
                <div id="story-text" class="text-lg leading-relaxed text-gray-800 italic whitespace-pre-line"></div>
            </div>

        </main>

        <footer class="mt-auto py-10">
            <button onclick="reinitialiserCle()" class="text-gray-400 text-[10px] uppercase underline tracking-widest opacity-70">R√©initialiser la cl√© API</button>
        </footer>

    </div>

    <script>
        let API_KEY = localStorage.getItem('BOITE_FINAL_KEY_2026');
        const MODEL_ID = "models/gemini-2.5-flash"; 
        const synth = window.speechSynthesis;
        let speechQueue = [];
        let isSpeaking = false;
        let currentSentence = "";
        let bestVoice = null;
        let audioCtx = null;

        function playChime() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(1244.51, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1567.98, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.5);
        }

        function loadVoices() {
            const voices = synth.getVoices();
            bestVoice = voices.find(v => v.lang.includes('fr') && (v.name.includes('Siri') || v.name.includes('Premium') || v.name.includes('Google')))
                       || voices.find(v => v.lang.includes('fr'));
        }
        synth.onvoiceschanged = loadVoices;
        loadVoices();

        function reinitialiserCle() { localStorage.removeItem('BOITE_FINAL_KEY_2026'); location.reload(); }
        if (!API_KEY) {
            const k = prompt("Entre ta cl√© API Gemini :");
            if (k) { localStorage.setItem('BOITE_FINAL_KEY_2026', k); API_KEY = k; location.reload(); }
        }

        function toggleStopButton(active) {
            const container = document.getElementById('stop-container');
            if (active) {
                container.classList.remove('opacity-30', 'pointer-events-none');
                container.classList.add('opacity-100');
            } else {
                container.classList.add('opacity-30', 'pointer-events-none');
                container.classList.remove('opacity-100');
            }
        }

        function stopAudio() {
            synth.cancel(); speechQueue = []; isSpeaking = false; currentSentence = "";
            document.getElementById('story-card').classList.remove('speaking-glow');
            toggleStopButton(false);
        }

        async function appelIA(sujet) {
            if (!API_KEY) return;
            stopAudio();
            
            const btnMic = document.getElementById('btn-mic');
            const statusLabel = document.getElementById('status');

            playChime();
            btnMic.classList.add('understood-flash');
            statusLabel.innerText = "‚ú® Compris ! Je pr√©pare l'aventure...";
            
            setTimeout(() => {
                btnMic.classList.remove('understood-flash');
                document.getElementById('story-card').classList.remove('hidden');
                toggleStopButton(true); // Activer le bouton stop d√®s que la g√©n√©ration commence
            }, 800);

            document.getElementById('story-text').innerText = ""; 

            const url = `https://generativelanguage.googleapis.com/v1beta/${MODEL_ID}:streamGenerateContent?alt=sse&key=${API_KEY}`;
            const promptIA = `Raconte une aventure r√©aliste et concr√®te pour un enfant sur : "${sujet}". Pas de magie. STRUCTURE : D√©but, p√©rip√©ties, et fin positive. IMPORTANT : Termine par le mot "FIN". Uniquement texte pur.`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: promptIA }] }], generationConfig: { temperature: 0.7, maxOutputTokens: 3800 } })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let fullText = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        if (currentSentence.trim()) { speechQueue.push(currentSentence.trim()); parler(); }
                        break;
                    }
                    const chunk = decoder.decode(value);
                    const lines = chunk.split("\n");
                    for (const line of lines) {
                        if (line.startsWith("data: ")) {
                            try {
                                const json = JSON.parse(line.substring(6));
                                const chunkText = json.candidates[0].content.parts[0].text;
                                fullText += chunkText; currentSentence += chunkText;
                                document.getElementById('story-text').innerText = fullText;
                                document.getElementById('story-card').scrollTop = document.getElementById('story-card').scrollHeight;
                                if (/[.!?\n]/.test(chunkText)) {
                                    const parts = currentSentence.split(/([.!?\n])/);
                                    for (let i = 0; i < parts.length - 1; i += 2) {
                                        const p = (parts[i] + (parts[i+1] || "")).trim();
                                        if (p.length > 2) { speechQueue.push(p); parler(); }
                                    }
                                    currentSentence = parts[parts.length - 1];
                                }
                            } catch(e) {}
                        }
                    }
                }
            } catch (e) { statusLabel.innerText = "‚ùå Oups, petit souci..."; }
        }

        function parler() {
            if (isSpeaking || speechQueue.length === 0) return;
            isSpeaking = true;
            document.getElementById('story-card').classList.add('speaking-glow');
            toggleStopButton(true);
            let txt = speechQueue.shift().replace(/[#*`_]/g, '');
            const utter = new SpeechSynthesisUtterance(txt);
            if (!bestVoice) loadVoices();
            utter.voice = bestVoice; utter.lang = 'fr-FR'; utter.pitch = 1.05; utter.rate = 0.83; 
            utter.onend = () => { 
                isSpeaking = false; 
                document.getElementById('story-card').classList.remove('speaking-glow'); 
                if(speechQueue.length === 0) toggleStopButton(false);
                setTimeout(parler, 250); 
            };
            synth.speak(utter);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const kbArea = document.getElementById('keyboard-area');
            const toggleBtn = document.getElementById('toggle-input');

            toggleBtn.onclick = () => kbArea.classList.toggle('hidden');

            document.getElementById('btn-ok').onclick = () => {
                const val = document.getElementById('manualInput').value.trim();
                if(val) appelIA(val);
            };

            document.getElementById('btn-mic').onclick = () => {
                const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!Speech) return alert("Micro non support√©.");
                const rec = new Speech();
                rec.lang = 'fr-FR';
                const statusLabel = document.getElementById('status');

                rec.onstart = () => {
                    document.getElementById('btn-mic').classList.add('mic-listening');
                    statusLabel.innerText = "‚ú® Je t'√©coute...";
                };
                rec.onresult = (e) => {
                    const p = e.results[0][0].transcript;
                    document.getElementById('manualInput').value = p;
                    appelIA(p);
                };
                rec.onend = () => document.getElementById('btn-mic').classList.remove('mic-listening');
                rec.onerror = () => {
                    document.getElementById('btn-mic').classList.remove('mic-listening');
                    statusLabel.innerText = "‚ö†Ô∏è Je n'ai pas entendu.";
                };
                try { rec.start(); } catch (e) {}
            };

            document.getElementById('btn-stop').onclick = stopAudio;
        });
    </script>
</body>
</html>