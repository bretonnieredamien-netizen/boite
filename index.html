<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ta boite magique ‚ú®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;500;800;900&display=swap" rel="stylesheet">
    <style>
        /* --- VARIABLES --- */
        :root { --bg-1: #fff7ed; --bg-2: #fef9c3; --bg-3: #ede9fe; --bg-4: #fae8ff; --accent-color: #6366f1; --vis-1: #4f46e5; --vis-2: #9333ea; --vis-3: #db2777; }
        
        body { font-family: 'Lexend', sans-serif; background: linear-gradient(-45deg, var(--bg-1), var(--bg-2), var(--bg-3), var(--bg-4)); background-size: 400% 400%; animation: gradientBG 15s ease infinite; touch-action: none; overflow: hidden; min-height: 100vh; margin: 0; transition: background 2s ease; }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        #starfield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .hidden { display: none !important; }
        .content-layer { position: relative; z-index: 10; width: 100%; display: flex; flex-direction: column; align-items: center; opacity: 0; transition: opacity 1s ease-in; }
        .content-visible { opacity: 1 !important; }

        /* --- UI ELEMENTS --- */
        .nav-home-btn { position: absolute; top: 1.5rem; left: 1.5rem; z-index: 9999; width: 52px; height: 52px; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(15px); border: 2px solid rgba(255, 255, 255, 0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 8px 32px rgba(31, 38, 135, 0.2); transition: all 0.3s; }
        .nav-home-btn:hover { transform: scale(1.15) rotate(-10deg); }
        .nav-home-btn svg { width: 26px; height: 26px; fill: var(--accent-color); }

        #main-header { transition: opacity 1s ease, transform 1s ease; opacity: 1; transform: translateY(0); z-index: 50; }
        .cinema-mode { transform: translateY(-20px); }
        .logo-container { width: 180px; height: 180px; display: flex; justify-content: center; align-items: center; opacity: 0; animation: introFade 2s ease-out forwards; filter: drop-shadow(0 10px 25px rgba(129, 140, 248, 0.5)); }
        @keyframes introFade { 0% { opacity: 0; transform: translateY(15px); } 100% { opacity: 1; transform: translateY(0); } }

        /* --- LAYERS --- */
        #slate-layer, #coloring-layer, #fashion-layer, #game-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 150; background: #0f172a; display: none; }
        #coloring-layer { background: #ffffff; }
        #game-layer { background: #1e293b; touch-action: none; }
        
        #slate-canvas, #color-canvas, #game-canvas { width: 100%; height: 100%; touch-action: none; position: absolute; top:0; left:0; z-index: 5; }
        
        #generated-coloring-image { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; height: 100%; object-fit: contain; pointer-events: none; mix-blend-mode: multiply; z-index: 2; opacity: 1; }

        /* --- FASHION --- */
        #fashion-layer { background: #1e1e1e; }
        #fashion-workspace { position: absolute; top: 0; left: 0; width: 100%; height: 82%; display: flex; justify-content: center; align-items: center; overflow: hidden; pointer-events: none; }
        .fashion-stack-item { position: absolute; height: 85%; width: auto; max-width: 95%; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* --- JEUX UI --- */
        #game-selector-ui { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; flex-direction: column; gap: 20px; z-index: 20; width: 90%; max-width: 400px; }
        .game-btn { background: white; border-radius: 20px; padding: 20px; display: flex; align-items: center; gap: 20px; cursor: pointer; box-shadow: 0 10px 25px rgba(0,0,0,0.3); transition: transform 0.2s; }
        .game-btn:active { transform: scale(0.95); }
        .game-btn-icon { font-size: 3rem; }
        .game-btn-text { display: flex; flex-direction: column; text-align: left; }
        .game-btn-title { font-weight: 800; font-size: 1.2rem; color: #1e293b; }
        .game-btn-desc { font-size: 0.9rem; color: #64748b; }
        #game-score-overlay { position: absolute; top: 20px; right: 20px; z-index: 20; background: rgba(255,255,255,0.9); padding: 10px 20px; border-radius: 50px; font-weight: 900; color: #6366f1; font-size: 1.5rem; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.2); pointer-events: none; }

        /* --- CONTROLS BAR --- */
        .slate-controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 800px; display: flex; gap: 12px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); padding: 12px 20px; border-radius: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); border: 1px solid rgba(255, 255, 255, 0.2); align-items: center; z-index: 160; overflow-x: auto; justify-content: flex-start; flex-wrap: nowrap; -webkit-overflow-scrolling: touch; }
        #coloring-controls, #fashion-controls { background: rgba(255, 255, 255, 0.95); border: 1px solid #cbd5e1; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
        .slate-controls::-webkit-scrollbar { display: none; } 
        
        #fashion-controls { justify-content: flex-start; padding-right: 20px; height: 110px; background: #fff; border-top: 4px solid #6366f1; }
        #wardrobe-list { display: flex; gap: 10px; overflow-x: auto; align-items: center; flex-grow: 1; height: 100%; padding: 5px 0; scrollbar-width: none; -ms-overflow-style: none; }
        #wardrobe-list::-webkit-scrollbar { display: none; }
        .wardrobe-item { flex-shrink: 0; width: 75px; height: 75px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
        .wardrobe-item.selected { border-color: #6366f1; background: #e0e7ff; box-shadow: 0 0 0 2px #6366f1; }
        .wardrobe-icon-img { width: 90%; height: 90%; object-fit: contain; pointer-events: none; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2)); }

        .brush-btn { flex-shrink: 0; width: 48px; height: 48px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; transition: 0.2s; background: rgba(255,255,255,0.1); color: white; }
        #coloring-controls .brush-btn { background: #f1f5f9; color: #334155; border: 1px solid #e2e8f0; }
        .brush-btn.active { border-color: #6366f1; transform: scale(1.1); background: white; color: #1e293b; box-shadow: 0 0 15px rgba(99,102,241,0.5); }
        .color-picker { flex-shrink: 0; width: 32px; height: 32px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.5); cursor: pointer; transition: 0.2s; }
        #coloring-controls .color-picker { border: 2px solid #cbd5e1; }
        .color-picker.active { transform: scale(1.3); border-color: white; box-shadow: 0 0 10px white; }
        #coloring-controls .color-picker.active { border-color: #6366f1; box-shadow: 0 0 10px #6366f1; }
        .slate-action { flex-shrink: 0; padding: 0.6rem 1.2rem; border-radius: 12px; font-weight: 800; font-size: 0.75rem; color: white; text-transform: uppercase; letter-spacing: 0.05em; background: rgba(255,255,255,0.1); white-space: nowrap; }
        #coloring-controls .slate-action, #fashion-controls .slate-action { background: #fee2e2; color: #ef4444; }

        /* --- HOME --- */
        .status-box { background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); padding: 0.6rem 1.8rem; border-radius: 9999px; border: 1px solid rgba(255, 255, 255, 0.5); margin-top: 1rem; min-height: 44px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .understood-flash { animation: success-pulse 0.8s ease-out !important; background: rgba(16, 185, 129, 0.2) !important; border-color: #10b981 !important; }
        @keyframes success-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); box-shadow: 0 0 60px #10b981; } 100% { transform: scale(1); } }
        
        #intro-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: transparent; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s ease-out, visibility 0.8s; }
        .mode-selector { display: flex; gap: 1.5rem; align-items: center; justify-content: center; width: 100%; flex-wrap: wrap; padding: 0 20px; max-width: 900px; }
        .mode-card { display: flex; flex-direction: column; align-items: center; gap: 0.8rem; cursor: pointer; transition: transform 0.3s ease; margin-bottom: 1rem; }
        .mode-card:hover { transform: scale(1.1); }
        .mode-icon-box { width: 90px; height: 90px; border-radius: 20px; background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(20px); border: 2px solid rgba(255, 255, 255, 0.6); display: flex; align-items: center; justify-content: center; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .mode-label { font-weight: 800; color: rgba(79, 70, 229, 0.6); text-transform: uppercase; letter-spacing: 0.1em; font-size: 0.7rem; }
        .god-rays { position: absolute; width: 180%; height: 180%; background: conic-gradient(from 0deg, transparent 0deg, rgba(251, 191, 36, 0.2) 20deg, transparent 40deg, rgba(139, 92, 246, 0.2) 60deg, transparent 80deg); border-radius: 50%; z-index: -1; opacity: 1; animation: spinRays 20s linear infinite; top: 50%; left: 50%; transform: translate(-50%, -50%); mix-blend-mode: overlay; pointer-events: none; }
        @keyframes spinRays { 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        .intro-fade-out { opacity: 0; pointer-events: none; }
        .white-flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 90; opacity: 0; pointer-events: none; }
        .flash-active { animation: flashAnim 1.5s ease-out forwards; }
        @keyframes flashAnim { 0% { opacity: 0; } 15% { opacity: 0.95; } 100% { opacity: 0; } }

        #spotify-container { width: 100%; max-width: 400px; height: 0; overflow: hidden; transition: height 0.5s ease; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #spotify-container.active { height: 152px; margin-top: 20px; }
        iframe { border-radius: 12px; }
    </style>
</head>
<body class="p-6">

    <canvas id="starfield"></canvas>

    <div id="slate-layer">
        <button class="nav-home-btn" onclick="returnToMenu()"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></button>
        <canvas id="slate-canvas"></canvas>
        <div class="slate-controls">
            <div id="base-colors" class="flex gap-3 mr-2 border-r border-white/20 pr-4 flex-shrink-0">
                <div class="color-picker active" style="background:white" onclick="setBaseColor('white', this)"></div>
                <div class="color-picker" style="background:#ef4444" onclick="setBaseColor('#ef4444', this)"></div>
                <div class="color-picker" style="background:#3b82f6" onclick="setBaseColor('#3b82f6', this)"></div>
                <div class="color-picker" style="background:#22c55e" onclick="setBaseColor('#22c55e', this)"></div>
            </div>
            <button class="brush-btn active" onclick="setBrush('base', this)">‚úèÔ∏è</button>
            <button class="brush-btn" onclick="setBrush('neon', this)">üí°</button>
            <button class="brush-btn" onclick="setBrush('rainbow', this)">üåà</button>
            <button class="brush-btn" onclick="setBrush('fire', this)">üî•</button>
            <button class="brush-btn" onclick="setBrush('ice', this)">‚ùÑÔ∏è</button>
            <button class="brush-btn" onclick="setBrush('electric', this)">‚ö°</button>
            <button class="brush-btn" onclick="setBrush('galaxy', this)">üåå</button>
            <button class="brush-btn" onclick="setBrush('gold', this)">‚ú®</button>
            <div class="w-px h-8 bg-white/20 mx-2 flex-shrink-0"></div>
            <button class="brush-btn" onclick="setBrush('eraser', this)">üßΩ</button>
            <button onclick="clearSlate()" class="slate-action">Effacer</button>
        </div>
    </div>

    <div id="coloring-layer">
        <button class="nav-home-btn" onclick="returnToMenu()"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></button>
        <img id="generated-coloring-image" src="" alt="" style="display:none;">
        <canvas id="color-canvas"></canvas>
        <div id="coloring-controls" class="slate-controls">
            <div class="flex gap-3 mr-4 flex-shrink-0">
                <div class="color-picker active" style="background:#ef4444" onclick="setColoringColor('#ef4444', this)"></div>
                <div class="color-picker" style="background:#f97316" onclick="setColoringColor('#f97316', this)"></div>
                <div class="color-picker" style="background:#eab308" onclick="setColoringColor('#eab308', this)"></div>
                <div class="color-picker" style="background:#22c55e" onclick="setColoringColor('#22c55e', this)"></div>
                <div class="color-picker" style="background:#3b82f6" onclick="setColoringColor('#3b82f6', this)"></div>
                <div class="color-picker" style="background:#a855f7" onclick="setColoringColor('#a855f7', this)"></div>
                <div class="color-picker" style="background:#ec4899" onclick="setColoringColor('#ec4899', this)"></div>
                <div class="color-picker" style="background:#78350f" onclick="setColoringColor('#78350f', this)"></div>
                <div class="color-picker" style="background:#000000" onclick="setColoringColor('#000000', this)"></div>
            </div>
            <button class="brush-btn active" onclick="setColoringBrush('marker', this)" title="Feutre">üñçÔ∏è</button>
            <button class="brush-btn" onclick="setColoringBrush('crayon', this)" title="Crayon">‚úèÔ∏è</button>
            <div class="w-px h-8 bg-gray-300 mx-2 flex-shrink-0"></div>
            <button class="brush-btn" onclick="setColoringBrush('eraser', this)">üßΩ</button>
            <button onclick="clearColoring()" class="slate-action">Nouveau</button>
        </div>
    </div>

    <div id="fashion-layer">
        <button class="nav-home-btn" onclick="returnToMenu()"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></button>
        <div id="fashion-workspace">
            <img id="fashion-mannequin-base" class="fashion-stack-item" src="" alt="Mod√®le">
            <img id="fashion-wear-bottom" class="fashion-stack-item" style="opacity:0">
            <img id="fashion-wear-top" class="fashion-stack-item" style="opacity:0">
            <img id="fashion-wear-full" class="fashion-stack-item" style="opacity:0">
            <img id="fashion-wear-shoes" class="fashion-stack-item" style="opacity:0">
            <img id="fashion-wear-hat" class="fashion-stack-item" style="opacity:0">
        </div>
        <div id="fashion-controls" class="slate-controls">
            <button onclick="changerMannequin()" class="brush-btn active mr-3" style="background:white; color:#0891b2; width:55px; height:55px;" title="Changer de mod√®le"><svg viewBox="0 0 24 24" width="30" height="30"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z" fill="#0891b2"/></svg></button>
            <div class="w-px h-10 bg-gray-300 mx-1 flex-shrink-0"></div>
            <div id="wardrobe-list"></div>
            <div class="w-px h-10 bg-gray-300 mx-2 flex-shrink-0"></div>
            <button onclick="resetOutfit()" class="brush-btn" style="color:#ef4444; width:55px; height:55px;" title="Tout enlever"><svg viewBox="0 0 24 24" width="30" height="30"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="#ef4444"/></svg></button>
        </div>
    </div>

    <div id="game-layer">
        <button class="nav-home-btn" onclick="returnToMenu()"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></button>
        <div id="game-score-overlay">SCORE: <span id="score-val">0</span></div>
        <canvas id="game-canvas"></canvas>
        <div id="game-selector-ui">
            <div class="game-btn" onclick="launchGame('FOOTBALL')">
                <div class="game-btn-icon">‚öΩ</div>
                <div class="game-btn-text">
                    <span class="game-btn-title">Super Buteur</span>
                    <span class="game-btn-desc">Marque des buts !</span>
                </div>
            </div>
            <div class="game-btn" onclick="launchGame('MARBLES')">
                <div class="game-btn-icon">‚ö™</div>
                <div class="game-btn-text">
                    <span class="game-btn-title">Choc des Billes</span>
                    <span class="game-btn-desc">√âjecte les rouges !</span>
                </div>
            </div>
        </div>
    </div>

    <div id="intro-overlay">
        <div class="god-rays"></div>
        <p id="intro-title" class="text-indigo-900/50 text-xl font-black mb-10 uppercase tracking-widest text-center">Choisis ta magie</p>
        <div class="mode-selector">
            <div class="mode-card" onclick="selectMode('STORY')">
                <div class="mode-icon-box"><svg width="40" height="40" viewBox="0 0 24 24" fill="#6366f1"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg></div>
                <span class="mode-label">Histoires</span>
            </div>
            <div class="mode-card" onclick="selectMode('QUESTION')">
                <div class="mode-icon-box"><svg width="40" height="40" viewBox="0 0 24 24" fill="#ec4899"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg></div>
                <span class="mode-label">Questions</span>
            </div>
            <div class="mode-card" onclick="selectMode('CHAT')">
                <div class="mode-icon-box"><svg width="40" height="40" viewBox="0 0 24 24" fill="#f59e0b"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg></div>
                <span class="mode-label">Discussion</span>
            </div>
            <div class="mode-card" onclick="selectMode('DRAW')">
                <div class="mode-icon-box"><svg width="40" height="40" viewBox="0 0 24 24" fill="#10b981"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8z"/></svg></div>
                <span class="mode-label">Dessin</span>
            </div>
            <div class="mode-card" onclick="selectMode('COLORING')">
                <div class="mode-icon-box"><svg width="40" height="40" viewBox="0 0 24 24" fill="#8b5cf6"><path d="M17.75 7L14 3.25l-10 10V17h3.75l10-10zm2.96-2.96c.39-.39.39-1.02 0-1.41L18.37.29c-.39-.39-1.02-.39-1.41 0L15.5 1.75l2.75 2.75 1.46-1.46z"/></svg></div>
                <span class="mode-label">Coloriage</span>
            </div>
            <div class="mode-card" onclick="selectMode('MUSIC')">
                <div class="mode-icon-box"><svg width="40" height="40" viewBox="0 0 24 24" fill="#06b6d4"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg></div>
                <span class="mode-label">Musique</span>
            </div>
            <div class="mode-card" onclick="selectMode('FASHION')">
                <div class="mode-icon-box"><svg width="40" height="40" viewBox="0 0 24 24" fill="#fb7185"><path d="M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-2 10H5V8h14v8zM6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM12 2C9.24 2 7 4.24 7 7h10c0-2.76-2.24-5-5-5z"/></svg></div>
                <span class="mode-label">Mode</span>
            </div>
            <div class="mode-card" onclick="selectMode('GAME')">
                <div class="mode-icon-box"><svg width="40" height="40" viewBox="0 0 24 24" fill="#f97316"><path d="M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-10 7H8v3H6v-3H3v-2h3V8h2v3h3v2zm4.5 2c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4-3c-.83 0-1.5-.67-1.5-1.5S18.67 9 19.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg></div>
                <span class="mode-label">Jeux</span>
            </div>
        </div>
        <button onclick="oublierTout()" class="mt-8 text-indigo-900/40 text-xs font-bold uppercase tracking-widest hover:text-indigo-600 transition-colors">Red√©finir mon profil</button>
    </div>

    <div id="white-flash" class="white-flash"></div>

    <div id="main-interface" class="content-layer min-h-screen">
        <button class="nav-home-btn" onclick="returnToMenu()"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></button>

        <header id="main-header" class="text-center flex flex-col items-center mt-6">
            <div class="logo-container">
                <svg id="main-logo-story" class="hidden" viewBox="0 0 24 24" fill="#6366f1" width="100" height="100"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
                <svg id="main-logo-question" class="hidden" viewBox="0 0 24 24" fill="#ec4899" width="100" height="100"><path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/></svg>
                <svg id="main-logo-chat" class="hidden" viewBox="0 0 24 24" fill="#f59e0b" width="100" height="100"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                <svg id="main-logo-coloring" class="hidden" viewBox="0 0 24 24" fill="#8b5cf6" width="100" height="100"><path d="M17.75 7L14 3.25l-10 10V17h3.75l10-10zm2.96-2.96c.39-.39.39-1.02 0-1.41L18.37.29c-.39-.39-1.02-.39-1.41 0L15.5 1.75l2.75 2.75 1.46-1.46z"/></svg>
                <svg id="main-logo-music" class="hidden" viewBox="0 0 24 24" fill="#06b6d4" width="100" height="100"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                <svg id="main-logo-fashion" class="hidden" viewBox="0 0 24 24" fill="#fb7185" width="100" height="100"><path d="M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-2 10H5V8h14v8zM6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM12 2C9.24 2 7 4.24 7 7h10c0-2.76-2.24-5-5-5z"/></svg>
                <svg id="main-logo-game" class="hidden" viewBox="0 0 24 24" fill="#f97316" width="100" height="100"><path d="M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-10 7H8v3H6v-3H3v-2h3V8h2v3h3v2zm4.5 2c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4-3c-.83 0-1.5-.67-1.5-1.5S18.67 9 19.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
            </div>
            <div class="status-box">
                <p id="status" class="text-indigo-900/60 font-semibold italic text-sm">Pr√™t...</p>
                <div id="ai-thinking" class="hidden thinking-waves">
                    <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                </div>
            </div>
        </header>

        <main class="w-full max-w-md flex flex-col items-center gap-14 mt-8">
            <div class="flex items-center justify-center gap-12 w-full">
                <button id="btn-mic" class="orbe-base shadow-2xl">
                    <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                </button>
                <div id="stop-container" class="opacity-20 pointer-events-none transition-all duration-500">
                    <button id="btn-stop" class="orbe-base shadow-xl"><svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="2" /></svg></button>
                </div>
            </div>
            <div id="story-card" class="hidden transition-all duration-500"><canvas id="visualizer-canvas"></canvas></div>
            <div id="spotify-container" class=""><iframe id="spotify-frame" style="border-radius:12px" src="" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe></div>
            <input type="text" id="manualInput" class="hidden">
        </main>
    </div>

    <script>
        let GEMINI_KEY = localStorage.getItem('BOITE_GEMINI_KEY');
        let AZURE_KEY = localStorage.getItem('BOITE_AZURE_KEY');
        let AZURE_REGION = localStorage.getItem('BOITE_AZURE_REGION');
        let userPrenom = localStorage.getItem('BOITE_PRENOM');
        let userAge = localStorage.getItem('BOITE_AGE');
        let userGenre = localStorage.getItem('BOITE_GENRE'); 
        let userColor = localStorage.getItem('BOITE_COLOR'); 
        
        let currentAppMode = null; 
        let interactionMode = 'INIT'; 
        let chatHistory = []; 

        const MODEL_ID = "models/gemini-2.5-flash"; 
        const AZURE_VOICE_NAME = "fr-FR-VivienneMultilingualNeural"; 

        /* --- SPOTIFY --- */
        const SPOTIFY_DB = {
            'POP': '37i9dQZF1DXcBWIGoYBM5M', 'DISNEY': '37i9dQZF1DX8C9xQcOrE6T', 'FILM': '37i9dQZF1DX8C9xQcOrE6T', 'VOITURE': '37i9dQZF1DWWHQM6sW8kDQ',
            'GUITARE': '37i9dQZF1DWZK4p8GZlQhW', 'GUITARE_ELEC': '37i9dQZF1DWWzBc3TOlaAV', 'PIANO': '37i9dQZF1DWUvHZA1zLcjW', 'VIOLON': '37i9dQZF1DWV7EzJMK2FUI', 'BATTERIE': '37i9dQZF1DWXJKyK5MgDWz', 'TROMPETTE': '37i9dQZF1DX6f3J34J8j5p',
            'ROCK': '37i9dQZF1DWWzBc3TOlaAV', 'METAL': '37i9dQZF1DX9qNs32fujYe', 'RAP': '37i9dQZF1DX0XUsuxWHRQd', 'JAZZ': '37i9dQZF1DXbITWG1ZJKYt', 'CLASSIQUE': '37i9dQZF1DWUvHZA1zLcjW', 'COUNTRY': '37i9dQZF1DX1lVhptIYRda', 'DISCO': '37i9dQZF1DX4UtSsGT1Sbe',
            'DODO': '37i9dQZF1DWZd79rJ6a7lp', 'CALME': '37i9dQZF1DWZd79rJ6a7lp', 'FETE': '37i9dQZF1DX2sUQqwWQbJn', 'DANSE': '37i9dQZF1DX2sUQqwWQbJn', 'TRISTE': '37i9dQZF1DX3YSRoSdA634', 'HEUREUX': '37i9dQZF1DXdPec7aLTmlC', 'SPORT': '37i9dQZF1DX76Wlfdnj7AP',
            'DINOSAURE': '37i9dQZF1DWWHQX5fP7a70', 'SUPERHEROS': '37i9dQZF1DXu2W0Mf8a55a', 'JEUXVIDEO': '37i9dQZF1DXdfOcg1fm0VG', 'HALLOWEEN': '37i9dQZF1EIdR77n0lqY6P', 'NOEL': '37i9dQZF1DX0A8zVl7p82B',
            'PLUIE': '37i9dQZF1DX8gym7ONOGCa', 'OCEAN': '37i9dQZF1DX4PP3kddpbma', 'FORET': '37i9dQZF1DWX83CujKHHbD', 'ANIMAUX': '37i9dQZF1DWWHQX5fP7a70', 'JUNGLE': '37i9dQZF1DWWHQX5fP7a70'
        };

        /* --- FASHION DATA (STYLE FERFLEX) --- */
        const AVATAR_BOY_OUTLINE = `<svg viewBox="0 0 400 800" xmlns="http://www.w3.org/2000/svg"><g stroke="white" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M150,120 L150,110 M150,110 C165,110 180,95 180,70 C180,45 165,25 150,25 C135,25 120,45 120,70 C120,95 135,110 150,110 Z"/><path d="M138,65 L142,65 M158,65 L162,65 M150,75 L150,80 M145,90 Q150,95 155,90" stroke-width="2"/><path d="M150,25 C140,25 120,35 115,55 C115,35 130,15 150,15 C170,15 185,35 185,55 C180,35 160,25 150,25 Z"/><path d="M130,115 L115,130 L110,250 L100,260 L105,270 L115,260 L115,250 M170,115 L185,130 L190,250 L200,260 L195,270 L185,260 L185,250"/><path d="M130,115 L130,250 L115,400 L125,580 L150,570 L175,580 L185,400 L170,250 L170,115"/><path d="M115,250 L185,250 L185,280 L115,280 Z"/></g></svg>`;
        const AVATAR_GIRL_OUTLINE = `<svg viewBox="0 0 400 800" xmlns="http://www.w3.org/2000/svg"><g stroke="white" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M150,110 C165,110 180,95 180,70 C180,45 165,30 150,30 C135,30 120,45 120,70 C120,95 135,110 150,110 Z"/><path d="M138,65 L142,65 M158,65 L162,65 M150,75 L150,80 M145,90 Q150,95 155,90" stroke-width="2"/><path d="M150,30 C130,30 110,55 110,95 L110,140 C110,150 130,150 130,140 L130,90 C130,60 170,60 170,90 L170,140 C170,150 190,150 190,140 L190,95 C190,55 170,30 150,30 Z" /><path d="M130,115 L115,130 L110,250 L100,260 L105,270 L115,260 L115,250 M170,115 L185,130 L190,250 L200,260 L195,270 L185,260 L185,250"/><path d="M130,115 L135,250 L120,400 L130,580 L150,570 L170,580 L180,400 L165,250 L170,115"/><path d="M115,250 L185,250 L180,280 L120,280 Z"/><path d="M130,120 L170,120 L170,150 L130,150 Z"/></g></svg>`;
        const MANNEQUINS = [AVATAR_BOY_OUTLINE, AVATAR_GIRL_OUTLINE];
        let currentMannequinIndex = 0;

        function createClothes() {
            const items = [];
            const palette = ['#ef4444', '#3b82f6', '#f59e0b', '#10b981', '#ec4899', '#8b5cf6'];
            palette.forEach((c, i) => {
                items.push({ type: 'top', svg: `<svg viewBox="0 0 400 800" xmlns="http://www.w3.org/2000/svg"><path d="M115,130 L185,130 L200,160 L180,160 L180,250 L120,250 L120,160 L100,160 Z" fill="${c}" stroke="none"/></svg>` });
                if(i%2===0) items.push({ type: 'top', svg: `<svg viewBox="0 0 400 800" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="stripes${i}" width="10" height="10" patternTransform="rotate(45)" patternUnits="userSpaceOnUse"><rect width="5" height="10" fill="white" fill-opacity="0.3"/></pattern></defs><path d="M115,130 L185,130 L200,160 L180,160 L180,250 L120,250 L120,160 L100,160 Z" fill="${c}" stroke="none"/><path d="M115,130 L185,130 L200,160 L180,160 L180,250 L120,250 L120,160 L100,160 Z" fill="url(#stripes${i})" stroke="none"/></svg>` });
            });
            ['#ec4899', '#8b5cf6', '#ef4444'].forEach(c => { items.push({ type: 'full', svg: `<svg viewBox="0 0 400 800" xmlns="http://www.w3.org/2000/svg"><path d="M130,130 L170,130 L180,250 L210,400 L90,400 L120,250 Z" fill="${c}" stroke="none"/></svg>` }); });
            ['#1e3a8a', '#334155', '#b45309'].forEach(c => { items.push({ type: 'bottom', svg: `<svg viewBox="0 0 400 800" xmlns="http://www.w3.org/2000/svg"><path d="M115,240 L185,240 L195,570 L160,570 L150,350 L140,570 L105,570 Z" fill="${c}" stroke="none"/></svg>` }); });
            ['#f472b6', '#a78bfa'].forEach(c => { items.push({ type: 'bottom', svg: `<svg viewBox="0 0 400 800" xmlns="http://www.w3.org/2000/svg"><path d="M120,240 L180,240 L200,350 L100,350 Z" fill="${c}" stroke="none"/></svg>` }); });
            items.push({ type: 'shoes', svg: `<svg viewBox="0 0 400 800" xmlns="http://www.w3.org/2000/svg"><path d="M125,580 Q120,600 140,600 Q160,600 160,580 Z" fill="white"/><path d="M175,580 Q180,600 160,600 Q140,600 140,580 Z" fill="white" transform="translate(50,0)"/></svg>` });
            items.push({ type: 'shoes', svg: `<svg viewBox="0 0 400 800" xmlns="http://www.w3.org/2000/svg"><path d="M125,580 Q120,600 140,600 Q160,600 160,580 Z" fill="#333"/><path d="M175,580 Q180,600 160,600 Q140,600 140,580 Z" fill="#333" transform="translate(50,0)"/></svg>` });
            return items;
        }
        const WARDROBE_ITEMS = createClothes();

        /* --- ARDOISE NOIRE --- */
        const sCanvas = document.getElementById('slate-canvas'); const sCtx = sCanvas.getContext('2d');
        let drawing = false, currentBrush = 'base', hue = 0, baseColor = 'white'; let lastX = 0, lastY = 0; 
        function initSlate() { sCanvas.width = window.innerWidth; sCanvas.height = window.innerHeight; sCtx.lineCap = 'round'; sCtx.lineJoin = 'round'; }
        function setBrush(b, btn) { currentBrush = b; document.querySelectorAll('.brush-btn').forEach(el => el.classList.remove('active')); btn.classList.add('active'); }
        function setBaseColor(c, btn) { baseColor = c; currentBrush = 'base'; document.querySelectorAll('.color-picker').forEach(el => el.classList.remove('active')); btn.classList.add('active'); document.querySelectorAll('.brush-btn').forEach(el => el.classList.remove('active')); document.querySelector('.brush-btn[onclick*="base"]').classList.add('active'); }
        function draw(e) { if (!drawing) return; const x = e.clientX || e.touches[0].clientX; const y = e.clientY || e.touches[0].clientY; hue = (hue + 2) % 360; sCtx.lineWidth = currentBrush === 'galaxy' ? 1.5 : (currentBrush === 'neon' ? 3 : (currentBrush === 'eraser' ? 20 : 2.5)); sCtx.globalCompositeOperation = 'source-over'; 
            if (currentBrush === 'base') { sCtx.strokeStyle = baseColor; sCtx.shadowBlur = 0; } else if (currentBrush === 'eraser') { sCtx.globalCompositeOperation = 'destination-out'; sCtx.strokeStyle = 'rgba(0,0,0,1)'; sCtx.shadowBlur = 0; } else if (currentBrush === 'neon') { sCtx.strokeStyle = `hsl(${hue}, 100%, 70%)`; sCtx.shadowBlur = 15; sCtx.shadowColor = sCtx.strokeStyle; } else if (currentBrush === 'rainbow') { sCtx.strokeStyle = `hsl(${hue}, 100%, 50%)`; sCtx.shadowBlur = 0; } else if (currentBrush === 'fire') { const grad = sCtx.createLinearGradient(lastX, lastY, x, y); grad.addColorStop(0, '#ff9a00'); grad.addColorStop(1, '#ff0000'); sCtx.strokeStyle = grad; sCtx.lineWidth = 4; sCtx.shadowBlur = 20; sCtx.shadowColor = '#ff4500'; if (Math.random() > 0.5) { for(let i=0; i<2; i++) { const pX = x + (Math.random()-0.5) * 20; const pY = y - Math.random() * 30; sCtx.fillStyle = `rgba(255, ${Math.floor(Math.random()*150)}, 0, ${Math.random() * 0.8})`; sCtx.beginPath(); sCtx.arc(pX, pY, Math.random()*2.5, 0, Math.PI*2); sCtx.fill(); } } } else if (currentBrush === 'ice') { sCtx.strokeStyle = `rgba(224, 242, 254, 0.9)`; sCtx.shadowBlur = 10; sCtx.shadowColor = '#0ea5e9'; for(let i=0; i<2; i++) { const pX = x + (Math.random()-0.5) * 15; const pY = y + Math.random() * 25; sCtx.fillStyle = `rgba(255, 255, 255, 0.8)`; sCtx.beginPath(); sCtx.arc(pX, pY, Math.random()*1.5, 0, Math.PI*2); sCtx.fill(); } } else if (currentBrush === 'electric') { sCtx.strokeStyle = '#fef08a'; sCtx.shadowBlur = 20; sCtx.shadowColor = '#facc15'; const jitterX = x + (Math.random()-0.5) * 10; const jitterY = y + (Math.random()-0.5) * 10; sCtx.lineTo(jitterX, jitterY); } else if (currentBrush === 'galaxy') { sCtx.strokeStyle = 'rgba(255,255,255,0.8)'; sCtx.shadowBlur = 8; sCtx.shadowColor = `hsl(${hue}, 100%, 80%)`; for(let i=0; i<3; i++) { sCtx.beginPath(); sCtx.arc(x + (Math.random()-0.5)*20, y + (Math.random()-0.5)*20, Math.random()*1.5, 0, Math.PI*2); sCtx.fillStyle = 'white'; sCtx.fill(); } } else if (currentBrush === 'gold') { sCtx.strokeStyle = '#fbbf24'; sCtx.shadowBlur = 20; sCtx.shadowColor = '#f59e0b'; if(Math.random() > 0.8) { const pX = x + (Math.random()-0.5) * 20; const pY = y + (Math.random()-0.5) * 20; sCtx.fillStyle = '#fffbeb'; sCtx.beginPath(); sCtx.arc(pX, pY, Math.random()*2, 0, Math.PI*2); sCtx.fill(); } }
            if (currentBrush !== 'electric') sCtx.lineTo(x, y); sCtx.stroke(); sCtx.beginPath(); sCtx.moveTo(x, y); lastX = x; lastY = y;
        }
        sCanvas.addEventListener('mousedown', (e) => { drawing = true; lastX = e.clientX; lastY = e.clientY; sCtx.beginPath(); sCtx.moveTo(e.clientX, e.clientY); }); sCanvas.addEventListener('mousemove', draw); window.addEventListener('mouseup', () => drawing = false); sCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); drawing = true; lastX = e.touches[0].clientX; lastY = e.touches[0].clientY; sCtx.beginPath(); sCtx.moveTo(e.touches[0].clientX, e.touches[0].clientY); }); sCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); }); window.addEventListener('touchend', () => drawing = false);
        function clearSlate() { sCtx.clearRect(0,0,sCanvas.width, sCanvas.height); }

        /* --- COLORIAGE --- */
        const cCanvas = document.getElementById('color-canvas'); const cCtx = cCanvas.getContext('2d');
        let coloring = false, cColor = '#ef4444', cBrush = 'marker';
        function initColoring() { cCanvas.width = window.innerWidth; cCanvas.height = window.innerHeight; cCtx.lineCap = 'round'; cCtx.lineJoin = 'round'; }
        function setColoringColor(c, btn) { cColor = c; cBrush = 'marker'; document.querySelectorAll('#coloring-controls .color-picker').forEach(el => el.classList.remove('active')); btn.classList.add('active'); document.querySelectorAll('#coloring-controls .brush-btn').forEach(el => el.classList.remove('active')); document.querySelector('#coloring-controls .brush-btn[onclick*="marker"]').classList.add('active'); }
        function setColoringBrush(b, btn) { cBrush = b; document.querySelectorAll('#coloring-controls .brush-btn').forEach(el => el.classList.remove('active')); btn.classList.add('active'); }
        function drawColor(e) { if (!coloring) return; const x = e.clientX || e.touches[0].clientX; const y = e.clientY || e.touches[0].clientY; cCtx.strokeStyle = cColor; cCtx.globalCompositeOperation = 'source-over'; if (cBrush === 'marker') { cCtx.lineWidth = 15; cCtx.globalAlpha = 0.5; } else if (cBrush === 'crayon') { cCtx.lineWidth = 5; cCtx.globalAlpha = 1; } else if (cBrush === 'eraser') { cCtx.globalCompositeOperation = 'destination-out'; cCtx.lineWidth = 30; cCtx.globalAlpha = 1; } cCtx.lineTo(x, y); cCtx.stroke(); cCtx.beginPath(); cCtx.moveTo(x, y); }
        cCanvas.addEventListener('mousedown', (e) => { coloring = true; cCtx.beginPath(); cCtx.moveTo(e.clientX, e.clientY); }); cCanvas.addEventListener('mousemove', drawColor); window.addEventListener('mouseup', () => coloring = false); cCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); coloring = true; cCtx.beginPath(); cCtx.moveTo(e.touches[0].clientX, e.touches[0].clientY); }); cCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); drawColor(e); }); window.addEventListener('touchend', () => coloring = false);
        function clearColoring() { cCtx.clearRect(0,0,cCanvas.width, cCanvas.height); document.getElementById('generated-coloring-image').style.display = 'none'; document.getElementById('coloring-layer').style.display = 'none'; document.getElementById('main-interface').classList.add('content-visible'); interactionMode = 'COLORING_INPUT'; document.getElementById('status').innerText = "Une autre id√©e ?"; speechQueue.push("D'accord, on change ! Que veux-tu colorier maintenant ?"); parler(); }
        async function genererColoriage(sujet) { const encoded = encodeURIComponent(`coloring page for kids, simple line art, black and white, white background, high contrast, ${sujet}`); const url = `https://image.pollinations.ai/prompt/${encoded}?width=1024&height=1024&nologo=true&seed=${Math.floor(Math.random()*9999)}`; const img = document.getElementById('generated-coloring-image'); img.onload = () => { document.getElementById('ai-thinking').classList.add('hidden'); document.getElementById('status').innerText = "√Ä tes crayons !"; img.style.display = 'block'; speechQueue.push("Et voil√† ton coloriage ! Tu peux dessiner dessus maintenant."); parler(); }; img.src = url; }

        /* --- FASHION --- */
        function initFashion() { document.getElementById('fashion-mannequin-base').src = "data:image/svg+xml;base64," + btoa(MANNEQUINS[currentMannequinIndex]); const wardrobe = document.getElementById('wardrobe-list'); wardrobe.innerHTML = ''; WARDROBE_ITEMS.forEach(item => { const div = document.createElement('div'); div.className = 'wardrobe-item'; const imgBase64 = "data:image/svg+xml;base64," + btoa(item.svg); div.innerHTML = `<img src="${imgBase64}" class="wardrobe-icon-img">`; div.onclick = () => { playPopSound(); document.querySelectorAll('.wardrobe-item').forEach(el => el.classList.remove('selected')); div.classList.add('selected'); wearItem(item); }; wardrobe.appendChild(div); }); }
        function changerMannequin() { currentMannequinIndex = (currentMannequinIndex + 1) % MANNEQUINS.length; document.getElementById('fashion-mannequin-base').src = "data:image/svg+xml;base64," + btoa(MANNEQUINS[currentMannequinIndex]); }
        function wearItem(item) { let targetId = ''; if (item.type === 'top') targetId = 'fashion-wear-top'; else if (item.type === 'bottom') targetId = 'fashion-wear-bottom'; else if (item.type === 'full') { targetId = 'fashion-wear-full'; } else if (item.type === 'shoes') targetId = 'fashion-wear-shoes'; else if (item.type === 'hat') targetId = 'fashion-wear-hat'; const imgEl = document.getElementById(targetId); if (item.type === 'full') { document.getElementById('fashion-wear-top').style.opacity = 0; document.getElementById('fashion-wear-bottom').style.opacity = 0; imgEl.src = "data:image/svg+xml;base64," + btoa(item.svg); imgEl.style.opacity = 1; } else if (item.type === 'top' || item.type === 'bottom') { document.getElementById('fashion-wear-full').style.opacity = 0; imgEl.src = "data:image/svg+xml;base64," + btoa(item.svg); imgEl.style.opacity = 1; } else { imgEl.src = "data:image/svg+xml;base64," + btoa(item.svg); imgEl.style.opacity = 1; } }
        function resetOutfit() { ['fashion-wear-top', 'fashion-wear-bottom', 'fashion-wear-full', 'fashion-wear-shoes', 'fashion-wear-hat'].forEach(id => { document.getElementById(id).style.opacity = 0; }); document.querySelectorAll('.wardrobe-item').forEach(el => el.classList.remove('selected')); speechQueue.push("Tout propre ! On recommence."); parler(); }

        /* --- GAME ENGINE (CORRIG√â & ROBUSTE) --- */
        const gCanvas = document.getElementById('game-canvas'); const gCtx = gCanvas.getContext('2d');
        let gameLoopId = null;
        let gameScore = 0;
        let gameActive = false; // Flag de s√©curit√©

        // Audio Context Global
        let globalAudioCtx = null;
        function getAudioContext() {
            if (!globalAudioCtx) {
                globalAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (globalAudioCtx.state === 'suspended') {
                globalAudioCtx.resume();
            }
            return globalAudioCtx;
        }

        // Sons s√©curis√©s
        function playPopSound() {
            try {
                const ctx = getAudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.frequency.setValueAtTime(400, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(800, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                osc.connect(gain); gain.connect(ctx.destination);
                osc.start(); osc.stop(ctx.currentTime + 0.1);
            } catch(e) {}
        }

        class GameEngine {
            constructor() { 
                this.touchStart = {x:0, y:0}; 
                this.touchEnd = {x:0, y:0};
                this.type = '';
            }
            
            start(gameType) {
                if(gameLoopId) cancelAnimationFrame(gameLoopId);
                
                // IMPORTANT: Dimensionner le canvas MAINTENANT
                gCanvas.width = window.innerWidth; 
                gCanvas.height = window.innerHeight;
                
                gameScore = 0; 
                document.getElementById('score-val').innerText = "0";
                
                if (gameType === 'FOOTBALL') this.initFootball();
                else if (gameType === 'MARBLES') this.initMarbles();
                
                gameActive = true;
                this.loop();
            }

            initFootball() {
                this.type = 'FOOTBALL';
                this.ball = { x: gCanvas.width/2, y: gCanvas.height - 150, r: 25, vx: 0, vy: 0, moving: false };
                this.goalie = { x: gCanvas.width/2, y: 150, w: 60, h: 20, dir: 1, speed: 3 };
                this.goal = { x: gCanvas.width/2 - 100, y: 50, w: 200, h: 100 };
                // Dessiner une premi√®re frame pour √©viter l'√©cran noir
                this.draw();
                speechQueue.push("Tire au but !"); parler();
            }

            initMarbles() {
                this.type = 'MARBLES';
                this.playerMarble = { x: gCanvas.width/2, y: gCanvas.height - 150, r: 20, vx: 0, vy: 0, color: 'white' };
                this.targets = [];
                for(let i=0; i<6; i++) {
                    this.targets.push({ x: gCanvas.width/2 + (Math.random()-0.5)*200, y: gCanvas.height/2 + (Math.random()-0.5)*200, r: 15, vx: 0, vy: 0, color: '#ef4444' });
                }
                this.arena = { x: gCanvas.width/2, y: gCanvas.height/2, r: 300 };
                this.draw();
                speechQueue.push("√âjecte les rouges !"); parler();
            }

            update() {
                if (!gameActive) return;

                if (this.type === 'FOOTBALL') {
                    // Goalie
                    this.goalie.x += this.goalie.dir * this.goalie.speed;
                    if (this.goalie.x > this.goal.x + this.goal.w || this.goalie.x < this.goal.x) this.goalie.dir *= -1;
                    
                    // Ball
                    if (this.ball.moving) {
                        this.ball.x += this.ball.vx; this.ball.y += this.ball.vy;
                        this.ball.vx *= 0.98; this.ball.vy *= 0.98;
                        
                        // Goal logic
                        if (this.ball.y < this.goal.y + this.goal.h && this.ball.x > this.goal.x && this.ball.x < this.goal.x + this.goal.w) {
                            if (Math.abs(this.ball.x - this.goalie.x) < 30 && Math.abs(this.ball.y - this.goalie.y) < 30) {
                                this.resetBall(false);
                            } else if (this.ball.y < this.goal.y + 10) {
                                this.resetBall(true);
                            }
                        }
                        // Bounds
                        if (this.ball.x < 0 || this.ball.x > gCanvas.width) this.ball.vx *= -1;
                        if (this.ball.y < 0) this.ball.vy *= -1;
                        if (this.ball.y > gCanvas.height) this.resetBall(false);
                        if (Math.abs(this.ball.vx) < 0.1 && Math.abs(this.ball.vy) < 0.1) this.ball.moving = false;
                    }
                } else if (this.type === 'MARBLES') {
                    // Player
                    this.playerMarble.x += this.playerMarble.vx; this.playerMarble.y += this.playerMarble.vy;
                    this.playerMarble.vx *= 0.95; this.playerMarble.vy *= 0.95;
                    
                    if (this.playerMarble.x < 0 || this.playerMarble.x > gCanvas.width) this.playerMarble.vx *= -1;
                    if (this.playerMarble.y < 0 || this.playerMarble.y > gCanvas.height) this.playerMarble.vy *= -1;

                    // Targets
                    for (let i = this.targets.length - 1; i >= 0; i--) {
                        let t = this.targets[i];
                        t.x += t.vx; t.y += t.vy;
                        t.vx *= 0.95; t.vy *= 0.95;
                        
                        let dx = t.x - this.playerMarble.x; let dy = t.y - this.playerMarble.y;
                        let dist = Math.sqrt(dx*dx + dy*dy);
                        if (dist < t.r + this.playerMarble.r) {
                            let angle = Math.atan2(dy, dx);
                            let force = 15;
                            t.vx = Math.cos(angle) * force; t.vy = Math.sin(angle) * force;
                            this.playerMarble.vx = -Math.cos(angle) * 5; this.playerMarble.vy = -Math.sin(angle) * 5;
                            playPopSound();
                        }

                        let distArena = Math.sqrt((t.x - this.arena.x)**2 + (t.y - this.arena.y)**2);
                        if (distArena > this.arena.r) {
                            this.targets.splice(i, 1);
                            gameScore++; document.getElementById('score-val').innerText = gameScore;
                            playSimpleWoosh();
                        }
                    }
                }
            }

            draw() {
                gCtx.clearRect(0, 0, gCanvas.width, gCanvas.height);
                if (this.type === 'FOOTBALL') {
                    // Goal
                    gCtx.strokeStyle = 'white'; gCtx.lineWidth = 5; gCtx.strokeRect(this.goal.x, this.goal.y, this.goal.w, this.goal.h);
                    // Goalie
                    gCtx.fillStyle = '#ef4444'; gCtx.beginPath(); gCtx.arc(this.goalie.x, this.goalie.y, 15, 0, Math.PI*2); gCtx.fill();
                    // Ball
                    gCtx.fillStyle = 'white'; gCtx.beginPath(); gCtx.arc(this.ball.x, this.ball.y, this.ball.r, 0, Math.PI*2); gCtx.fill();
                    // Hint
                    if(!this.ball.moving) {
                        gCtx.strokeStyle = 'rgba(255,255,255,0.3)'; gCtx.lineWidth = 2;
                        gCtx.beginPath(); gCtx.moveTo(this.ball.x, this.ball.y - 30); gCtx.lineTo(this.ball.x, this.ball.y - 80); gCtx.stroke();
                    }
                } else if (this.type === 'MARBLES') {
                    // Arena
                    gCtx.strokeStyle = 'rgba(255,255,255,0.2)'; gCtx.lineWidth = 5;
                    gCtx.beginPath(); gCtx.arc(this.arena.x, this.arena.y, this.arena.r, 0, Math.PI*2); gCtx.stroke();
                    // Player
                    gCtx.fillStyle = 'white'; gCtx.beginPath(); gCtx.arc(this.playerMarble.x, this.playerMarble.y, this.playerMarble.r, 0, Math.PI*2); gCtx.fill();
                    // Targets
                    this.targets.forEach(t => {
                        gCtx.fillStyle = t.color; gCtx.beginPath(); gCtx.arc(t.x, t.y, t.r, 0, Math.PI*2); gCtx.fill();
                    });
                }
            }

            loop() {
                if (!gameActive) return;
                try {
                    this.update();
                    this.draw();
                    gameLoopId = requestAnimationFrame(() => this.loop());
                } catch(e) {
                    console.log("Game Error caught, stopping loop to save UI", e);
                    gameActive = false;
                }
            }

            resetBall(scored) {
                this.ball.moving = false; this.ball.vx = 0; this.ball.vy = 0;
                this.ball.x = gCanvas.width/2; this.ball.y = gCanvas.height - 150;
                if (scored) { gameScore++; document.getElementById('score-val').innerText = gameScore; playSimpleWoosh(); speechQueue.push("But !"); parler(); }
                else { playPopSound(); }
            }

            handleSwipe(dx, dy) {
                // Facteur de puissance
                const power = 0.15;
                if (this.type === 'FOOTBALL' && !this.ball.moving) {
                    this.ball.vx = dx * power; 
                    this.ball.vy = dy * power; 
                    this.ball.moving = true;
                } else if (this.type === 'MARBLES') {
                    this.playerMarble.vx = dx * power; 
                    this.playerMarble.vy = dy * power;
                }
            }
        }

        const gameEngine = new GameEngine();

        // Gestion Tactile Simplifi√©e
        gCanvas.addEventListener('touchstart', (e) => { 
            e.preventDefault();
            gameEngine.touchStart = {x: e.touches[0].clientX, y: e.touches[0].clientY};
        }, {passive: false});
        
        gCanvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            gameEngine.touchEnd = {x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY};
            const dx = gameEngine.touchEnd.x - gameEngine.touchStart.x;
            const dy = gameEngine.touchEnd.y - gameEngine.touchStart.y;
            gameEngine.handleSwipe(dx, dy);
        }, {passive: false});

        function launchGame(type) {
            document.getElementById('game-selector-ui').style.display = 'none';
            document.getElementById('game-score-overlay').style.display = 'block';
            gameEngine.start(type);
        }

        function returnToMenu() {
            stopAudio();
            gameActive = false; // STOP Loop
            if(gameLoopId) cancelAnimationFrame(gameLoopId);
            
            document.getElementById('slate-layer').style.display = 'none';
            document.getElementById('coloring-layer').style.display = 'none';
            document.getElementById('fashion-layer').style.display = 'none';
            document.getElementById('game-layer').style.display = 'none';
            
            document.getElementById('main-interface').classList.remove('content-visible');
            // Hide all logos
            document.querySelectorAll('[id^="main-logo-"]').forEach(el => el.classList.add('hidden'));
            
            document.getElementById('intro-overlay').style.display = 'flex';
            document.getElementById('spotify-container').classList.remove('active');
            document.getElementById('spotify-frame').src = "";
            setTimeout(() => { document.getElementById('intro-overlay').classList.remove('intro-fade-out'); }, 50);
        }

        function selectMode(mode) {
            currentAppMode = mode;
            if (mode === 'CHAT') chatHistory = []; 
            
            // Masquer overlay intro
            document.getElementById('intro-overlay').classList.add('intro-fade-out');
            
            setTimeout(() => {
                document.getElementById('intro-overlay').style.display = 'none';
                
                if (mode === 'DRAW') {
                    document.getElementById('slate-layer').style.display = 'block'; initSlate();
                } 
                else if (mode === 'COLORING') {
                    document.getElementById('main-interface').classList.add('content-visible');
                    document.getElementById('main-logo-coloring').classList.remove('hidden');
                    document.getElementById('coloring-layer').style.display = 'block'; 
                    document.getElementById('coloring-layer').style.zIndex = "40"; 
                    initColoring(); 
                    lancerColoriageAleatoire();
                }
                else if (mode === 'FASHION') {
                    document.getElementById('main-interface').classList.add('content-visible');
                    document.getElementById('main-logo-fashion').classList.remove('hidden');
                    document.getElementById('fashion-layer').style.display = 'block'; 
                    document.getElementById('fashion-layer').style.zIndex = "40"; 
                    initFashion(); 
                    speechQueue.push("Bienvenue au studio de mode !"); parler();
                }
                else if (mode === 'GAME') {
                    document.getElementById('main-interface').classList.add('content-visible');
                    document.getElementById('main-logo-game').classList.remove('hidden');
                    document.getElementById('game-layer').style.display = 'block'; 
                    document.getElementById('game-selector-ui').style.display = 'flex';
                    document.getElementById('game-score-overlay').style.display = 'none';
                    speechQueue.push("C'est l'heure de jouer ! Choisis ton jeu."); parler();
                }
                else {
                    // Modes conversationnels (Story, Chat...)
                    document.getElementById('main-interface').classList.add('content-visible');
                    if(mode === 'STORY') document.getElementById('main-logo-story').classList.remove('hidden');
                    else if(mode === 'QUESTION') document.getElementById('main-logo-question').classList.remove('hidden');
                    else if(mode === 'CHAT') document.getElementById('main-logo-chat').classList.remove('hidden');
                    else if(mode === 'MUSIC') document.getElementById('main-logo-music').classList.remove('hidden');

                    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume();
                    playSimpleWoosh(); triggerBurst(); document.getElementById('white-flash').classList.add('flash-active');
                    
                    if (userColor) applyMixedTheme(userColor);
                    startInteractionSequence();
                }
            }, 800);
        }

        // ... (Reste des fonctions Helper et Event Listeners inchang√©s) ...
        function lancerColoriageAleatoire() { const sujets = ["un mignon chaton", "un dinosaure gentil", "une licorne magique", "un robot rigolo", "une belle voiture de course"]; const sujet = sujets[Math.floor(Math.random() * sujets.length)]; interactionMode = 'TELLING'; document.getElementById('status').innerText = "Je pr√©pare ton dessin..."; document.getElementById('ai-thinking').classList.remove('hidden'); genererColoriage(sujet); }
        function startInteractionSequence() { if (!userPrenom || !userGenre || !userAge || !userColor) { speechQueue.push("Bonjour ! Avant de commencer, dis-moi, es-tu un gar√ßon ou une fille ?"); interactionMode = 'GENDER_INPUT'; document.getElementById('status').innerText = "Gar√ßon ou fille ?"; parler(); return; } if (currentAppMode === 'STORY') { interactionMode = 'STORY_INPUT'; document.getElementById('status').innerText = "Quelle histoire veux-tu ?"; speechQueue.push(`Coucou ${userPrenom} ! De quoi veux-tu que je parle ?`); } else if (currentAppMode === 'QUESTION') { interactionMode = 'QUESTION_INPUT'; document.getElementById('status').innerText = "Pose ta question..."; speechQueue.push(`Bonjour ${userPrenom}. Je t'√©coute.`); } else if (currentAppMode === 'CHAT') { interactionMode = 'CHAT_INPUT'; document.getElementById('status').innerText = "On discute ?"; speechQueue.push(`Coucou ${userPrenom} ! Raconte-moi, comment √ßa va ?`); } else if (currentAppMode === 'COLORING') { interactionMode = 'COLORING_INPUT'; document.getElementById('status').innerText = "Que veux-tu colorier ?"; speechQueue.push(`C'est l'heure des couleurs ! Que veux-tu colorier ?`); } else if (currentAppMode === 'MUSIC') { interactionMode = 'MUSIC_INPUT'; document.getElementById('status').innerText = "Que veux-tu √©couter ?"; speechQueue.push(`Bienvenue dans la bo√Æte √† musique ! Dis-moi ce que tu veux √©couter.`); } parler(); }
        function traiterInput(texte) { if (!texte.trim()) return; stopAudio(); document.getElementById('manualInput').value = ""; const lowerText = texte.toLowerCase(); if (interactionMode === 'GENDER_INPUT') { if (lowerText.includes('gar√ßon') || lowerText.includes('homme')) { userGenre = 'gar√ßon'; next(); } else if (lowerText.includes('fille') || lowerText.includes('femme')) { userGenre = 'fille'; next(); } else { speechQueue.push(`Je n'ai pas bien compris. Es-tu un gar√ßon ou une fille ?`); parler(); } function next() { localStorage.setItem('BOITE_GENRE', userGenre); interactionMode = 'NAME_INPUT'; document.getElementById('status').innerText = `Comment t'appelles-tu ?`; speechQueue.push(`D'accord. Et comment t'appelles-tu ?`); parler(); } } else if (interactionMode === 'NAME_INPUT') { userPrenom = texte.replace(/je m'appelle /i, "").replace(/c'est /i, "").trim(); localStorage.setItem('BOITE_PRENOM', userPrenom); interactionMode = 'COLOR_INPUT'; document.getElementById('status').innerText = `Tes couleurs pr√©f√©r√©es ?`; speechQueue.push(`Enchant√©e ${userPrenom} ! Quelles sont tes couleurs pr√©f√©r√©es ?`); parler(); } else if (interactionMode === 'COLOR_INPUT') { userColor = texte; localStorage.setItem('BOITE_COLOR', userColor); applyMixedTheme(userColor); interactionMode = 'AGE_INPUT'; document.getElementById('status').innerText = `Quel √¢ge as-tu ?`; speechQueue.push(`C'est not√©. Et quel √¢ge as-tu ?`); parler(); } else if (interactionMode === 'AGE_INPUT') { userAge = texte.replace(/j'ai /i, "").replace(/ans/i, "").trim(); localStorage.setItem('BOITE_AGE', userAge); startInteractionSequence(); } else if (interactionMode === 'STORY_INPUT') { interactionMode = 'TELLING'; appelIA(texte, 'STORY'); } else if (interactionMode === 'QUESTION_INPUT') { interactionMode = 'TELLING'; appelIA(texte, 'QUESTION'); } else if (interactionMode === 'CHAT_INPUT') { interactionMode = 'TELLING'; appelIA(texte, 'CHAT'); } else if (interactionMode === 'MUSIC_INPUT') { interactionMode = 'TELLING'; appelIA(texte, 'MUSIC'); } else if (interactionMode === 'COLORING_INPUT') { interactionMode = 'TELLING'; document.getElementById('status').innerText = "Je dessine..."; document.getElementById('ai-thinking').classList.remove('hidden'); genererColoriage(texte); } }
        function playSpotify(key) { const playlistId = SPOTIFY_DB[key] || SPOTIFY_DB['POP']; const container = document.getElementById('spotify-container'); const iframe = document.getElementById('spotify-frame'); document.getElementById('story-card').classList.add('hidden'); iframe.src = `https://open.spotify.com/embed/playlist/${playlistId}?utm_source=generator&theme=0`; container.classList.add('active'); speechQueue.push("C'est parti ! Musique maestro !"); parler(); }
        function stopAudio() { if (currentAudio) { currentAudio.pause(); currentAudio = null; } stopVisualizer(); speechQueue = []; isSpeaking = false; document.getElementById('main-header').classList.remove('cinema-mode'); document.getElementById('status').classList.remove('hidden'); document.getElementById('ai-thinking').classList.add('hidden'); toggleStopButton(false); document.getElementById('story-card').classList.add('hidden'); }
        function toggleStopButton(active) { const container = document.getElementById('stop-container'); if (active) { container.classList.remove('opacity-20', 'pointer-events-none'); container.classList.add('opacity-100'); } else { container.classList.add('opacity-20', 'pointer-events-none'); container.classList.remove('opacity-100'); } }
        function verifierCles() { if (!GEMINI_KEY) { const k = prompt("Entre ta cl√© d'activation magique N¬∞1 (Google) :"); if (k) { localStorage.setItem('BOITE_GEMINI_KEY', k); GEMINI_KEY = k; } } if (!AZURE_KEY) { const k = prompt("Entre ta cl√© d'activation magique N¬∞2 (Azure) :"); const r = prompt("Entre ta r√©gion Azure (ex: francecentral) :"); if (k && r) { localStorage.setItem('BOITE_AZURE_KEY', k); localStorage.setItem('BOITE_AZURE_REGION', r); AZURE_KEY = k; AZURE_REGION = r; } } if (GEMINI_KEY && AZURE_KEY && AZURE_REGION) location.reload(); }
        function oublierTout() { localStorage.removeItem('BOITE_PRENOM'); localStorage.removeItem('BOITE_AGE'); localStorage.removeItem('BOITE_GENRE'); localStorage.removeItem('BOITE_COLOR'); location.reload(); }
        document.addEventListener('DOMContentLoaded', () => { if (!GEMINI_KEY || !AZURE_KEY) verifierCles(); document.getElementById('btn-mic').onclick = () => { startListening(); }; document.getElementById('btn-stop').onclick = stopAudio; });
        async function appelIA(sujet, mode) { if (!GEMINI_KEY || !AZURE_KEY || !AZURE_REGION) { verifierCles(); return; } stopAudio(); interactionMode = 'TELLING'; const btnMic = document.getElementById('btn-mic'); const statusLabel = document.getElementById('status'); const waves = document.getElementById('ai-thinking'); playSoftPing(); btnMic.classList.add('understood-flash'); statusLabel.classList.add('hidden'); waves.classList.remove('hidden'); setTimeout(() => { btnMic.classList.remove('understood-flash'); toggleStopButton(true); }, 800); let waitingPhrase = "Je r√©fl√©chis..."; if (mode === 'STORY') waitingPhrase = "J'√©cris ton histoire..."; else if (mode === 'QUESTION') waitingPhrase = "Je cherche..."; else if (mode === 'MUSIC') waitingPhrase = "Je fouille mes disques..."; document.getElementById('status').innerText = waitingPhrase; const url = `https://generativelanguage.googleapis.com/v1beta/${MODEL_ID}:streamGenerateContent?alt=sse&key=${GEMINI_KEY}`; let promptIA = ""; let contextChild = ""; if (userPrenom) contextChild += `L'enfant s'appelle ${userPrenom} (${userGenre}, ${userAge} ans). `; if (mode === 'STORY') { promptIA = `Tu es une conteuse. ${contextChild} Raconte une aventure sur : "${sujet}". R√àGLES : 1. Si personnage connu, raconte l'histoire de CE personnage. 2. Sinon invente un h√©ros (pas l'enfant). 3. Ton doux, phrases simples, fin heureuse.`; } else if (mode === 'QUESTION') { promptIA = `Encyclop√©die bienveillante. ${contextChild} L'enfant demande : "${sujet}". R√©ponds simplement (3-4 phrases).`; } else if (mode === 'CHAT') { chatHistory.push({ role: "user", content: sujet }); const recentHistory = chatHistory.slice(-6).map(msg => `${msg.role === 'user' ? 'Enfant' : 'Toi (IA)'}: ${msg.content}`).join('\n'); promptIA = `Tu es une amie magique. ${contextChild} R√©ponds √† : "${sujet}". Historique : ${recentHistory}`; } else if (mode === 'MUSIC') { const availableKeys = Object.keys(SPOTIFY_DB).join(', '); promptIA = `DJ expert pour enfants. Demande: "${sujet}". Choisis la meilleure playlist parmi : ${availableKeys}. R√©ponds UNIQUEMENT par le mot cl√© en majuscule.`; } try { const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: promptIA }] }] }) }); const reader = response.body.getReader(); const decoder = new TextDecoder("utf-8"); let currentSentence = ""; let fullResponseText = ""; while (true) { const { done, value } = await reader.read(); if (done) { waves.classList.add('hidden'); statusLabel.classList.remove('hidden'); statusLabel.innerText = "C'est pr√™t !"; if (mode === 'MUSIC') { const cleanKey = fullResponseText.trim().toUpperCase().replace(/[^A-Z_]/g, ''); playSpotify(cleanKey); interactionMode = 'MUSIC_INPUT'; } else { statusLabel.innerText = "Je te r√©ponds..."; if (currentSentence.trim()) { speechQueue.push(currentSentence.trim()); fullResponseText += currentSentence.trim(); parler(); } if (mode === 'CHAT') chatHistory.push({ role: "model", content: fullResponseText }); if (mode === 'CHAT') interactionMode = 'CHAT_INPUT'; else if (mode === 'STORY') interactionMode = 'STORY_INPUT'; else if (mode === 'QUESTION') interactionMode = 'QUESTION_INPUT'; } break; } const chunk = decoder.decode(value); const lines = chunk.split("\n"); for (const line of lines) { if (line.startsWith("data: ")) { try { const json = JSON.parse(line.substring(6)); const chunkText = json.candidates[0].content.parts[0].text; currentSentence += chunkText; if (mode !== 'MUSIC' && (/[.!?;:]/.test(chunkText) || chunkText.includes("\n"))) { const parts = currentSentence.split(/([.!?;:]|\n)/); for (let i = 0; i < parts.length - 1; i += 2) { const p = (parts[i] + (parts[i+1] || "")).trim(); if (p.length > 2) { speechQueue.push(p); fullResponseText += p + " "; parler(); } } currentSentence = parts[parts.length - 1]; } else { fullResponseText += chunkText; currentSentence = ""; } } catch(e) {} } } } } catch (e) { waves.classList.add('hidden'); statusLabel.classList.remove('hidden'); statusLabel.innerText = "Erreur technique..."; } }
    </script>
</body>
</html>