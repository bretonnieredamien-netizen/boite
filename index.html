<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ta boite magique ‚ú®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;500;800;900&display=swap" rel="stylesheet">
    <style>
        /* --- VARIABLES & BASE --- */
        :root { --bg-1: #fff7ed; --bg-2: #fef9c3; --bg-3: #ede9fe; --bg-4: #fae8ff; --accent-color: #6366f1; }
        body { font-family: 'Lexend', sans-serif; background: linear-gradient(-45deg, var(--bg-1), var(--bg-2), var(--bg-3), var(--bg-4)); background-size: 400% 400%; animation: gradientBG 15s ease infinite; touch-action: none; overflow: hidden; min-height: 100vh; margin: 0; }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        #starfield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .hidden { display: none !important; }
        .content-layer { position: relative; z-index: 10; width: 100%; display: flex; flex-direction: column; align-items: center; opacity: 0; transition: opacity 0.5s ease-in; }
        .content-visible { opacity: 1 !important; }

        /* --- LAYERS (APPS VISUELLES) --- */
        /* Ces calques couvrent tout l'√©cran */
        #slate-layer, #coloring-layer, #fashion-layer, #game-layer { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 100; background: #0f172a; display: none; 
        }
        #coloring-layer { background: #ffffff; }
        #fashion-layer { background: #1e1e1e; } /* Fond noir Studio Mode */
        #game-layer { background: #0f172a; }   /* Fond bleu nuit Jeux */

        /* CANVAS */
        canvas { touch-action: none; }
        #slate-canvas, #color-canvas, #game-canvas { width: 100%; height: 100%; }

        /* --- UI COMMUNES --- */
        .nav-home-btn { position: absolute; top: 1.5rem; left: 1.5rem; z-index: 200; width: 52px; height: 52px; background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); border: 2px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .nav-home-btn svg { width: 26px; height: 26px; fill: #6366f1; }
        
        /* Barres d'outils (Dessin, Coloriage, Mode) */
        .slate-controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 800px; display: flex; gap: 10px; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(20px); padding: 10px 20px; border-radius: 25px; align-items: center; z-index: 200; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        #coloring-controls, #fashion-controls { background: rgba(255, 255, 255, 0.95); border: 1px solid #cbd5e1; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
        
        .brush-btn { flex-shrink: 0; width: 45px; height: 45px; border-radius: 50%; border: 2px solid transparent; background: rgba(255,255,255,0.2); font-size: 1.2rem; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .brush-btn.active { background: white; transform: scale(1.1); border-color: #6366f1; box-shadow: 0 0 10px rgba(99,102,241,0.5); }
        .color-picker { flex-shrink: 0; width: 30px; height: 30px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.5); cursor: pointer; }
        .color-picker.active { transform: scale(1.3); border-color: white; }

        /* --- STUDIO MODE (Sp√©cifique) --- */
        #fashion-workspace { position: absolute; top: 0; left: 0; width: 100%; height: 85%; display: flex; justify-content: center; align-items: center; pointer-events: none; }
        .fashion-stack-item { position: absolute; height: 80%; width: auto; max-width: 90%; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #wardrobe-list { display: flex; gap: 10px; overflow-x: auto; height: 100%; align-items: center; padding: 0 10px; scrollbar-width: none; }
        .wardrobe-item { flex-shrink: 0; width: 60px; height: 60px; background: #fff; border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 2px solid #e2e8f0; cursor: pointer; }
        .wardrobe-item img { width: 80%; height: 80%; object-fit: contain; }

        /* --- JEUX (Sp√©cifique) --- */
        #game-selector-ui { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; flex-direction: column; gap: 15px; width: 80%; max-width: 350px; z-index: 160; }
        .game-card-btn { background: white; padding: 20px; border-radius: 20px; display: flex; align-items: center; gap: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); cursor: pointer; transition: transform 0.1s; }
        .game-card-btn:active { transform: scale(0.95); }
        .game-score { position: absolute; top: 20px; right: 20px; color: #6366f1; background: white; padding: 10px 20px; border-radius: 50px; font-weight: 900; font-size: 1.5rem; z-index: 160; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: none; }

        /* --- ACCUEIL & INTERFACE VOCALE --- */
        #intro-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; background: transparent; transition: opacity 0.5s; }
        .mode-selector { display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center; max-width: 800px; padding: 20px; }
        .mode-card { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; cursor: pointer; transition: transform 0.2s; }
        .mode-card:hover { transform: scale(1.1); }
        .mode-icon-box { width: 80px; height: 80px; background: rgba(255,255,255,0.3); border-radius: 20px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); border: 2px solid rgba(255,255,255,0.6); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        #main-interface { min-height: 100vh; }
        .orbe-base { width: 100px; height: 100px; border-radius: 50%; background: rgba(255,255,255,0.3); border: 2px solid white; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; }
        .mic-listening { background: #6366f1; border-color: #6366f1; box-shadow: 0 0 30px #6366f1; }
        .mic-listening svg { fill: white; }

        #generated-coloring-image { display:none; }
    </style>
</head>
<body class="p-6">

    <canvas id="starfield"></canvas>

    <div id="slate-layer">
        <button class="nav-home-btn" onclick="returnToMenu()"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></button>
        <canvas id="slate-canvas"></canvas>
        <div class="slate-controls">
            <div class="flex gap-2 mr-4">
                <div class="color-picker" style="background:white" onclick="setBaseColor('white', this)"></div>
                <div class="color-picker" style="background:#ef4444" onclick="setBaseColor('#ef4444', this)"></div>
                <div class="color-picker" style="background:#3b82f6" onclick="setBaseColor('#3b82f6', this)"></div>
                <div class="color-picker" style="background:#22c55e" onclick="setBaseColor('#22c55e', this)"></div>
            </div>
            <button class="brush-btn active" onclick="setBrush('base', this)">‚úèÔ∏è</button>
            <button class="brush-btn" onclick="setBrush('neon', this)">üí°</button>
            <button class="brush-btn" onclick="setBrush('fire', this)">üî•</button>
            <button class="brush-btn" onclick="setBrush('galaxy', this)">üåå</button>
            <div style="width:1px; height:30px; background:#fff; margin:0 10px;"></div>
            <button class="brush-btn" onclick="setBrush('eraser', this)">üßΩ</button>
            <button class="brush-btn" onclick="clearSlate()" style="font-size:0.8rem; font-weight:bold; width:auto; padding:0 15px; border-radius:15px;">TOUT EFFACER</button>
        </div>
    </div>

    <div id="coloring-layer">
        <button class="nav-home-btn" onclick="returnToMenu()"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></button>
        <img id="generated-coloring-image" src="" alt="Coloriage">
        <canvas id="color-canvas"></canvas>
        <div id="coloring-controls" class="slate-controls">
            <div class="flex gap-2 mr-4">
                <div class="color-picker active" style="background:#ef4444" onclick="setColoringColor('#ef4444', this)"></div>
                <div class="color-picker" style="background:#3b82f6" onclick="setColoringColor('#3b82f6', this)"></div>
                <div class="color-picker" style="background:#22c55e" onclick="setColoringColor('#22c55e', this)"></div>
                <div class="color-picker" style="background:#eab308" onclick="setColoringColor('#eab308', this)"></div>
            </div>
            <button class="brush-btn active" onclick="setColoringBrush('marker', this)">üñçÔ∏è</button>
            <button class="brush-btn" onclick="setColoringBrush('crayon', this)">‚úèÔ∏è</button>
            <button class="brush-btn" onclick="setColoringBrush('eraser', this)">üßΩ</button>
            <button class="brush-btn" onclick="clearColoring()" style="font-size:0.8rem; font-weight:bold; width:auto; padding:0 15px; border-radius:15px; color:#ef4444;">NOUVEAU</button>
        </div>
    </div>

    <div id="fashion-layer">
        <button class="nav-home-btn" onclick="returnToMenu()"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></button>
        
        <div id="fashion-workspace">
            <img id="fashion-mannequin-base" class="fashion-stack-item" src="">
            <img id="fashion-wear-bottom" class="fashion-stack-item" style="opacity:0">
            <img id="fashion-wear-top" class="fashion-stack-item" style="opacity:0">
            <img id="fashion-wear-full" class="fashion-stack-item" style="opacity:0">
            <img id="fashion-wear-shoes" class="fashion-stack-item" style="opacity:0">
            <img id="fashion-wear-hat" class="fashion-stack-item" style="opacity:0">
        </div>

        <div id="fashion-controls" class="slate-controls" style="height:100px; justify-content: flex-start;">
            <button onclick="changerMannequin()" class="brush-btn active" style="margin-right:10px; background:white; color:#0891b2">üîÑ</button>
            <div id="wardrobe-list"></div>
            <button onclick="resetOutfit()" class="brush-btn" style="margin-left:10px; color:#ef4444">üóëÔ∏è</button>
        </div>
    </div>

    <div id="game-layer">
        <button class="nav-home-btn" onclick="returnToMenu()"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></button>
        <div id="game-score-overlay" class="game-score">SCORE: <span id="score-val">0</span></div>
        <canvas id="game-canvas"></canvas>
        
        <div id="game-selector-ui">
            <div class="game-card-btn" onclick="launchGame('FOOTBALL')">
                <span style="font-size:3rem">‚öΩ</span>
                <div>
                    <h3 style="font-weight:800; font-size:1.2rem; color:#1e293b">Super Buteur</h3>
                    <p style="color:#64748b">Marque des buts !</p>
                </div>
            </div>
            <div class="game-card-btn" onclick="launchGame('MARBLES')">
                <span style="font-size:3rem">‚ö™</span>
                <div>
                    <h3 style="font-weight:800; font-size:1.2rem; color:#1e293b">Choc des Billes</h3>
                    <p style="color:#64748b">√âjecte les rouges !</p>
                </div>
            </div>
        </div>
    </div>

    <div id="intro-overlay">
        <div class="god-rays"></div>
        <p class="text-indigo-900/50 text-xl font-black mb-10 uppercase tracking-widest text-center">Choisis ta magie</p>
        <div class="mode-selector">
            <div class="mode-card" onclick="selectMode('STORY')"><div class="mode-icon-box"><svg width="40" height="40" viewBox="0 0 24 24" fill="#6366f1"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg></div><span class="mode-label">Histoires</span></div>
            <div class="mode-card" onclick="selectMode('QUESTION')"><div class="mode-icon-box"><svg width="40" height="40" viewBox="0 0 24 24" fill="#ec4899"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg></div><span class="mode-label">Questions</span></div>
            <div class="mode-card" onclick="selectMode('CHAT')"><div class="mode-icon-box"><svg width="40" height="40" viewBox="0 0 24 24" fill="#f59e0b"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg></div><span class="mode-label">Discussion</span></div>
            <div class="mode-card" onclick="selectMode('DRAW')"><div class="mode-icon-box"><svg width="40" height="40" viewBox="0 0 24 24" fill="#10b981"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8z"/></svg></div><span class="mode-label">Dessin</span></div>
            <div class="mode-card" onclick="selectMode('COLORING')"><div class="mode-icon-box"><svg width="40" height="40" viewBox="0 0 24 24" fill="#8b5cf6"><path d="M17.75 7L14 3.25l-10 10V17h3.75l10-10zm2.96-2.96c.39-.39.39-1.02 0-1.41L18.37.29c-.39-.39-1.02-.39-1.41 0L15.5 1.75l2.75 2.75 1.46-1.46z"/></svg></div><span class="mode-label">Coloriage</span></div>
            <div class="mode-card" onclick="selectMode('MUSIC')"><div class="mode-icon-box"><svg width="40" height="40" viewBox="0 0 24 24" fill="#06b6d4"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg></div><span class="mode-label">Musique</span></div>
            <div class="mode-card" onclick="selectMode('FASHION')"><div class="mode-icon-box"><svg width="40" height="40" viewBox="0 0 24 24" fill="#fb7185"><path d="M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-2 10H5V8h14v8zM6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM12 2C9.24 2 7 4.24 7 7h10c0-2.76-2.24-5-5-5z"/></svg></div><span class="mode-label">Mode</span></div>
            <div class="mode-card" onclick="selectMode('GAME')"><div class="mode-icon-box"><svg width="40" height="40" viewBox="0 0 24 24" fill="#f97316"><path d="M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-10 7H8v3H6v-3H3v-2h3V8h2v3h3v2zm4.5 2c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4-3c-.83 0-1.5-.67-1.5-1.5S18.67 9 19.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg></div><span class="mode-label">Jeux</span></div>
        </div>
        <button onclick="oublierTout()" class="mt-8 text-indigo-900/40 text-xs font-bold uppercase tracking-widest hover:text-indigo-600 transition-colors">Red√©finir mon profil</button>
    </div>

    <div id="main-interface" class="content-layer min-h-screen">
        <button class="nav-home-btn" onclick="returnToMenu()"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></button>
        <header id="main-header" class="text-center flex flex-col items-center mt-6">
            <div class="logo-container">
                <svg id="logo-ia" width="100" height="100" viewBox="0 0 24 24" fill="#6366f1"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
            </div>
            <div class="status-box">
                <p id="status" class="text-indigo-900/60 font-semibold italic text-sm">Pr√™t...</p>
                <div id="ai-thinking" class="hidden thinking-waves">
                    <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                </div>
            </div>
        </header>
        <main class="w-full max-w-md flex flex-col items-center gap-14 mt-8">
            <div class="flex items-center justify-center gap-12 w-full">
                <button id="btn-mic" class="orbe-base shadow-2xl">
                    <svg viewBox="0 0 24 24" width="40" height="40" fill="#6366f1"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                </button>
                <div id="stop-container" class="opacity-20 pointer-events-none transition-all duration-500">
                    <button id="btn-stop" class="orbe-base shadow-xl"><svg viewBox="0 0 24 24" width="30" height="30" fill="#f87171"><rect x="6" y="6" width="12" height="12" rx="2" /></svg></button>
                </div>
            </div>
            <div id="spotify-container" class=""><iframe id="spotify-frame" style="border-radius:12px" src="" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe></div>
            <input type="text" id="manualInput" class="hidden">
        </main>
    </div>

    <script>
        /* ---------------- CONFIG ---------------- */
        let GEMINI_KEY = localStorage.getItem('BOITE_GEMINI_KEY');
        let AZURE_KEY = localStorage.getItem('BOITE_AZURE_KEY');
        let AZURE_REGION = localStorage.getItem('BOITE_AZURE_REGION');
        let userPrenom = localStorage.getItem('BOITE_PRENOM');
        let userAge = localStorage.getItem('BOITE_AGE');
        let userGenre = localStorage.getItem('BOITE_GENRE'); 
        let userColor = localStorage.getItem('BOITE_COLOR'); 
        
        let currentAppMode = null; 
        let interactionMode = 'INIT'; 
        let chatHistory = []; 
        const MODEL_ID = "models/gemini-2.5-flash"; 
        const AZURE_VOICE_NAME = "fr-FR-VivienneMultilingualNeural"; 

        /* ---------------- GRAPHICS & DATA ---------------- */
        
        // MANNEQUINS (Style Blanc sur Noir, Ferflex)
        const AVATAR_BOY_OUTLINE = `<svg viewBox="0 0 400 800" xmlns="http://www.w3.org/2000/svg"><g stroke="white" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M150,120 L150,110 M150,110 C165,110 180,95 180,70 C180,45 165,25 150,25 C135,25 120,45 120,70 C120,95 135,110 150,110 Z"/><path d="M138,65 L142,65 M158,65 L162,65 M150,75 L150,80 M145,90 Q150,95 155,90" stroke-width="2"/><path d="M150,25 C140,25 120,35 115,55 C115,35 130,15 150,15 C170,15 185,35 185,55 C180,35 160,25 150,25 Z"/><path d="M130,115 L115,130 L110,250 L100,260 L105,270 L115,260 L115,250 M170,115 L185,130 L190,250 L200,260 L195,270 L185,260 L185,250"/><path d="M130,115 L130,250 L115,400 L125,580 L150,570 L175,580 L185,400 L170,250 L170,115"/><path d="M115,250 L185,250 L185,280 L115,280 Z"/></g></svg>`;
        const AVATAR_GIRL_OUTLINE = `<svg viewBox="0 0 400 800" xmlns="http://www.w3.org/2000/svg"><g stroke="white" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M150,110 C165,110 180,95 180,70 C180,45 165,30 150,30 C135,30 120,45 120,70 C120,95 135,110 150,110 Z"/><path d="M138,65 L142,65 M158,65 L162,65 M150,75 L150,80 M145,90 Q150,95 155,90" stroke-width="2"/><path d="M150,30 C130,30 110,55 110,95 L110,140 C110,150 130,150 130,140 L130,90 C130,60 170,60 170,90 L170,140 C170,150 190,150 190,140 L190,95 C190,55 170,30 150,30 Z" /><path d="M130,115 L115,130 L110,250 L100,260 L105,270 L115,260 L115,250 M170,115 L185,130 L190,250 L200,260 L195,270 L185,260 L185,250"/><path d="M130,115 L135,250 L120,400 L130,580 L150,570 L170,580 L180,400 L165,250 L170,115"/><path d="M115,250 L185,250 L180,280 L120,280 Z"/><path d="M130,120 L170,120 L170,150 L130,150 Z"/></g></svg>`;
        
        const MANNEQUINS = [AVATAR_BOY_OUTLINE, AVATAR_GIRL_OUTLINE];
        let currentMannequinIndex = 0;

        function createClothes() {
            const items = [];
            const palette = ['#ef4444', '#3b82f6', '#f59e0b', '#10b981', '#ec4899', '#8b5cf6'];
            
            palette.forEach((c, i) => {
                items.push({ type: 'top', svg: `<svg viewBox="0 0 400 800" xmlns="http://www.w3.org/2000/svg"><path d="M115,130 L185,130 L200,160 L180,160 L180,250 L120,250 L120,160 L100,160 Z" fill="${c}" stroke="none"/></svg>` });
                if(i%2===0) items.push({ type: 'top', svg: `<svg viewBox="0 0 400 800" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="stripes${i}" width="10" height="10" patternTransform="rotate(45)" patternUnits="userSpaceOnUse"><rect width="5" height="10" fill="white" fill-opacity="0.3"/></pattern></defs><path d="M115,130 L185,130 L200,160 L180,160 L180,250 L120,250 L120,160 L100,160 Z" fill="${c}" stroke="none"/><path d="M115,130 L185,130 L200,160 L180,160 L180,250 L120,250 L120,160 L100,160 Z" fill="url(#stripes${i})" stroke="none"/></svg>` });
            });
            ['#ec4899', '#8b5cf6', '#ef4444'].forEach(c => { items.push({ type: 'full', svg: `<svg viewBox="0 0 400 800" xmlns="http://www.w3.org/2000/svg"><path d="M130,130 L170,130 L180,250 L210,400 L90,400 L120,250 Z" fill="${c}" stroke="none"/></svg>` }); });
            ['#1e3a8a', '#334155', '#b45309'].forEach(c => { items.push({ type: 'bottom', svg: `<svg viewBox="0 0 400 800" xmlns="http://www.w3.org/2000/svg"><path d="M115,240 L185,240 L195,570 L160,570 L150,350 L140,570 L105,570 Z" fill="${c}" stroke="none"/></svg>` }); });
            ['#f472b6', '#a78bfa'].forEach(c => { items.push({ type: 'bottom', svg: `<svg viewBox="0 0 400 800" xmlns="http://www.w3.org/2000/svg"><path d="M120,240 L180,240 L200,350 L100,350 Z" fill="${c}" stroke="none"/></svg>` }); });
            items.push({ type: 'shoes', svg: `<svg viewBox="0 0 400 800" xmlns="http://www.w3.org/2000/svg"><path d="M125,580 Q120,600 140,600 Q160,600 160,580 Z" fill="white"/><path d="M175,580 Q180,600 160,600 Q140,600 140,580 Z" fill="white" transform="translate(50,0)"/></svg>` });
            items.push({ type: 'shoes', svg: `<svg viewBox="0 0 400 800" xmlns="http://www.w3.org/2000/svg"><path d="M125,580 Q120,600 140,600 Q160,600 160,580 Z" fill="#333"/><path d="M175,580 Q180,600 160,600 Q140,600 140,580 Z" fill="#333" transform="translate(50,0)"/></svg>` });
            return items;
        }
        const WARDROBE_ITEMS = createClothes();

        /* ---------------- LOGIQUE DESSIN ---------------- */
        const sCanvas = document.getElementById('slate-canvas'); const sCtx = sCanvas.getContext('2d');
        let drawing = false, currentBrush = 'base', hue = 0, baseColor = 'white'; let lastX = 0, lastY = 0; 
        
        function initSlate() { sCanvas.width = window.innerWidth; sCanvas.height = window.innerHeight; sCtx.lineCap = 'round'; sCtx.lineJoin = 'round'; }
        function setBrush(b, btn) { currentBrush = b; document.querySelectorAll('.brush-btn').forEach(el => el.classList.remove('active')); btn.classList.add('active'); }
        function setBaseColor(c, btn) { baseColor = c; currentBrush = 'base'; document.querySelectorAll('.color-picker').forEach(el => el.classList.remove('active')); btn.classList.add('active'); }
        
        function draw(e) { if (!drawing) return; const x = e.clientX || e.touches[0].clientX; const y = e.clientY || e.touches[0].clientY; hue = (hue + 2) % 360; sCtx.lineWidth = currentBrush === 'galaxy' ? 1.5 : (currentBrush === 'neon' ? 3 : (currentBrush === 'eraser' ? 20 : 2.5)); sCtx.globalCompositeOperation = 'source-over'; 
            if (currentBrush === 'base') { sCtx.strokeStyle = baseColor; sCtx.shadowBlur = 0; } else if (currentBrush === 'eraser') { sCtx.globalCompositeOperation = 'destination-out'; sCtx.strokeStyle = 'rgba(0,0,0,1)'; sCtx.shadowBlur = 0; } else if (currentBrush === 'neon') { sCtx.strokeStyle = `hsl(${hue}, 100%, 70%)`; sCtx.shadowBlur = 15; sCtx.shadowColor = sCtx.strokeStyle; } else if (currentBrush === 'rainbow') { sCtx.strokeStyle = `hsl(${hue}, 100%, 50%)`; sCtx.shadowBlur = 0; } else if (currentBrush === 'fire') { const grad = sCtx.createLinearGradient(lastX, lastY, x, y); grad.addColorStop(0, '#ff9a00'); grad.addColorStop(1, '#ff0000'); sCtx.strokeStyle = grad; sCtx.lineWidth = 4; sCtx.shadowBlur = 20; sCtx.shadowColor = '#ff4500'; if (Math.random() > 0.5) { for(let i=0; i<2; i++) { const pX = x + (Math.random()-0.5) * 20; const pY = y - Math.random() * 30; sCtx.fillStyle = `rgba(255, ${Math.floor(Math.random()*150)}, 0, ${Math.random() * 0.8})`; sCtx.beginPath(); sCtx.arc(pX, pY, Math.random()*2.5, 0, Math.PI*2); sCtx.fill(); } } } else if (currentBrush === 'ice') { sCtx.strokeStyle = `rgba(224, 242, 254, 0.9)`; sCtx.shadowBlur = 10; sCtx.shadowColor = '#0ea5e9'; for(let i=0; i<2; i++) { const pX = x + (Math.random()-0.5) * 15; const pY = y + Math.random() * 25; sCtx.fillStyle = `rgba(255, 255, 255, 0.8)`; sCtx.beginPath(); sCtx.arc(pX, pY, Math.random()*1.5, 0, Math.PI*2); sCtx.fill(); } } else if (currentBrush === 'electric') { sCtx.strokeStyle = '#fef08a'; sCtx.shadowBlur = 20; sCtx.shadowColor = '#facc15'; const jitterX = x + (Math.random()-0.5) * 10; const jitterY = y + (Math.random()-0.5) * 10; sCtx.lineTo(jitterX, jitterY); } else if (currentBrush === 'galaxy') { sCtx.strokeStyle = 'rgba(255,255,255,0.8)'; sCtx.shadowBlur = 8; sCtx.shadowColor = `hsl(${hue}, 100%, 80%)`; for(let i=0; i<3; i++) { sCtx.beginPath(); sCtx.arc(x + (Math.random()-0.5)*20, y + (Math.random()-0.5)*20, Math.random()*1.5, 0, Math.PI*2); sCtx.fillStyle = 'white'; sCtx.fill(); } } else if (currentBrush === 'gold') { sCtx.strokeStyle = '#fbbf24'; sCtx.shadowBlur = 20; sCtx.shadowColor = '#f59e0b'; if(Math.random() > 0.8) { const pX = x + (Math.random()-0.5) * 20; const pY = y + (Math.random()-0.5) * 20; sCtx.fillStyle = '#fffbeb'; sCtx.beginPath(); sCtx.arc(pX, pY, Math.random()*2, 0, Math.PI*2); sCtx.fill(); } }
            if (currentBrush !== 'electric') sCtx.lineTo(x, y); sCtx.stroke(); sCtx.beginPath(); sCtx.moveTo(x, y); lastX = x; lastY = y;
        }
        sCanvas.addEventListener('mousedown', (e) => { drawing = true; lastX = e.clientX; lastY = e.clientY; sCtx.beginPath(); sCtx.moveTo(e.clientX, e.clientY); }); sCanvas.addEventListener('mousemove', draw); window.addEventListener('mouseup', () => drawing = false); sCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); drawing = true; lastX = e.touches[0].clientX; lastY = e.touches[0].clientY; sCtx.beginPath(); sCtx.moveTo(e.touches[0].clientX, e.touches[0].clientY); }); sCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); }); window.addEventListener('touchend', () => drawing = false);
        function clearSlate() { sCtx.clearRect(0,0,sCanvas.width, sCanvas.height); }

        /* ---------------- LOGIQUE COLORIAGE ---------------- */
        const cCanvas = document.getElementById('color-canvas'); const cCtx = cCanvas.getContext('2d');
        let coloring = false, cColor = '#ef4444', cBrush = 'marker';
        function initColoring() { cCanvas.width = window.innerWidth; cCanvas.height = window.innerHeight; cCtx.lineCap = 'round'; cCtx.lineJoin = 'round'; }
        function setColoringColor(c, btn) { cColor = c; cBrush = 'marker'; document.querySelectorAll('#coloring-controls .color-picker').forEach(el => el.classList.remove('active')); btn.classList.add('active'); }
        function setColoringBrush(b, btn) { cBrush = b; document.querySelectorAll('#coloring-controls .brush-btn').forEach(el => el.classList.remove('active')); btn.classList.add('active'); }
        function drawColor(e) { if (!coloring) return; const x = e.clientX || e.touches[0].clientX; const y = e.clientY || e.touches[0].clientY; cCtx.strokeStyle = cColor; cCtx.globalCompositeOperation = 'source-over'; if (cBrush === 'marker') { cCtx.lineWidth = 15; cCtx.globalAlpha = 0.5; } else if (cBrush === 'crayon') { cCtx.lineWidth = 5; cCtx.globalAlpha = 1; } else if (cBrush === 'eraser') { cCtx.globalCompositeOperation = 'destination-out'; cCtx.lineWidth = 30; cCtx.globalAlpha = 1; } cCtx.lineTo(x, y); cCtx.stroke(); cCtx.beginPath(); cCtx.moveTo(x, y); }
        cCanvas.addEventListener('mousedown', (e) => { coloring = true; cCtx.beginPath(); cCtx.moveTo(e.clientX, e.clientY); }); cCanvas.addEventListener('mousemove', drawColor); window.addEventListener('mouseup', () => coloring = false); cCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); coloring = true; cCtx.beginPath(); cCtx.moveTo(e.touches[0].clientX, e.touches[0].clientY); }); cCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); drawColor(e); }); window.addEventListener('touchend', () => coloring = false);
        function clearColoring() { cCtx.clearRect(0,0,cCanvas.width, cCanvas.height); document.getElementById('generated-coloring-image').style.display = 'none'; interactionMode = 'COLORING_INPUT'; document.getElementById('status').innerText = "Une autre id√©e ?"; speechQueue.push("D'accord, on change !"); parler(); }
        async function genererColoriage(sujet) { const encoded = encodeURIComponent(`coloring page for kids, simple line art, black and white, white background, high contrast, ${sujet}`); const url = `https://image.pollinations.ai/prompt/${encoded}?width=1024&height=1024&nologo=true&seed=${Math.floor(Math.random()*9999)}`; const img = document.getElementById('generated-coloring-image'); img.onload = () => { document.getElementById('ai-thinking').classList.add('hidden'); document.getElementById('status').innerText = "√Ä tes crayons !"; img.style.display = 'block'; speechQueue.push("Et voil√† ton coloriage !"); parler(); }; img.src = url; }

        /* ---------------- LOGIQUE MODE (FASHION) ---------------- */
        function initFashion() { 
            document.getElementById('fashion-mannequin-base').src = "data:image/svg+xml;base64," + btoa(MANNEQUINS[currentMannequinIndex]);
            const wardrobe = document.getElementById('wardrobe-list');
            wardrobe.innerHTML = '';
            WARDROBE_ITEMS.forEach(item => {
                const div = document.createElement('div');
                div.className = 'wardrobe-item';
                const imgBase64 = "data:image/svg+xml;base64," + btoa(item.svg);
                div.innerHTML = `<img src="${imgBase64}">`;
                div.onclick = () => {
                    playPopSound();
                    document.querySelectorAll('.wardrobe-item').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                    wearItem(item);
                };
                wardrobe.appendChild(div);
            });
        }
        function changerMannequin() { currentMannequinIndex = (currentMannequinIndex + 1) % MANNEQUINS.length; document.getElementById('fashion-mannequin-base').src = "data:image/svg+xml;base64," + btoa(MANNEQUINS[currentMannequinIndex]); }
        function wearItem(item) { 
            let targetId = '';
            if (item.type === 'top') targetId = 'fashion-wear-top';
            else if (item.type === 'bottom') targetId = 'fashion-wear-bottom';
            else if (item.type === 'full') { targetId = 'fashion-wear-full'; }
            else if (item.type === 'shoes') targetId = 'fashion-wear-shoes';
            else if (item.type === 'hat') targetId = 'fashion-wear-hat';

            const imgEl = document.getElementById(targetId);
            
            if (item.type === 'full') {
                document.getElementById('fashion-wear-top').style.opacity = 0;
                document.getElementById('fashion-wear-bottom').style.opacity = 0;
                imgEl.src = "data:image/svg+xml;base64," + btoa(item.svg);
                imgEl.style.opacity = 1;
            } 
            else if (item.type === 'top' || item.type === 'bottom') {
                document.getElementById('fashion-wear-full').style.opacity = 0;
                imgEl.src = "data:image/svg+xml;base64," + btoa(item.svg);
                imgEl.style.opacity = 1;
            }
            else {
                imgEl.src = "data:image/svg+xml;base64," + btoa(item.svg);
                imgEl.style.opacity = 1;
            }
        }
        function resetOutfit() { 
            ['fashion-wear-top', 'fashion-wear-bottom', 'fashion-wear-full', 'fashion-wear-shoes', 'fashion-wear-hat'].forEach(id => { document.getElementById(id).style.opacity = 0; });
            document.querySelectorAll('.wardrobe-item').forEach(el => el.classList.remove('selected'));
        }

        /* ---------------- LOGIQUE JEUX (GAME ENGINE) ---------------- */
        const gCanvas = document.getElementById('game-canvas'); const gCtx = gCanvas.getContext('2d');
        let gameLoopId = null; let gameActive = false; let gameScore = 0;
        
        let globalAudioCtx = null;
        function getAudio() { if (!globalAudioCtx) globalAudioCtx = new (window.AudioContext || window.webkitAudioContext)(); if(globalAudioCtx.state==='suspended') globalAudioCtx.resume(); return globalAudioCtx; }
        function playPopSound() { try { const ctx=getAudio(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.frequency.setValueAtTime(400,ctx.currentTime); o.frequency.linearRampToValueAtTime(800,ctx.currentTime+0.1); g.gain.setValueAtTime(0.1,ctx.currentTime); g.gain.linearRampToValueAtTime(0,ctx.currentTime+0.1); o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.1); } catch(e){} }

        class GameEngine {
            constructor() { this.type = ''; this.ball = {}; this.goalie = {}; this.goal = {}; this.marbles = []; this.arena = {}; }
            start(type) {
                gameActive = true; this.type = type; gameScore = 0;
                document.getElementById('score-val').innerText = "0";
                gCanvas.width = window.innerWidth; gCanvas.height = window.innerHeight;
                if(type === 'FOOTBALL') this.initFootball();
                else this.initMarbles();
                this.loop();
            }
            initFootball() {
                this.ball = {x:gCanvas.width/2, y:gCanvas.height-150, r:20, vx:0, vy:0};
                this.goalie = {x:gCanvas.width/2, y:150, dir:2};
                this.goal = {x:gCanvas.width/2-100, y:50, w:200, h:100};
            }
            initMarbles() {
                this.ball = {x:gCanvas.width/2, y:gCanvas.height-150, r:15, vx:0, vy:0, color:'white'};
                this.marbles = [];
                for(let i=0; i<6; i++) this.marbles.push({x:gCanvas.width/2+(Math.random()-0.5)*200, y:gCanvas.height/2+(Math.random()-0.5)*200, r:15, color:'#ef4444', vx:0, vy:0});
                this.arena = {x:gCanvas.width/2, y:gCanvas.height/2, r:300};
            }
            update() {
                if(this.type === 'FOOTBALL') {
                    this.goalie.x += this.goalie.dir;
                    if(this.goalie.x > this.goal.x+this.goal.w || this.goalie.x < this.goal.x) this.goalie.dir *= -1;
                    this.ball.x += this.ball.vx; this.ball.y += this.ball.vy;
                    this.ball.vx *= 0.98; this.ball.vy *= 0.98;
                    // Goal?
                    if(this.ball.y < this.goal.y+this.goal.h && this.ball.x > this.goal.x && this.ball.x < this.goal.x+this.goal.w) {
                         if(Math.abs(this.ball.x-this.goalie.x)<30 && Math.abs(this.ball.y-this.goalie.y)<30) {
                             this.ball.vy *= -1; playPopSound(); // Save
                         } else if(this.ball.y < this.goal.y+10) {
                             gameScore++; document.getElementById('score-val').innerText = gameScore;
                             this.ball.x = gCanvas.width/2; this.ball.y = gCanvas.height-150; this.ball.vx=0; this.ball.vy=0;
                             speechQueue.push("But !"); parler();
                         }
                    }
                    if(this.ball.x<0 || this.ball.x>gCanvas.width) this.ball.vx*=-1;
                    if(this.ball.y<0) this.ball.vy*=-1;
                    if(this.ball.y>gCanvas.height) { this.ball.x = gCanvas.width/2; this.ball.y = gCanvas.height-150; this.ball.vx=0; this.ball.vy=0; }
                } else {
                    this.ball.x+=this.ball.vx; this.ball.y+=this.ball.vy;
                    this.ball.vx*=0.98; this.ball.vy*=0.98;
                    if(this.ball.x<0||this.ball.x>gCanvas.width) this.ball.vx*=-1;
                    if(this.ball.y<0||this.ball.y>gCanvas.height) this.ball.vy*=-1;
                    
                    for(let i=this.marbles.length-1; i>=0; i--) {
                        let m = this.marbles[i];
                        let dx = m.x - this.ball.x; let dy = m.y - this.ball.y;
                        let d = Math.sqrt(dx*dx+dy*dy);
                        if(d < m.r + this.ball.r) {
                             let angle = Math.atan2(dy, dx);
                             m.vx = Math.cos(angle)*10; m.vy = Math.sin(angle)*10;
                             this.ball.vx = -Math.cos(angle)*5; this.ball.vy = -Math.sin(angle)*5;
                             playPopSound();
                        }
                        m.x += m.vx; m.y += m.vy; m.vx*=0.95; m.vy*=0.95;
                        if(Math.sqrt((m.x-this.arena.x)**2 + (m.y-this.arena.y)**2) > this.arena.r) {
                            this.marbles.splice(i, 1);
                            gameScore++; document.getElementById('score-val').innerText = gameScore;
                        }
                    }
                }
            }
            draw() {
                gCtx.clearRect(0,0,gCanvas.width,gCanvas.height);
                if(this.type === 'FOOTBALL') {
                    gCtx.strokeStyle='white'; gCtx.lineWidth=4; gCtx.strokeRect(this.goal.x, this.goal.y, this.goal.w, this.goal.h);
                    gCtx.fillStyle='#ef4444'; gCtx.beginPath(); gCtx.arc(this.goalie.x, this.goalie.y, 20, 0, Math.PI*2); gCtx.fill();
                    gCtx.fillStyle='white'; gCtx.beginPath(); gCtx.arc(this.ball.x, this.ball.y, this.ball.r, 0, Math.PI*2); gCtx.fill();
                } else {
                    gCtx.strokeStyle='rgba(255,255,255,0.2)'; gCtx.lineWidth=5; gCtx.beginPath(); gCtx.arc(this.arena.x, this.arena.y, this.arena.r, 0, Math.PI*2); gCtx.stroke();
                    gCtx.fillStyle='white'; gCtx.beginPath(); gCtx.arc(this.ball.x, this.ball.y, this.ball.r, 0, Math.PI*2); gCtx.fill();
                    this.marbles.forEach(m => { gCtx.fillStyle=m.color; gCtx.beginPath(); gCtx.arc(m.x, m.y, m.r, 0, Math.PI*2); gCtx.fill(); });
                }
            }
            loop() {
                if(!gameActive) return;
                this.update(); this.draw();
                gameLoopId = requestAnimationFrame(() => this.loop());
            }
        }
        const game = new GameEngine();
        
        let startX=0, startY=0;
        gCanvas.addEventListener('touchstart', e => { e.preventDefault(); startX=e.touches[0].clientX; startY=e.touches[0].clientY; }, {passive:false});
        gCanvas.addEventListener('touchend', e => { 
            e.preventDefault(); 
            let dx = e.changedTouches[0].clientX - startX; let dy = e.changedTouches[0].clientY - startY;
            if(game.type === 'FOOTBALL') { game.ball.vx = dx*0.1; game.ball.vy = dy*0.1; }
            else { game.ball.vx = dx*0.1; game.ball.vy = dy*0.1; }
        }, {passive:false});

        function launchGame(type) {
            document.getElementById('game-selector-ui').style.display = 'none';
            document.getElementById('game-score-overlay').style.display = 'block';
            game.start(type);
        }

        /* ---------------- GESTION GLOBALE ---------------- */
        function returnToMenu() {
            stopAudio();
            gameActive = false; // Stop Game Loop
            if(gameLoopId) cancelAnimationFrame(gameLoopId);
            
            // Masquer tous les layers
            document.getElementById('slate-layer').style.display = 'none';
            document.getElementById('coloring-layer').style.display = 'none';
            document.getElementById('fashion-layer').style.display = 'none';
            document.getElementById('game-layer').style.display = 'none';
            
            // Revenir vue intro
            document.getElementById('main-interface').classList.remove('content-visible');
            document.getElementById('intro-overlay').style.display = 'flex';
            document.getElementById('spotify-container').classList.remove('active');
            document.getElementById('spotify-frame').src = "";
            
            setTimeout(() => { document.getElementById('intro-overlay').classList.remove('intro-fade-out'); }, 50);
        }

        function selectMode(mode) {
            currentAppMode = mode;
            if (mode === 'CHAT') chatHistory = [];
            
            // Masquer Menu
            document.getElementById('intro-overlay').classList.add('intro-fade-out');
            
            setTimeout(() => {
                document.getElementById('intro-overlay').style.display = 'none';
                
                // Mode Visuel ?
                if (mode === 'DRAW') {
                    document.getElementById('slate-layer').style.display = 'block'; initSlate();
                } else if (mode === 'COLORING') {
                    document.getElementById('coloring-layer').style.display = 'block'; 
                    document.getElementById('coloring-layer').style.zIndex = "40"; 
                    initColoring(); lancerColoriageAleatoire();
                } else if (mode === 'FASHION') {
                    document.getElementById('fashion-layer').style.display = 'block'; 
                    document.getElementById('fashion-layer').style.zIndex = "40"; 
                    initFashion(); speechQueue.push("Bienvenue au studio de mode !"); parler();
                } else if (mode === 'GAME') {
                    document.getElementById('game-layer').style.display = 'block'; 
                    document.getElementById('game-selector-ui').style.display = 'flex';
                    document.getElementById('game-score-overlay').style.display = 'none';
                    speechQueue.push("√Ä toi de jouer !"); parler();
                } else {
                    // Mode Vocal (Standard)
                    document.getElementById('main-interface').classList.add('content-visible');
                    
                    // Cleanup old logos
                    document.querySelectorAll('.logo-container svg').forEach(el => el.classList.add('hidden'));
                    
                    // Show correct logo
                    /* Note: J'ai simplifi√© le HTML pour n'avoir qu'un logo g√©n√©rique IA ou recr√©er les SVG si besoin, 
                       mais ici je garde l'interface propre */
                    document.getElementById('logo-ia').classList.remove('hidden');

                    if (userColor) applyMixedTheme(userColor);
                    startInteractionSequence();
                }
            }, 800);
        }

        // --- PARTIES COMMUNES (IA, MIC, ETC) ---
        function applyMixedTheme(inputText) { const themes = { 'bleu': {bg:['#eff6ff','#dbeafe','#bfdbfe','#93c5fd'], accent:'#2563eb'}, 'rose': {bg:['#fff1f2','#ffe4e6','#fecdd3','#fda4af'], accent:'#db2777'} }; /* Simplifi√© pour stabilit√© */ }
        
        function traiterInput(texte) {
            if (!texte.trim()) return;
            stopAudio(); document.getElementById('manualInput').value = "";
            const lower = texte.toLowerCase();

            if (interactionMode === 'GENDER_INPUT') {
                if (lower.includes('fille')) { userGenre = 'fille'; next(); } else { userGenre = 'gar√ßon'; next(); }
                function next() { localStorage.setItem('BOITE_GENRE', userGenre); interactionMode = 'NAME_INPUT'; document.getElementById('status').innerText = "Ton pr√©nom ?"; speechQueue.push("Et comment t'appelles-tu ?"); parler(); }
            } else if (interactionMode === 'NAME_INPUT') {
                userPrenom = texte; localStorage.setItem('BOITE_PRENOM', userPrenom);
                interactionMode = 'AGE_INPUT'; document.getElementById('status').innerText = "Ton √¢ge ?"; speechQueue.push(`Enchant√©e ${userPrenom}. Quel √¢ge as-tu ?`); parler();
            } else if (interactionMode === 'AGE_INPUT') {
                userAge = texte; localStorage.setItem('BOITE_AGE', userAge);
                startInteractionSequence();
            } else if (interactionMode === 'STORY_INPUT') { appelIA(texte, 'STORY'); }
            else if (interactionMode === 'QUESTION_INPUT') { appelIA(texte, 'QUESTION'); }
            else if (interactionMode === 'CHAT_INPUT') { appelIA(texte, 'CHAT'); }
            else if (interactionMode === 'MUSIC_INPUT') { appelIA(texte, 'MUSIC'); }
            else if (interactionMode === 'COLORING_INPUT') { 
                document.getElementById('main-interface').classList.remove('content-visible'); // Hide mic
                document.getElementById('coloring-layer').style.display = 'block';
                genererColoriage(texte); 
            }
        }

        async function appelIA(sujet, mode) {
            if (!GEMINI_KEY) { verifierCles(); return; }
            const btn = document.getElementById('btn-mic');
            btn.classList.add('mic-listening');
            document.getElementById('ai-thinking').classList.remove('hidden');
            document.getElementById('status').innerText = "Je r√©fl√©chis...";
            
            const url = `https://generativelanguage.googleapis.com/v1beta/${MODEL_ID}:streamGenerateContent?alt=sse&key=${GEMINI_KEY}`;
            let prompt = "";
            if(mode === 'STORY') prompt = `Raconte une histoire courte pour enfant sur : ${sujet}`;
            else if(mode === 'QUESTION') prompt = `Explique simplement √† un enfant : ${sujet}`;
            else if(mode === 'CHAT') prompt = `Tu es un ami virtuel. R√©ponds √† : ${sujet}`;
            else if(mode === 'MUSIC') prompt = `Choisis une playlist Spotify pour : ${sujet}. R√©ponds juste le mot cl√© (POP, DISNEY, CALME).`;

            try {
                const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const reader = response.body.getReader(); const decoder = new TextDecoder();
                let fullText = "";
                while(true) {
                    const {done, value} = await reader.read();
                    if(done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split("\n");
                    for(const line of lines) {
                        if(line.startsWith("data: ")) {
                            try {
                                const json = JSON.parse(line.substring(6));
                                const txt = json.candidates[0].content.parts[0].text;
                                fullText += txt;
                            } catch(e){}
                        }
                    }
                }
                
                document.getElementById('ai-thinking').classList.add('hidden');
                btn.classList.remove('mic-listening');
                
                if (mode === 'MUSIC') {
                    // Logic Musique
                    playSpotify('POP'); // Par d√©faut pour d√©mo, √† am√©liorer avec le vrai parsing
                } else {
                    speechQueue.push(fullText); parler();
                }

            } catch(e) {
                console.error(e);
                document.getElementById('status').innerText = "Erreur...";
            }
        }

        async function textToSpeechAzure(text) {
             const url = `https://${AZURE_REGION}.tts.speech.microsoft.com/cognitiveservices/v1`;
            const ssml = `<speak version='1.0' xml:lang='fr-FR'><voice xml:lang='fr-FR' xml:gender='Female' name='${AZURE_VOICE_NAME}'><prosody rate="0.9">${text}</prosody></voice></speak>`;
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Ocp-Apim-Subscription-Key': AZURE_KEY, 'Content-Type': 'application/ssml+xml', 'X-Microsoft-OutputFormat': 'audio-16khz-128kbitrate-mono-mp3' }, body: ssml });
                if (!response.ok) throw new Error("Erreur Azure"); return await response.blob();
            } catch (e) { return null; }
        }

        let speechQueue = []; let isSpeaking = false; let currentAudio = null;
        async function parler() {
            if(isSpeaking || speechQueue.length === 0) return;
            isSpeaking = true;
            const txt = speechQueue.shift();
            const blob = await textToSpeechAzure(txt);
            if(blob) {
                currentAudio = new Audio(URL.createObjectURL(blob));
                currentAudio.onended = () => { isSpeaking = false; parler(); };
                currentAudio.play();
            } else {
                const u = new SpeechSynthesisUtterance(txt);
                u.lang = 'fr-FR';
                u.onend = () => { isSpeaking = false; parler(); };
                window.speechSynthesis.speak(u);
            }
        }
        
        function verifierCles() { if (!GEMINI_KEY) { const k = prompt("Cl√© Google :"); if (k) { localStorage.setItem('BOITE_GEMINI_KEY', k); GEMINI_KEY = k; } } if (!AZURE_KEY) { const k = prompt("Cl√© Azure :"); const r = prompt("R√©gion Azure :"); if (k) { localStorage.setItem('BOITE_AZURE_KEY', k); localStorage.setItem('BOITE_AZURE_REGION', r); AZURE_KEY = k; AZURE_REGION = r; } } }
        function oublierTout() { localStorage.clear(); location.reload(); }
        
        document.addEventListener('DOMContentLoaded', () => {
             if(!GEMINI_KEY) verifierCles();
             document.getElementById('btn-mic').onclick = startListening;
             document.getElementById('btn-stop').onclick = stopAudio;
        });
    </script>
</body>
</html>