<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>La BoÃ®te Magique âœ¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Short+Stack&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Short Stack', cursive; background: #fffdf2; touch-action: manipulation; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-6">

    <header class="text-center my-6">
        <h1 class="text-4xl font-bold text-amber-600">Ma BoÃ®te Magique âš¡</h1>
        <p id="status" class="text-amber-800 mt-2 italic">PrÃªt pour une grande aventure !</p>
    </header>

    <div id="image-box" class="w-full max-w-md aspect-video bg-white rounded-[2rem] shadow-2xl overflow-hidden mb-6 hidden">
        <img id="story-img" src="" class="w-full h-full object-cover">
    </div>

    <div class="w-full max-w-md flex flex-col items-center gap-6">
        <div class="w-full flex gap-2 bg-amber-100 p-2 rounded-2xl border border-amber-200">
            <input type="text" id="manualInput" placeholder="Ton sujet..." 
                   class="flex-1 bg-white p-4 rounded-xl outline-none shadow-inner">
            <button id="btn-ok" class="bg-amber-500 text-white px-6 py-4 rounded-xl font-bold shadow-md">OK</button>
        </div>
        <button id="mic-btn" class="bg-amber-400 p-8 rounded-full shadow-xl border-4 border-white text-4xl">ğŸ¤</button>
    </div>

    <div id="story-card" class="bg-white w-full max-w-md rounded-[2.5rem] shadow-xl p-8 mt-8 hidden">
        <div id="audio-controls" class="flex justify-center gap-2 mb-4 hidden">
            <button onclick="toggleAudio()" id="btn-pause" class="bg-amber-100 text-amber-700 px-4 py-2 rounded-full text-xs font-bold">â¸ Pause</button>
            <button onclick="stopAudio()" class="bg-red-100 text-red-700 px-4 py-2 rounded-full text-xs font-bold">Stop</button>
            <button onclick="telechargerPDF()" class="bg-blue-600 text-white px-4 py-2 rounded-full text-xs font-bold">ğŸ’¾ PDF</button>
        </div>
        <div id="story-text" class="text-lg leading-relaxed text-gray-800 italic whitespace-pre-line"></div>
    </div>

    <script>
        // RÃ‰CUPÃ‰RATION CLÃ‰
        const API_KEY = localStorage.getItem('BOITE_FINAL_KEY_2026');
        const synth = window.speechSynthesis;
        let dernierTitre = "";

        // Ã‰COUTEURS D'Ã‰VÃ‰NEMENTS (Plus stables que le onclick HTML)
        document.getElementById('btn-ok').addEventListener('click', () => {
            const val = document.getElementById('manualInput').value.trim();
            if(val) {
                activerVoix(); // DÃ©bloque la voix sur mobile
                appelIA(val);
            }
        });

        document.getElementById('mic-btn').addEventListener('click', () => {
            activerVoix();
            lancerMicro();
        });

        function activerVoix() {
            // Astuce technique : on joue un silence pour dÃ©bloquer l'audio
            const u = new SpeechSynthesisUtterance("");
            synth.speak(u);
        }

        async function appelIA(sujet) {
            if(!API_KEY) return alert("ClÃ© API manquante dans le localStorage.");
            
            dernierTitre = sujet;
            stopAudio();
            
            const status = document.getElementById('status');
            const storyText = document.getElementById('story-text');
            const storyCard = document.getElementById('story-card');
            
            status.innerText = "L'IA rÃ©flÃ©chit longuement...";
            storyText.innerText = ""; 
            storyCard.classList.remove('hidden');
            document.getElementById('audio-controls').classList.add('hidden');
            document.getElementById('image-box').classList.remove('hidden');
            document.getElementById('story-img').src = `https://image.pollinations.ai/prompt/fairytale_illustration_${encodeURIComponent(sujet)}?nologo=true`;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:streamGenerateContent?alt=sse&key=${API_KEY}`;
            
            const body = {
                contents: [{ parts: [{ text: `Raconte une trÃ¨s longue histoire pour enfant sur : ${sujet}. DÃ©taille chaque scÃ¨ne, utilise des dialogues. Structure l'histoire en 8 paragraphes minimum.` }] }],
                generationConfig: { temperature: 0.8, maxOutputTokens: 4000 }
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let fullText = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split("\n");
                    
                    for (const line of lines) {
                        if (line.startsWith("data: ")) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                // Chemin robuste vers le texte
                                const chunkText = data.candidates[0].content.parts[0].text;
                                if(chunkText) {
                                    fullText += chunkText;
                                    storyText.innerText = fullText;
                                    storyCard.scrollTop = storyCard.scrollHeight;
                                }
                            } catch(e) {}
                        }
                    }
                }

                status.innerText = "Lecture en cours...";
                document.getElementById('audio-controls').classList.remove('hidden');
                lireHistoire(fullText);

            } catch (e) {
                status.innerText = "Erreur magique.";
                console.error(e);
            }
        }

        function lireHistoire(texte) {
            synth.cancel();
            const speech = new SpeechSynthesisUtterance(texte);
            speech.lang = 'fr-FR';
            speech.rate = 1.0;
            speech.pitch = 1.1; // Voix un peu plus fÃ©erique
            synth.speak(speech);
        }

        function toggleAudio() {
            if (synth.paused) { synth.resume(); document.getElementById('btn-pause').innerText = "â¸ Pause"; }
            else { synth.pause(); document.getElementById('btn-pause').innerText = "â–¶ï¸ Reprendre"; }
        }

        function stopAudio() { synth.cancel(); }

        function telechargerPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const lines = doc.splitTextToSize(document.getElementById('story-text').innerText, 170);
            doc.text(lines, 20, 20);
            doc.save("mon-histoire.pdf");
        }

        function lancerMicro() {
            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!Speech) return alert("Micro non supportÃ©.");
            const rec = new Speech();
            rec.lang = 'fr-FR';
            rec.onresult = (e) => {
                document.getElementById('manualInput').value = e.results[0][0].transcript;
                appelIA(e.results[0][0].transcript);
            };
            rec.start();
        }
    </script>
</body>
</html>