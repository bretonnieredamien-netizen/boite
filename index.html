async function appelIA(sujet) {
    stopAudio();
    document.getElementById('status').innerText = "La magie opère longuement...";
    document.getElementById('story-text').innerText = ""; 
    document.getElementById('story-card').classList.remove('hidden');
    document.getElementById('audio-controls').classList.add('hidden'); 
    
    document.getElementById('image-box').classList.remove('hidden');
    document.getElementById('story-img').src = `https://image.pollinations.ai/prompt/fairytale_illustration_pastel_${encodeURIComponent(sujet)}?nologo=true`;

    const url = `https://generativelanguage.googleapis.com/v1beta/${MODEL_ID}:streamGenerateContent?alt=sse&key=${API_KEY}`;
    
    // CONSIGNE AMÉLIORÉE POUR LA LONGUEUR
    const consigne = `Raconte une TRÈS longue et captivante aventure pour enfant sur : "${sujet}". 
    L'histoire doit être divisée en 8 à 10 paragraphes détaillés.
    Structure : 
    1. Introduction immersive du décor et du héros.
    2. Un événement perturbateur inattendu.
    3. Trois péripéties distinctes avec des dialogues et des descriptions sensorielles (odeurs, sons, couleurs).
    4. Un moment de doute ou de grand défi.
    5. Une résolution héroïque.
    6. Une conclusion morale et douce.
    Prends ton temps pour décrire chaque émotion.`;

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: consigne }] }],
                generationConfig: { 
                    temperature: 0.9, // Augmenté pour plus de détails descriptifs
                    maxOutputTokens: 4000, // Doublé pour permettre une longueur maximale
                    topP: 0.95
                }
            })
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let fullText = "";

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split("\n");
            
            for (const line of lines) {
                if (line.startsWith("data: ")) {
                    try {
                        const json = JSON.parse(line.substring(6));
                        const textChunk = json.candidates[0].content.parts[0].text;
                        fullText += textChunk;
                        document.getElementById('story-text').innerText = fullText;
                        document.getElementById('story-card').scrollTop = document.getElementById('story-card').scrollHeight;
                    } catch(e) {}
                }
            }
        }

        document.getElementById('audio-controls').classList.remove('hidden');
        document.getElementById('status').innerText = "Écoute ta grande aventure...";
        lireHistoire(fullText);

    } catch (e) { alert("Petit souci technique magique."); }
}