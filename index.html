<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ta boite magique ‚ú®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;500;800;900&display=swap" rel="stylesheet">
    <style>
        /* Fond Moderne Anim√© */
        body { 
            font-family: 'Lexend', sans-serif; 
            background: linear-gradient(-45deg, #fff7ed, #fef9c3, #ede9fe, #fae8ff);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            touch-action: manipulation; 
            overflow-x: hidden;
            min-height: 100vh;
            margin: 0;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- Poussi√®re d'√©toiles (Canvas) --- */
        #starfield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .hidden { display: none !important; }
        .content-layer { position: relative; z-index: 10; width: 100%; display: flex; flex-direction: column; align-items: center; }

        /* --- LOGO --- */
        .brand-header { position: absolute; top: 1.5rem; left: 1.5rem; display: flex; align-items: center; gap: 0.5rem; z-index: 20; }
        .mini-logo-text { font-weight: 900; font-size: 1.2rem; background: linear-gradient(135deg, #22d3ee, #818cf8, #c084fc, #34d399); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-transform: lowercase; }
        
        .logo-container { width: 220px; height: 220px; display: flex; justify-content: center; align-items: center; opacity: 0; animation: introFade 2s ease-out forwards, slowBeat 5s ease-in-out infinite 2s; filter: drop-shadow(0 10px 25px rgba(129, 140, 248, 0.5)); }
        @keyframes introFade { 0% { opacity: 0; transform: translateY(15px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes slowBeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.04); } }

        /* --- ORBES --- */
        .orbe-base { position: relative; width: 120px; height: 120px; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(15px); border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.8); display: flex; align-items: center; justify-content: center; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .orbe-base svg { width: 45px; height: 45px; fill: #6366f1; }
        .mic-listening { background: rgba(99, 102, 241, 0.15) !important; box-shadow: 0 0 50px rgba(99, 102, 241, 0.6) !important; transform: scale(1.1); }
        #btn-stop svg { fill: #f87171; }
        #stop-container.opacity-100 #btn-stop { background: rgba(248, 113, 113, 0.15); border-color: #f87171; box-shadow: 0 0 30px rgba(248, 113, 113, 0.4); }

        /* --- UI --- */
        .status-box { background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); padding: 0.6rem 1.8rem; border-radius: 9999px; border: 1px solid rgba(255, 255, 255, 0.5); margin-top: 1rem; }
        .understood-flash { animation: success-pulse 0.8s ease-out !important; background: rgba(16, 185, 129, 0.2) !important; border-color: #10b981 !important; }
        @keyframes success-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); box-shadow: 0 0 60px #10b981; } 100% { transform: scale(1); } }
        .glass-ui { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); border: 1px solid white; }

        /* --- THEATRE MAGIQUE (SC√àNE ANIM√âE) --- */
        #story-card { padding: 1.5rem !important; transition: all 0.5s ease; }
        .magic-stage { width: 100%; aspect-ratio: 1 / 1; border-radius: 2rem; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #e0e7ff 0%, #fae8ff 100%); transition: background 1s ease; }
        .stage-glow { position: absolute; width: 70%; height: 70%; background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%); border-radius: 50%; animation: pulseGlow 4s infinite alternate; }
        .hero-emoji { font-size: 8rem; z-index: 10; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.15)); animation: floatHero 6s ease-in-out infinite; transform-origin: center bottom; }
        @keyframes floatHero { 0%, 100% { transform: translateY(0) scale(1) rotate(-2deg); } 50% { transform: translateY(-20px) scale(1.1) rotate(2deg); } }
        @keyframes pulseGlow { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(1.2); opacity: 0.8; } }
        .pop-in { animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

    </style>
</head>
<body class="p-6">

    <canvas id="starfield"></canvas>

    <div class="content-layer min-h-screen">
        
        <div class="brand-header">
            <span class="mini-logo-text">tbm.</span>
        </div>

        <header class="text-center flex flex-col items-center mt-6">
            <div class="logo-container">
                <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="auroraFill" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#22d3ee;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#818cf8;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#c084fc;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="lightBeam" x1="0.5" y1="1" x2="0.5" y2="0">
                             <stop offset="0%" stop-color="#fff" stop-opacity="0.6"/>
                             <stop offset="100%" stop-color="#fff" stop-opacity="0"/>
                        </linearGradient>
                    </defs>
                    <path d="M70 80 L50 20 L90 20 Z" fill="url(#lightBeam)" opacity="0.6"/>
                    <path d="M100 85 L100 10 L120 10 Z" fill="url(#lightBeam)" opacity="0.8"/>
                    <path d="M130 80 L150 20 L110 20 Z" fill="url(#lightBeam)" opacity="0.6"/>
                    <path d="M50 80 L150 80 L140 160 L60 160 Z" fill="url(#auroraFill)" stroke="white" stroke-width="3" stroke-linejoin="round"/>
                    <path d="M50 80 L20 60 L60 60 L80 80 Z" fill="#818cf8" stroke="white" stroke-width="2" opacity="0.9"/>
                    <path d="M150 80 L180 60 L140 60 L120 80 Z" fill="#c084fc" stroke="white" stroke-width="2" opacity="0.9"/>
                    <path d="M60 80 L140 80 L120 60 L80 60 Z" fill="#34d399" opacity="0.7"/>
                    <path d="M50 80 L150 80 L170 100 L30 100 Z" fill="url(#auroraFill)" stroke="white" stroke-width="2" opacity="0.8"/>
                    <circle cx="100" cy="50" r="5" fill="#fff" filter="drop-shadow(0 0 5px #fff)"><animate attributeName="opacity" values="0;1;0" dur="2s" repeatCount="indefinite"/></circle>
                    <circle cx="60" cy="40" r="3" fill="#22d3ee"><animate attributeName="cy" values="40;30;40" dur="3s" repeatCount="indefinite"/></circle>
                    <circle cx="140" cy="45" r="4" fill="#c084fc"><animate attributeName="cy" values="45;35;45" dur="2.5s" repeatCount="indefinite"/></circle>
                    <path d="M100 30 L103 40 L113 40 L105 48 L108 58 L100 52 L92 58 L95 48 L87 40 L97 40 Z" fill="#fef08a" filter="drop-shadow(0 0 8px #fbbf24)"><animateTransform attributeName="transform" type="scale" values="1;1.2;1" dur="1.5s" repeatCount="indefinite" additive="sum" transform-origin="100 45"/><animateTransform attributeName="transform" type="rotate" values="0 100 45; 360 100 45" dur="10s" repeatCount="indefinite" additive="sum"/></path>
                </svg>
            </div>
            <div class="status-box">
                <p id="status" class="text-indigo-900/60 font-semibold italic text-sm">Dis-moi ton id√©e pour une histoire...</p>
            </div>
        </header>

        <main class="w-full max-w-md flex flex-col items-center gap-14 mt-8">
            <div class="flex items-center justify-center gap-12 w-full">
                <div class="flex flex-col items-center gap-4">
                    <button id="btn-mic" class="orbe-base shadow-2xl">
                        <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                    </button>
                    <span class="text-indigo-900/40 text-[11px] font-bold uppercase tracking-widest">√âcouter</span>
                </div>
                <div id="stop-container" class="flex flex-col items-center gap-4 opacity-20 pointer-events-none transition-all duration-500">
                    <button id="btn-stop" class="orbe-base shadow-xl">
                        <svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="2" /></svg>
                    </button>
                    <span class="text-red-900/40 text-[11px] font-bold uppercase tracking-widest">Arr√™ter</span>
                </div>
            </div>

            <div id="keyboard-area" class="w-full flex gap-2 glass-ui p-2 rounded-2xl shadow-xl hidden">
                <input type="text" id="manualInput" placeholder="Sujet de l'aventure..." class="flex-1 bg-white/40 p-4 rounded-xl outline-none text-sm font-medium">
                <button id="btn-ok" class="bg-indigo-500 text-white px-7 py-4 rounded-xl font-bold active:scale-95 shadow-md">OK</button>
            </div>

            <button id="toggle-input" class="p-4 rounded-full shadow-sm active:scale-90 opacity-40 hover:opacity-100 transition-opacity">
                <span class="text-2xl">‚å®Ô∏è</span>
            </button>

            <div id="story-card" class="bg-white/95 w-full rounded-[3rem] shadow-2xl border-4 border-white hidden">
                <div class="magic-stage" id="magic-stage">
                    <div class="stage-glow"></div>
                    <div id="hero-emoji" class="hero-emoji pop-in">‚ú®</div>
                </div>
            </div>

        </main>

        <footer class="mt-auto py-10">
            <button onclick="reinitialiserCle()" class="text-gray-400 text-[10px] uppercase underline tracking-widest opacity-30">R√©initialiser la cl√© API</button>
        </footer>

    </div>

    <script>
        /* --- CANVAS STARS --- */
        const canvas = document.getElementById('starfield'); const ctx = canvas.getContext('2d'); let particles = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        class Particle { constructor() { this.reset(); } reset() { this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height; this.size = Math.random() * 2 + 0.5; this.speed = Math.random() * 0.02 + 0.01; this.opacity = Math.random() * 0.8; this.color = Math.random() > 0.5 ? "251, 191, 36" : "129, 140, 248"; } update() { this.y -= this.speed; this.x += Math.sin(this.y * 0.01) * 0.2; if (this.y < 0) this.reset(); } draw() { ctx.fillStyle = `rgba(${this.color}, ${this.opacity})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); } }
        function initParticles() { particles = []; for (let i = 0; i < 100; i++) particles.push(new Particle()); }
        function animate() { ctx.clearRect(0, 0, canvas.width, canvas.height); particles.forEach(p => { p.update(); p.draw(); }); requestAnimationFrame(animate); }
        window.addEventListener('resize', resize); resize(); initParticles(); animate();

        /* --- APP LOGIC --- */
        let API_KEY = localStorage.getItem('BOITE_FINAL_KEY_2026');
        const MODEL_ID = "models/gemini-2.5-flash"; 
        const synth = window.speechSynthesis;
        let speechQueue = [];
        let isSpeaking = false;
        let bestVoice = null;
        let audioCtx = null;

        function playChime() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = 'triangle'; osc.frequency.setValueAtTime(1244.51, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(1567.98, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + 0.05); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.5);
        }

        // --- NOUVEAU SYST√àME DE VOIX AVANC√â ---
        function loadVoices() {
            const voices = synth.getVoices();
            // Liste de priorit√© pour les voix f√©minines / douces selon l'OS
            // 1. Amelie/Marie (Mac)
            // 2. Denise/Celeste (Windows)
            // 3. Google Fran√ßais (Android/Chrome)
            // 4. N'importe quelle voix 'fr-FR'
            
            const preferredNames = ["Amelie", "Marie", "Denise", "Celeste", "Hortense", "Google fran√ßais"];
            
            // Cherche d'abord une voix pr√©f√©r√©e
            bestVoice = voices.find(v => v.lang.includes('fr') && preferredNames.some(name => v.name.includes(name)));
            
            // Sinon, n'importe quelle voix Google
            if (!bestVoice) {
                bestVoice = voices.find(v => v.lang.includes('fr') && v.name.includes("Google"));
            }
            
            // Sinon, n'importe quelle voix FR
            if (!bestVoice) {
                bestVoice = voices.find(v => v.lang.includes('fr'));
            }
            
            console.log("Voix choisie :", bestVoice ? bestVoice.name : "Aucune");
        }
        
        // Charger les voix (parfois asynchrone)
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }
        loadVoices();

        function toggleStopButton(active) {
            const container = document.getElementById('stop-container');
            if (active) { container.classList.remove('opacity-20', 'pointer-events-none'); container.classList.add('opacity-100'); } else { container.classList.add('opacity-20', 'pointer-events-none'); container.classList.remove('opacity-100'); }
        }

        function stopAudio() {
            synth.cancel(); speechQueue = []; isSpeaking = false;
            document.getElementById('status').classList.remove('status-animating');
            toggleStopButton(false);
        }

        function setMagicScene(sujet) {
            const s = sujet.toLowerCase();
            const stage = document.getElementById('magic-stage');
            const hero = document.getElementById('hero-emoji');
            
            let emoji = "‚ú®";
            let gradient = "linear-gradient(135deg, #e0e7ff 0%, #fae8ff 100%)"; 

            if (s.includes('chat') || s.includes('chaton')) { emoji = "üê±"; gradient = "linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%)"; }
            else if (s.includes('chien') || s.includes('chiot')) { emoji = "üê∂"; gradient = "linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)"; }
            else if (s.includes('dragon')) { emoji = "üêâ"; gradient = "linear-gradient(135deg, #dcfce7 0%, #86efac 100%)"; }
            else if (s.includes('licorne')) { emoji = "ü¶Ñ"; gradient = "linear-gradient(135deg, #fce7f3 0%, #f9a8d4 100%)"; }
            else if (s.includes('dino') || s.includes('t-rex')) { emoji = "ü¶ñ"; gradient = "linear-gradient(135deg, #d1fae5 0%, #6ee7b7 100%)"; }
            else if (s.includes('lion')) { emoji = "ü¶Å"; gradient = "linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%)"; }
            else if (s.includes('ours')) { emoji = "üêª"; gradient = "linear-gradient(135deg, #fff7ed 0%, #fdba74 100%)"; }
            else if (s.includes('princesse') || s.includes('chateau')) { emoji = "üè∞"; gradient = "linear-gradient(135deg, #fbcfe8 0%, #f472b6 100%)"; }
            else if (s.includes('sorcier') || s.includes('magie')) { emoji = "üßô‚Äç‚ôÇÔ∏è"; gradient = "linear-gradient(135deg, #e9d5ff 0%, #c084fc 100%)"; }
            else if (s.includes('pirate') || s.includes('bateau')) { emoji = "üè¥‚Äç‚ò†Ô∏è"; gradient = "linear-gradient(135deg, #cffafe 0%, #67e8f9 100%)"; }
            else if (s.includes('chevalier')) { emoji = "‚öîÔ∏è"; gradient = "linear-gradient(135deg, #e5e7eb 0%, #9ca3af 100%)"; }
            else if (s.includes('f√©e')) { emoji = "üßö‚Äç‚ôÄÔ∏è"; gradient = "linear-gradient(135deg, #ccfbf1 0%, #5eead4 100%)"; }
            else if (s.includes('espace') || s.includes('lune') || s.includes('etoile')) { emoji = "üöÄ"; gradient = "linear-gradient(135deg, #312e81 0%, #4338ca 100%)"; stage.style.color = "white"; }
            else if (s.includes('mer') || s.includes('oc√©an') || s.includes('poisson')) { emoji = "üê†"; gradient = "linear-gradient(135deg, #bae6fd 0%, #38bdf8 100%)"; }
            else if (s.includes('foret') || s.includes('arbre')) { emoji = "üå≥"; gradient = "linear-gradient(135deg, #ecfccb 0%, #a3e635 100%)"; }
            else if (s.includes('voiture')) { emoji = "üèéÔ∏è"; gradient = "linear-gradient(135deg, #fee2e2 0%, #ef4444 100%)"; }
            else if (s.includes('train')) { emoji = "üöÇ"; gradient = "linear-gradient(135deg, #ffedd5 0%, #f97316 100%)"; }
            else if (s.includes('avion')) { emoji = "‚úàÔ∏è"; gradient = "linear-gradient(135deg, #e0f2fe 0%, #60a5fa 100%)"; }

            stage.style.background = gradient;
            hero.innerText = emoji;
            hero.classList.remove('pop-in');
            void hero.offsetWidth; 
            hero.classList.add('pop-in');
        }


        async function appelIA(sujet) {
            if (!API_KEY) return;
            stopAudio();
            const btnMic = document.getElementById('btn-mic');
            const statusLabel = document.getElementById('status');
            playChime();
            btnMic.classList.add('understood-flash');
            statusLabel.innerText = "Je tisse ton aventure...";
            statusLabel.classList.add('status-animating');
            
            setMagicScene(sujet);
            
            setTimeout(() => {
                btnMic.classList.remove('understood-flash');
                document.getElementById('story-card').classList.remove('hidden');
                toggleStopButton(true);
            }, 800);
            
            const url = `https://generativelanguage.googleapis.com/v1beta/${MODEL_ID}:streamGenerateContent?alt=sse&key=${API_KEY}`;
            // MODIFICATION DU PROMPT POUR L'AUDIO
            const promptIA = `Tu es une maman douce qui raconte une histoire. Raconte une aventure pour un enfant sur : "${sujet}". Utilise des phrases courtes. Fais des pauses. Pas de magie. Fin positive. Termine par "FIN".`;

            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: promptIA }] }] }) });
                const reader = response.body.getReader(); const decoder = new TextDecoder("utf-8"); let currentSentence = "";
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        statusLabel.classList.remove('status-animating'); statusLabel.innerText = "L'aventure est pr√™te !";
                        if (currentSentence.trim()) { speechQueue.push(currentSentence.trim()); parler(); }
                        break;
                    }
                    const chunk = decoder.decode(value); const lines = chunk.split("\n");
                    for (const line of lines) {
                        if (line.startsWith("data: ")) {
                            try {
                                const json = JSON.parse(line.substring(6));
                                const chunkText = json.candidates[0].content.parts[0].text;
                                currentSentence += chunkText;
                                // D√©coupage plus intelligent pour les pauses
                                if (/[.!?;:]/.test(chunkText) || chunkText.includes("\n")) {
                                    const parts = currentSentence.split(/([.!?;:]|\n)/);
                                    for (let i = 0; i < parts.length - 1; i += 2) { 
                                        const p = (parts[i] + (parts[i+1] || "")).trim(); 
                                        if (p.length > 1) { speechQueue.push(p); parler(); } 
                                    }
                                    currentSentence = parts[parts.length - 1];
                                }
                            } catch(e) {}
                        }
                    }
                }
            } catch (e) { statusLabel.innerText = "Erreur..."; }
        }

        function parler() {
            if (isSpeaking || speechQueue.length === 0) return;
            isSpeaking = true; 
            let txt = speechQueue.shift();
            
            // NETTOYAGE DU TEXTE POUR LA LECTURE
            txt = txt.replace(/[#*`_]/g, ''); // Enlever markdown
            
            const utter = new SpeechSynthesisUtterance(txt);
            
            if (!bestVoice) loadVoices();
            utter.voice = bestVoice; 
            
            utter.lang = 'fr-FR'; 
            // REGLAGES POUR VOIX "MAMAN DOUCE"
            utter.pitch = 1.05; // L√©g√®rement plus haut pour adoucir
            utter.rate = 0.85;  // Plus lent pour raconter l'histoire
            
            utter.onend = () => { 
                isSpeaking = false; 
                // Petite pause artificielle entre les phrases
                setTimeout(() => {
                    if(speechQueue.length === 0) toggleStopButton(false); 
                    parler(); 
                }, 300); // 300ms de pause
            };
            synth.speak(utter);
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('toggle-input').onclick = () => document.getElementById('keyboard-area').classList.toggle('hidden');
            document.getElementById('btn-ok').onclick = () => { const val = document.getElementById('manualInput').value.trim(); if(val) appelIA(val); };
            document.getElementById('btn-mic').onclick = () => {
                const Speech = window.SpeechRecognition || window.webkitSpeechRecognition; if (!Speech) return alert("Micro non support√©.");
                const rec = new Speech(); rec.lang = 'fr-FR';
                rec.onstart = () => { document.getElementById('btn-mic').classList.add('mic-listening'); document.getElementById('status').innerText = "Je t'√©coute..."; };
                rec.onresult = (e) => { const p = e.results[0][0].transcript; document.getElementById('manualInput').value = p; appelIA(p); };
                rec.onend = () => document.getElementById('btn-mic').classList.remove('mic-listening');
                rec.onerror = () => document.getElementById('status').innerText = "Je n'ai pas entendu...";
                try { rec.start(); } catch (e) {}
            };
            document.getElementById('btn-stop').onclick = stopAudio;
        });
        if (!API_KEY) { const k = prompt("Entre ta cl√© API Gemini :"); if (k) { localStorage.setItem('BOITE_FINAL_KEY_2026', k); API_KEY = k; location.reload(); } }
        function reinitialiserCle() { localStorage.removeItem('BOITE_FINAL_KEY_2026'); location.reload(); }
    </script>
</body>
</html>