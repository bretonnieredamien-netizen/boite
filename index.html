<!DOCTYPE html>
<html lang="fr">
<head>
<link rel="manifest" href="manifest.json">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Bo√Æte √† Histoires Magique</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Short+Stack&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Short+Stack', cursive; background: linear-gradient(135deg, #fef9c3 0%, #fef3c7 100%); }
        .magic-btn { transition: all 0.3s ease; transform: scale(1); }
        .magic-btn:active { transform: scale(0.9); }
        .pulsate { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(234, 179, 8, 0); } 100% { transform: scale(1); } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <div id="setup" class="bg-white p-6 rounded-3xl shadow-xl mt-10 w-full max-w-md border-4 border-yellow-400">
        <h2 class="text-2xl font-bold text-yellow-600 mb-4 text-center">üîë Activation Magique</h2>
        <input type="password" id="apiKey" placeholder="Collez votre cl√© Gemini ici..." class="w-full p-3 border-2 border-yellow-200 rounded-xl mb-4 focus:outline-none focus:border-yellow-500">
        <button onclick="saveKey()" class="w-full bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-3 rounded-xl shadow-lg">Lancer la Bo√Æte</button>
    </div>

    <div id="main" class="hidden w-full max-w-2xl flex flex-col items-center">
        <h1 class="text-4xl font-bold text-yellow-600 my-8 text-center mt-10">La Bo√Æte √† Histoires ‚ú®</h1>
        
        <div id="image-container" class="w-full aspect-video bg-white rounded-3xl shadow-2xl border-8 border-white overflow-hidden mb-8 hidden">
            <img id="story-image" src="" alt="Image de l'histoire" class="w-full h-full object-cover">
        </div>

        <button id="recordBtn" onclick="toggleListening()" class="magic-btn bg-yellow-400 p-12 rounded-full shadow-2xl mb-8 border-8 border-white">
            <span id="mic-icon" class="text-6xl">üé§</span>
        </button>
        <p id="status" class="text-yellow-700 text-xl font-medium mb-8 text-center">Appuie pour me parler...</p>

        <div id="story-box" class="bg-white p-8 rounded-3xl shadow-lg border-4 border-yellow-200 w-full hidden">
            <p id="story-text" class="text-lg leading-relaxed text-gray-800"></p>
        </div>
    </div>

    <script>
        let apiKey = "";
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'fr-FR';
        const synth = window.speechSynthesis;

        function saveKey() {
            apiKey = document.getElementById('apiKey').value;
            if(apiKey) {
                document.getElementById('setup').classList.add('hidden');
                document.getElementById('main').classList.remove('hidden');
            }
        }

        function toggleListening() {
            try {
                recognition.start();
                document.getElementById('recordBtn').classList.add('pulsate');
                document.getElementById('status').innerText = "Je t'√©coute...";
            } catch(e) { console.log("Micro d√©j√† actif"); }
        }

        recognition.onresult = async (event) => {
            const userPrompt = event.results[0][0].transcript;
            document.getElementById('recordBtn').classList.remove('pulsate');
            document.getElementById('status').innerText = "Je r√©fl√©chis...";
            
            await generateStory(userPrompt);
        };

        async function generateStory(prompt) {
    const cleanKey = apiKey.trim();
    // CHANGEMENT ICI : On utilise v1beta au lieu de v1
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${cleanKey}`;
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: `Tu es un conteur. Raconte une mini histoire pour enfant sur : ${prompt}. Termine par une question.` }] }]
            })
        });

        const data = await response.json();

        if (!response.ok) {
            console.error("D√©tails de l'erreur:", data);
            alert(`Erreur Google (${response.status}): ${data.error ? data.error.message : 'Erreur inconnue'}`);
            return;
        }

        // Extraction du texte de l'histoire
        if (data.candidates && data.candidates[0].content) {
            const story = data.candidates[0].content.parts[0].text;
            displayResult(story, prompt);
            speak(story);
        } else {
            alert("L'IA n'a pas pu g√©n√©rer d'histoire. R√©essaie !");
        }

    } catch (error) {
        console.error("Erreur de connexion :", error);
        alert("Probl√®me de connexion internet.");
    }
}

        const data = await response.json();

        if (!response.ok) {
            // C'est ce message qui nous donnera la cl√© du probl√®me
            console.error("ERREUR DETAILLEE :", data);
            alert("CODE ERREUR : " + response.status + "\nMESSAGE : " + data.error.message);
            return;
        }

        const story = data.candidates[0].content.parts[0].text;
        displayResult(story, prompt);
        speak(story);

    } catch (error) {
        alert("Erreur de connexion : " + error.message);
    }
}

        function displayResult(text, prompt) {
            document.getElementById('story-box').classList.remove('hidden');
            document.getElementById('story-text').innerText = text;
            
            const imgContainer = document.getElementById('image-container');
            const imgElement = document.getElementById('story-image');
            imgElement.src = `https://image.pollinations.ai/prompt/children_illustration_fairytale_style_${encodeURIComponent(prompt)}?width=800&height=450&nologo=true`;
            imgContainer.classList.remove('hidden');
            document.getElementById('status').innerText = "Il √©tait une fois...";
        }

        function speak(text) {
            synth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'fr-FR';
            utterance.pitch = 1.2;
            utterance.rate = 0.9;
            synth.speak(utterance);
        }
    </script>
</body>
</html>