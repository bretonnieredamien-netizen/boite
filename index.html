<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>TEST ULTIME</title>
</head>
<body style="background: white; color: black; padding: 20px; font-family: sans-serif;">

    <h1>TEST DE CONNEXION</h1>
    
    <p>Si tu vois ce message, le HTML fonctionne.</p>
    
    <div id="diag" style="border: 2px solid red; padding: 10px; margin: 10px 0;">
        Vérification du JavaScript... (Si ce message ne change pas, JS est bloqué)
    </div>

    <button id="btn" style="padding: 20px; width: 100%; background: blue; color: white; font-size: 20px;">
        CLIQUE ICI POUR TESTER L'IA
    </button>

    <pre id="logs" style="background: #eee; padding: 10px; margin-top: 20px;"></pre>

    <script>
        // TEST IMMEDIAT AU CHARGEMENT
        window.onload = function() {
            document.getElementById('diag').innerHTML = "✅ LE JAVASCRIPT FONCTIONNE !";
            document.getElementById('diag').style.borderColor = "green";
        };

        const key = localStorage.getItem('FINAL_KEY') || prompt("Entre ta clé API Gemini :");
        if(key) localStorage.setItem('FINAL_KEY', key);

        document.getElementById('btn').onclick = async function() {
            const logs = document.getElementById('logs');
            logs.innerText += "\n> Bouton cliqué, envoi à Google...";
            this.style.background = "orange";
            this.innerText = "PATIENTER...";

            try {
                // On utilise l'URL la plus simple possible
                const url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=" + key;
                
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: "Dis 'OK' !" }] }]
                    })
                });

                const data = await res.json();
                logs.innerText += "\n> Réponse reçue !";
                
                if(data.candidates) {
                    alert("SUCCÈS ! L'IA a répondu : " + data.candidates[0].content.parts[0].text);
                    this.style.background = "green";
                } else {
                    logs.innerText += "\n> ERREUR : " + JSON.stringify(data.error);
                    alert("ERREUR : " + data.error.message);
                }
            } catch (e) {
                logs.innerText += "\n> CRASH RÉSEAU : " + e.message;
                alert("Erreur réseau : " + e.message);
            }
        };
    </script>
</body>
</html>