<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ta boite magique ✨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;500;800;900&display=swap" rel="stylesheet">
    <style>
        /* Fond Moderne Animé */
        body { 
            font-family: 'Lexend', sans-serif; 
            background: linear-gradient(-45deg, #fff7ed, #fef9c3, #ede9fe, #fae8ff);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            touch-action: manipulation; 
            overflow-x: hidden;
            min-height: 100vh;
            margin: 0;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- Poussière d'étoiles (Canvas) --- */
        #starfield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .hidden { display: none !important; }
        .content-layer { position: relative; z-index: 10; width: 100%; display: flex; flex-direction: column; align-items: center; opacity: 0; transition: opacity 1s ease-in; }
        .content-visible { opacity: 1 !important; }

        /* --- LOGO --- */
        .brand-header { position: absolute; top: 1.5rem; left: 1.5rem; display: flex; flex-direction: column; align-items: flex-start; gap: 0.2rem; z-index: 20; }
        .mini-logo-text { font-weight: 900; font-size: 1.2rem; background: linear-gradient(135deg, #22d3ee, #818cf8, #c084fc, #34d399); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-transform: lowercase; }
        .settings-links { display: flex; gap: 10px; }
        
        .logo-container { width: 220px; height: 220px; display: flex; justify-content: center; align-items: center; opacity: 0; animation: introFade 2s ease-out forwards, slowBeat 5s ease-in-out infinite 2s; filter: drop-shadow(0 10px 25px rgba(129, 140, 248, 0.5)); }
        @keyframes introFade { 0% { opacity: 0; transform: translateY(15px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes slowBeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.04); } }

        /* --- UI --- */
        .status-box { 
            background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); 
            padding: 0.6rem 1.8rem; border-radius: 9999px; 
            border: 1px solid rgba(255, 255, 255, 0.5); margin-top: 1rem;
            min-height: 44px; display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
        }
        .understood-flash { animation: success-pulse 0.8s ease-out !important; background: rgba(16, 185, 129, 0.2) !important; border-color: #10b981 !important; }
        @keyframes success-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); box-shadow: 0 0 60px #10b981; } 100% { transform: scale(1); } }
        .glass-ui { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); border: 1px solid white; }

        /* --- LOADER MAGIQUE --- */
        .magic-loader {
            width: 24px; height: 24px;
            border-radius: 50%;
            border: 3px solid transparent;
            border-top-color: #22d3ee;
            border-right-color: #818cf8;
            border-bottom-color: #c084fc;
            animation: spinLoader 1s linear infinite;
        }
        @keyframes spinLoader { 100% { transform: rotate(360deg); } }

        /* --- VISUALISEUR AUDIO --- */
        #story-card { 
            background: transparent; 
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            filter: drop-shadow(0 4px 6px rgba(129, 140, 248, 0.3));
        }
        #visualizer-canvas { width: 100%; height: 100%; }

        /* --- BOUTONS --- */
        .orbe-base { position: relative; width: 120px; height: 120px; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(15px); border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.8); display: flex; align-items: center; justify-content: center; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .orbe-base svg { width: 45px; height: 45px; fill: #6366f1; }
        .mic-listening { background: rgba(99, 102, 241, 0.15) !important; box-shadow: 0 0 50px rgba(99, 102, 241, 0.6) !important; transform: scale(1.1); }
        #btn-stop svg { fill: #f87171; }
        #stop-container.opacity-100 #btn-stop { background: rgba(248, 113, 113, 0.15); border-color: #f87171; box-shadow: 0 0 30px rgba(248, 113, 113, 0.4); }
        
        /* --- INTRO ANIMATION --- */
        #intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(-45deg, #fff7ed, #fef9c3, #ede9fe, #fae8ff);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s ease-out, visibility 0.8s;
        }
        
        .container-box { position: relative; width: 300px; height: 350px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        .god-rays {
            position: absolute; width: 150%; height: 150%;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(251, 191, 36, 0.1) 20deg, transparent 40deg, rgba(139, 92, 246, 0.1) 60deg, transparent 80deg);
            border-radius: 50%; z-index: 0; opacity: 0; transition: opacity 1s;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .rays-active { opacity: 1; animation: spinRays 4s linear infinite; }
        @keyframes spinRays { 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        #treasure-glow {
            position: absolute; top: 60%; left: 50%; width: 0; height: 0; transform: translate(-50%, -50%);
            background: radial-gradient(circle, rgba(255, 215, 0, 0.8) 10%, rgba(251, 191, 36, 0.6) 30%, rgba(255, 255, 255, 0) 70%);
            z-index: 3; opacity: 0; border-radius: 50%; pointer-events: none;
        }
        .treasure-shine-active { animation: treasureShineAnim 1.5s ease-out forwards; }
        @keyframes treasureShineAnim {
            0% { opacity: 0; width: 50px; height: 50px; }
            20% { opacity: 1; width: 600px; height: 600px; }
            100% { opacity: 0; width: 800px; height: 800px; }
        }

        .arrow-container { width: 50px; height: 50px; z-index: 5; position: relative; margin-bottom: -10px; filter: drop-shadow(0 0 10px rgba(139, 92, 246, 0.6)); transition: opacity 0.3s; }
        .bounce-arrow { animation: bounce 2s ease-in-out infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

        #intro-box { width: 220px; height: 220px; cursor: pointer; position: relative; z-index: 2; transition: transform 0.3s; }
        #intro-box:hover { transform: scale(1.05); }

        .super-shake { animation: violentShake 1.2s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes violentShake {
            0% { transform: translate(0, 0) rotate(0); }
            10%, 90% { transform: translate(-3px, 1px) rotate(-3deg); }
            20%, 80% { transform: translate(3px, -2px) rotate(3deg); }
            30%, 50%, 70% { transform: translate(-6px, 4px) rotate(-6deg) scale(1.1); }
            40%, 60% { transform: translate(6px, -4px) rotate(6deg) scale(1.1); }
            100% { transform: translate(0, 0) scale(1.2); }
        }

        .lid-open { animation: lidExplode 0.6s forwards cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes lidExplode {
            0% { transform: translateY(0) rotate(0); }
            40% { transform: translateY(-50px) rotate(-10deg); }
            100% { transform: translateY(-600px) rotate(-45deg) scale(1.5); opacity: 0; }
        }

        .intro-fade-out { opacity: 0; pointer-events: none; }
        .white-flash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white;
            z-index: 90; opacity: 0; pointer-events: none;
        }
        .flash-active { animation: flashAnim 1s ease-out forwards; }
        @keyframes flashAnim { 0% { opacity: 0; } 10% { opacity: 0.8; } 100% { opacity: 0; } }

    </style>
</head>
<body class="p-6">

    <canvas id="starfield"></canvas>

    <div id="intro-overlay">
        <div class="container-box">
            <div id="god-rays" class="god-rays"></div>
            <div id="treasure-glow"></div>
            
            <div class="arrow-container bounce-arrow">
                 <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="arrowGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#22d3ee;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#818cf8;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#c084fc;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <path d="M 50 90 L 10 50 L 30 50 L 30 10 L 70 10 L 70 50 L 90 50 Z" fill="url(#arrowGradient)" stroke="white" stroke-width="2" stroke-linejoin="round"/>
                </svg>
            </div>

            <div id="intro-box">
                <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" filter="drop-shadow(0 0 20px rgba(139, 92, 246, 0.4))">
                    <defs>
                        <linearGradient id="auroraFill" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#22d3ee;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#818cf8;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#c084fc;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <path d="M50 80 L150 80 L140 160 L60 160 Z" fill="url(#auroraFill)" stroke="white" stroke-width="3" stroke-linejoin="round"/>
                    <g id="intro-lid" style="transform-origin: 100px 80px;">
                        <path d="M40 60 L160 60 L150 80 L50 80 Z" fill="#818cf8" stroke="white" stroke-width="3" stroke-linejoin="round"/>
                        <path d="M40 60 L160 60 L140 40 L60 40 Z" fill="#c084fc" stroke="white" stroke-width="3" stroke-linejoin="round" opacity="0.9"/>
                        <circle cx="100" cy="80" r="6" fill="#fbbf24" stroke="white" stroke-width="2"/>
                    </g>
                </svg>
            </div>
        </div>
        <p class="text-indigo-900/40 text-xs mt-8 font-bold uppercase tracking-widest animate-pulse">Touche le coffre pour l'ouvrir</p>
    </div>
    <div id="white-flash" class="white-flash"></div>

    <div id="main-interface" class="content-layer min-h-screen">
        
        <div class="brand-header">
            <span class="mini-logo-text">tbm.</span>
            <div class="settings-links">
                <button onclick="oublierPrenom()" class="text-[10px] text-indigo-300 hover:text-indigo-500">(Changer prénom)</button>
                <button onclick="oublierAge()" class="text-[10px] text-indigo-300 hover:text-indigo-500">(Changer âge)</button>
            </div>
        </div>

        <header class="text-center flex flex-col items-center mt-6">
            <div class="logo-container">
                <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="auroraFill2" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#22d3ee;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#818cf8;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#c084fc;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="lightBeam" x1="0.5" y1="1" x2="0.5" y2="0">
                             <stop offset="0%" stop-color="#fff" stop-opacity="0.6"/>
                             <stop offset="100%" stop-color="#fff" stop-opacity="0"/>
                        </linearGradient>
                    </defs>
                    <path d="M70 80 L50 20 L90 20 Z" fill="url(#lightBeam)" opacity="0.6"/>
                    <path d="M100 85 L100 10 L120 10 Z" fill="url(#lightBeam)" opacity="0.8"/>
                    <path d="M130 80 L150 20 L110 20 Z" fill="url(#lightBeam)" opacity="0.6"/>
                    <path d="M50 80 L150 80 L140 160 L60 160 Z" fill="url(#auroraFill2)" stroke="white" stroke-width="3" stroke-linejoin="round"/>
                    <path d="M50 80 L20 60 L60 60 L80 80 Z" fill="#818cf8" stroke="white" stroke-width="2" opacity="0.9"/>
                    <path d="M150 80 L180 60 L140 60 L120 80 Z" fill="#c084fc" stroke="white" stroke-width="2" opacity="0.9"/>
                    <path d="M60 80 L140 80 L120 60 L80 60 Z" fill="#34d399" opacity="0.7"/>
                    <path d="M50 80 L150 80 L170 100 L30 100 Z" fill="url(#auroraFill2)" stroke="white" stroke-width="2" opacity="0.8"/>
                </svg>
            </div>
            
            <div class="status-box">
                <p id="status" class="text-indigo-900/60 font-semibold italic text-sm">Chargement...</p>
                <div id="loading-spinner" class="magic-loader hidden"></div>
            </div>

        </header>

        <main class="w-full max-w-md flex flex-col items-center gap-14 mt-8">
            <div class="flex items-center justify-center gap-12 w-full">
                <div class="flex flex-col items-center gap-4">
                    <button id="btn-mic" class="orbe-base shadow-2xl">
                        <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                    </button>
                    <span class="text-indigo-900/40 text-[11px] font-bold uppercase tracking-widest">Écouter</span>
                </div>
                <div id="stop-container" class="flex flex-col items-center gap-4 opacity-20 pointer-events-none transition-all duration-500">
                    <button id="btn-stop" class="orbe-base shadow-xl">
                        <svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="2" /></svg>
                    </button>
                    <span class="text-red-900/40 text-[11px] font-bold uppercase tracking-widest">Arrêter</span>
                </div>
            </div>

            <div id="story-card" class="w-full max-w-xs h-24 hidden transition-all duration-500">
                <canvas id="visualizer-canvas"></canvas>
            </div>

            <div id="keyboard-area" class="w-full flex gap-2 glass-ui p-2 rounded-2xl shadow-xl hidden">
                <input type="text" id="manualInput" placeholder="Ta réponse..." class="flex-1 bg-white/40 p-4 rounded-xl outline-none text-sm font-medium">
                <button id="btn-ok" class="bg-indigo-500 text-white px-7 py-4 rounded-xl font-bold active:scale-95 shadow-md">OK</button>
            </div>

            <button id="toggle-input" class="p-4 rounded-full shadow-sm active:scale-90 opacity-40 hover:opacity-100 transition-opacity">
                <span class="text-2xl">⌨️</span>
            </button>

        </main>

        <footer class="mt-auto py-10">
            <button onclick="reinitialiserCle()" class="text-gray-400 text-[10px] uppercase underline tracking-widest opacity-30">Réinitialiser les clés API</button>
        </footer>

    </div>

    <script>
        /* --- CONFIGURATION & VARIABLES --- */
        let GEMINI_KEY = localStorage.getItem('BOITE_GEMINI_KEY');
        let AZURE_KEY = localStorage.getItem('BOITE_AZURE_KEY');
        let AZURE_REGION = localStorage.getItem('BOITE_AZURE_REGION');
        
        let userPrenom = localStorage.getItem('BOITE_PRENOM');
        let userAge = localStorage.getItem('BOITE_AGE');
        
        // MODES: 'INIT', 'NAME_INPUT', 'AGE_INPUT', 'STORY_INPUT', 'TELLING'
        let interactionMode = 'INIT'; 

        const MODEL_ID = "models/gemini-2.5-flash"; 
        const AZURE_VOICE_NAME = "fr-FR-DeniseNeural"; 

        let speechQueue = [];
        let isSpeaking = false;
        let audioCtx = null;
        let currentAudio = null;

        /* --- CANVAS STARS & PARTICLES --- */
        const canvas = document.getElementById('starfield'); const ctx = canvas.getContext('2d'); let particles = []; let burstParticles = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        class Particle { constructor() { this.reset(); } reset() { this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height; this.size = Math.random() * 2 + 0.5; this.speed = Math.random() * 0.02 + 0.01; this.opacity = Math.random() * 0.8; this.color = Math.random() > 0.5 ? "251, 191, 36" : "129, 140, 248"; } update() { this.y -= this.speed; this.x += Math.sin(this.y * 0.01) * 0.2; if (this.y < 0) this.reset(); } draw() { ctx.fillStyle = `rgba(${this.color}, ${this.opacity})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); } }
        class BurstParticle { constructor(x, y) { this.x = x; this.y = y; const angle = Math.random() * Math.PI * 2; const speed = Math.random() * 15 + 5; this.vx = Math.cos(angle) * speed; this.vy = Math.sin(angle) * speed; this.life = 1.0; this.decay = Math.random() * 0.015 + 0.005; this.color = Math.random() > 0.5 ? "#fbbf24" : "#ffffff"; this.size = Math.random() * 5 + 2; } update() { this.x += this.vx; this.y += this.vy; this.vy += 0.2; this.vx *= 0.96; this.vy *= 0.96; this.life -= this.decay; } draw() { ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); ctx.globalAlpha = 1.0; } }
        function initParticles() { particles = []; for (let i = 0; i < 100; i++) particles.push(new Particle()); }
        function triggerBurst() { const centerX = window.innerWidth / 2; const centerY = window.innerHeight / 2; for (let i = 0; i < 300; i++) burstParticles.push(new BurstParticle(centerX, centerY)); }
        function animate() { ctx.clearRect(0, 0, canvas.width, canvas.height); particles.forEach(p => { p.update(); p.draw(); }); for (let i = burstParticles.length - 1; i >= 0; i--) { const p = burstParticles[i]; p.update(); p.draw(); if (p.life <= 0) burstParticles.splice(i, 1); } requestAnimationFrame(animate); }
        window.addEventListener('resize', resize); resize(); initParticles(); animate();

        /* --- VISUALISEUR AUDIO --- */
        const vizCanvas = document.getElementById('visualizer-canvas'); const vizCtx = vizCanvas.getContext('2d'); let analyser = null; let dataArray = null; let visualizerAnimationId = null;
        function resizeViz() { if(vizCanvas.parentElement) { vizCanvas.width = vizCanvas.parentElement.offsetWidth; vizCanvas.height = vizCanvas.parentElement.offsetHeight; } }
        window.addEventListener('resize', resizeViz);
        function startVisualizer(audioSource, context) { resizeViz(); analyser = context.createAnalyser(); analyser.fftSize = 64; audioSource.connect(analyser); analyser.connect(context.destination); const bufferLength = analyser.frequencyBinCount; dataArray = new Uint8Array(bufferLength); drawVisualizer(); }
        function drawVisualizer() { visualizerAnimationId = requestAnimationFrame(drawVisualizer); analyser.getByteFrequencyData(dataArray); vizCtx.clearRect(0, 0, vizCanvas.width, vizCanvas.height); const bufferLength = analyser.frequencyBinCount; const gap = 6; const barWidth = (vizCanvas.width / bufferLength) - gap; let barHeight; let x = gap / 2; let gradient = vizCtx.createLinearGradient(0, vizCanvas.height, 0, 0); gradient.addColorStop(0, '#4f46e5'); gradient.addColorStop(0.5, '#9333ea'); gradient.addColorStop(1, '#db2777'); vizCtx.fillStyle = gradient; for (let i = 0; i < bufferLength; i++) { barHeight = (dataArray[i] / 255) * vizCanvas.height; if (barHeight < 5) barHeight = 5; const y = (vizCanvas.height - barHeight) / 2; roundRect(vizCtx, x, y, barWidth, barHeight, 50); x += barWidth + gap; } }
        function roundRect(ctx, x, y, width, height, radius) { if (width < 2 * radius) radius = width / 2; if (height < 2 * radius) radius = height / 2; ctx.beginPath(); ctx.moveTo(x + radius, y); ctx.arcTo(x + width, y, x + width, y + height, radius); ctx.arcTo(x + width, y + height, x, y + height, radius); ctx.arcTo(x, y + height, x, y, radius); ctx.arcTo(x, y, x + width, y, radius); ctx.closePath(); ctx.fill(); }
        function stopVisualizer() { if (visualizerAnimationId) cancelAnimationFrame(visualizerAnimationId); vizCtx.clearRect(0, 0, vizCanvas.width, vizCanvas.height); }

        /* --- SONS --- */
        function playSimpleWoosh() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const t = audioCtx.currentTime;
            const bufferSize = audioCtx.sampleRate * 4.0; const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate); const data = buffer.getChannelData(0); for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            const noise = audioCtx.createBufferSource(); noise.buffer = buffer;
            const filter = audioCtx.createBiquadFilter(); filter.type = 'lowpass'; filter.Q.value = 1; filter.frequency.setValueAtTime(100, t); filter.frequency.exponentialRampToValueAtTime(3000, t + 1.5); filter.frequency.exponentialRampToValueAtTime(100, t + 4.0);
            const gain = audioCtx.createGain(); gain.gain.setValueAtTime(0, t); gain.gain.linearRampToValueAtTime(0.4, t + 1.0); gain.gain.linearRampToValueAtTime(0, t + 4.0);
            noise.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination); noise.start(t); noise.stop(t + 4.0);
        }
        function playChime() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = 'triangle'; osc.frequency.setValueAtTime(1244.51, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(1567.98, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + 0.05); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.5);
        }

        /* --- FONCTION D'ÉCOUTE AUTOMATIQUE --- */
        function startListening() {
            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!Speech) return; // Pas de support, on ne fait rien (l'enfant devra cliquer)

            const rec = new Speech();
            rec.lang = 'fr-FR';
            rec.interimResults = false;
            
            rec.onstart = () => {
                document.getElementById('btn-mic').classList.add('mic-listening');
                document.getElementById('status').innerText = "Je t'écoute...";
            };
            rec.onresult = (e) => {
                const p = e.results[0][0].transcript;
                document.getElementById('manualInput').value = p;
                traiterInput(p);
            };
            rec.onend = () => document.getElementById('btn-mic').classList.remove('mic-listening');
            rec.onerror = (e) => {
                console.log("Erreur micro ou silence", e);
                document.getElementById('btn-mic').classList.remove('mic-listening');
                // On remet le texte par défaut si erreur
                if (interactionMode === 'NAME_INPUT') document.getElementById('status').innerText = "Comment t'appelles-tu ?";
                else if (interactionMode === 'AGE_INPUT') document.getElementById('status').innerText = "Quel âge as-tu ?";
                else if (interactionMode === 'STORY_INPUT') document.getElementById('status').innerText = "Dis-moi ton idée...";
            };

            try { rec.start(); } catch (e) {}
        }


        /* --- LOGIQUE D'INTERACTION --- */
        const introBox = document.getElementById('intro-box');
        const rays = document.getElementById('god-rays');
        const treasureGlow = document.getElementById('treasure-glow');
        const arrow = document.querySelector('.arrow-container');
        let opened = false;

        function startInteractionSequence() {
            if (!userPrenom) {
                interactionMode = 'NAME_INPUT';
                document.getElementById('status').innerText = "Bonjour ! Comment t'appelles-tu ?";
                setTimeout(() => {
                    speechQueue.push("Bonjour ! Je suis ta boîte à histoires. Comment t'appelles-tu ?");
                    parler();
                }, 1000);
            } else if (!userAge) {
                interactionMode = 'AGE_INPUT';
                document.getElementById('status').innerText = `Quel âge as-tu, ${userPrenom} ?`;
                setTimeout(() => {
                    speechQueue.push(`Enchantée ${userPrenom} ! Quel âge as-tu ?`);
                    parler();
                }, 1000);
            } else {
                interactionMode = 'STORY_INPUT';
                document.getElementById('status').innerText = `Te revoilà, ${userPrenom} !`;
                setTimeout(() => {
                    speechQueue.push(`Bonjour ${userPrenom} ! Quelle histoire on invente aujourd'hui ?`);
                    parler();
                }, 1000);
            }
        }

        // Gère l'input (texte ou voix) selon le mode
        function traiterInput(texte) {
            if (!texte.trim()) return;
            
            stopAudio(); 
            document.getElementById('manualInput').value = "";

            if (interactionMode === 'NAME_INPUT') {
                userPrenom = texte.replace(/je m'appelle /i, "").replace(/c'est /i, "").trim();
                localStorage.setItem('BOITE_PRENOM', userPrenom);
                
                interactionMode = 'AGE_INPUT';
                document.getElementById('status').innerText = `Et quel âge as-tu ?`;
                document.getElementById('manualInput').placeholder = "Ton âge...";
                
                speechQueue.push(`Enchantée ${userPrenom} ! Et dis-moi, quel âge as-tu ?`);
                parler();
                
            } else if (interactionMode === 'AGE_INPUT') {
                userAge = texte.replace(/j'ai /i, "").replace(/ans/i, "").trim();
                localStorage.setItem('BOITE_AGE', userAge);
                
                interactionMode = 'STORY_INPUT';
                document.getElementById('status').innerText = `D'accord ! Quelle histoire veux-tu ?`;
                document.getElementById('manualInput').placeholder = "Sujet de l'aventure...";
                
                speechQueue.push(`D'accord, ${userAge} ans ! C'est noté. Quelle histoire veux-tu écouter maintenant ?`);
                parler();

            } else if (interactionMode === 'STORY_INPUT') {
                interactionMode = 'TELLING'; // On passe en mode narration (pas d'auto-mic)
                appelIA(texte);
            }
        }

        introBox.addEventListener('click', () => {
            if (opened) return;
            opened = true;
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            playSimpleWoosh(); 
            introBox.classList.add('super-shake');
            rays.classList.add('rays-active');
            arrow.classList.add('intro-fade-out');

            setTimeout(() => {
                document.getElementById('intro-lid').classList.add('lid-open');
                treasureGlow.classList.add('treasure-shine-active');
                triggerBurst();
                document.getElementById('white-flash').classList.add('flash-active');
            }, 1200);

            setTimeout(() => {
                document.getElementById('intro-overlay').classList.add('intro-fade-out');
                document.getElementById('main-interface').classList.add('content-visible');
                startInteractionSequence();
            }, 1800);
            
            setTimeout(() => { document.getElementById('intro-overlay').style.display = 'none'; }, 3000);
        });

        /* --- FONCTIONS AUDIO & API --- */
        function toggleStopButton(active) {
            const container = document.getElementById('stop-container');
            if (active) { container.classList.remove('opacity-20', 'pointer-events-none'); container.classList.add('opacity-100'); } else { container.classList.add('opacity-20', 'pointer-events-none'); container.classList.remove('opacity-100'); }
        }

        function stopAudio() {
            if (currentAudio) { currentAudio.pause(); currentAudio = null; }
            stopVisualizer(); speechQueue = []; isSpeaking = false;
            document.getElementById('status').classList.remove('hidden');
            document.getElementById('loading-spinner').classList.add('hidden');
            
            if (interactionMode === 'NAME_INPUT') document.getElementById('status').innerText = "Comment t'appelles-tu ?";
            else if (interactionMode === 'AGE_INPUT') document.getElementById('status').innerText = "Quel âge as-tu ?";
            else if (interactionMode === 'STORY_INPUT') document.getElementById('status').innerText = userPrenom ? `Dis-moi ton idée, ${userPrenom}...` : "Dis-moi ton idée...";
            // Si on est en mode TELLING et qu'on stop, on revient à STORY_INPUT pour demander une autre histoire
            else if (interactionMode === 'TELLING') {
                interactionMode = 'STORY_INPUT';
                document.getElementById('status').innerText = "Une autre histoire ?";
            }
            
            toggleStopButton(false);
            document.getElementById('story-card').classList.add('hidden'); 
        }

        async function appelIA(sujet) {
            if (!GEMINI_KEY || !AZURE_KEY || !AZURE_REGION) { verifierCles(); return; }
            stopAudio();
            // Re-forcer le mode Telling ici pour être sûr
            interactionMode = 'TELLING';
            
            const btnMic = document.getElementById('btn-mic');
            const statusLabel = document.getElementById('status');
            const loader = document.getElementById('loading-spinner');
            playChime();
            btnMic.classList.add('understood-flash');
            statusLabel.classList.add('hidden');
            loader.classList.remove('hidden');
            setTimeout(() => { btnMic.classList.remove('understood-flash'); toggleStopButton(true); }, 800);
            
            const url = `https://generativelanguage.googleapis.com/v1beta/${MODEL_ID}:streamGenerateContent?alt=sse&key=${GEMINI_KEY}`;
            
            let contextChild = "";
            if (userPrenom) contextChild += `L'enfant s'appelle ${userPrenom}. `;
            if (userAge) contextChild += `L'enfant a ${userAge} ans (adapte le vocabulaire et la complexité de l'histoire à cet âge). `;
            
            const promptIA = `Tu es une conteuse de livre audio professionnelle. ${contextChild} Raconte une aventure réaliste pour cet enfant sur : "${sujet}". Ton ton est bienveillant mais neutre. INTERDICTION d'utiliser des surnoms affectueux (mon cœur, mon chéri, mon ange). Tu n'es pas sa maman. Reste une narratrice externe. Utilise des phrases simples. Pas de magie. Fin positive. Termine par "FIN".`;

            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: promptIA }] }] }) });
                const reader = response.body.getReader(); const decoder = new TextDecoder("utf-8"); let currentSentence = "";
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        loader.classList.add('hidden');
                        statusLabel.classList.remove('hidden');
                        statusLabel.innerText = "L'aventure est prête !";
                        if (currentSentence.trim()) { speechQueue.push(currentSentence.trim()); parler(); }
                        break;
                    }
                    const chunk = decoder.decode(value); const lines = chunk.split("\n");
                    for (const line of lines) {
                        if (line.startsWith("data: ")) {
                            try {
                                const json = JSON.parse(line.substring(6));
                                const chunkText = json.candidates[0].content.parts[0].text;
                                currentSentence += chunkText;
                                if (/[.!?;:]/.test(chunkText) || chunkText.includes("\n")) {
                                    const parts = currentSentence.split(/([.!?;:]|\n)/);
                                    for (let i = 0; i < parts.length - 1; i += 2) { 
                                        const p = (parts[i] + (parts[i+1] || "")).trim(); 
                                        if (p.length > 2) { speechQueue.push(p); parler(); } 
                                    }
                                    currentSentence = parts[parts.length - 1];
                                }
                            } catch(e) {}
                        }
                    }
                }
            } catch (e) { loader.classList.add('hidden'); statusLabel.classList.remove('hidden'); statusLabel.innerText = "Erreur technique..."; }
        }

        async function textToSpeechAzure(text) {
            const url = `https://${AZURE_REGION}.tts.speech.microsoft.com/cognitiveservices/v1`;
            const ssml = `<speak version='1.0' xml:lang='fr-FR'><voice xml:lang='fr-FR' xml:gender='Female' name='${AZURE_VOICE_NAME}'><prosody rate="0.9">${text}</prosody></voice></speak>`;
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Ocp-Apim-Subscription-Key': AZURE_KEY, 'Content-Type': 'application/ssml+xml', 'X-Microsoft-OutputFormat': 'audio-16khz-128kbitrate-mono-mp3' }, body: ssml });
                if (!response.ok) throw new Error("Erreur Azure");
                return await response.blob();
            } catch (e) { return null; }
        }

        async function parler() {
            if (isSpeaking || speechQueue.length === 0) return;
            isSpeaking = true; 
            document.getElementById('story-card').classList.remove('hidden');
            let txt = speechQueue.shift().replace(/[#*`_]/g, '');
            const audioBlob = await textToSpeechAzure(txt);
            if (audioBlob) {
                const audioUrl = URL.createObjectURL(audioBlob);
                currentAudio = new Audio(audioUrl);
                const source = audioCtx.createMediaElementSource(currentAudio);
                startVisualizer(source, audioCtx);
                
                currentAudio.onended = () => {
                    isSpeaking = false;
                    
                    if (speechQueue.length === 0) { 
                        // La phrase est finie et la file est vide
                        toggleStopButton(false); 
                        stopVisualizer(); 
                        document.getElementById('story-card').classList.add('hidden');
                        
                        // LOGIQUE D'ACTIVATION AUTOMATIQUE DU MICRO
                        // Si on est dans un mode qui attend une réponse (Prénom, Age, Histoire)
                        if (interactionMode === 'NAME_INPUT' || interactionMode === 'AGE_INPUT' || interactionMode === 'STORY_INPUT') {
                            // Petit délai naturel avant d'écouter
                            setTimeout(() => {
                                startListening();
                            }, 500);
                        }
                    }
                    else parler(); 
                };
                currentAudio.play();
            } else { isSpeaking = false; parler(); }
        }

        function verifierCles() {
            if (!GEMINI_KEY) { const k = prompt("Entre ta clé API Gemini (Google) :"); if (k) { localStorage.setItem('BOITE_GEMINI_KEY', k); GEMINI_KEY = k; } }
            if (!AZURE_KEY) { const k = prompt("Entre ta clé API Azure Speech (Clé 1) :"); const r = prompt("Entre ta région Azure (ex: francecentral) :"); if (k && r) { localStorage.setItem('BOITE_AZURE_KEY', k); localStorage.setItem('BOITE_AZURE_REGION', r); AZURE_KEY = k; AZURE_REGION = r; } }
            if (GEMINI_KEY && AZURE_KEY && AZURE_REGION) location.reload();
        }

        function reinitialiserCle() { localStorage.removeItem('BOITE_GEMINI_KEY'); localStorage.removeItem('BOITE_AZURE_KEY'); localStorage.removeItem('BOITE_AZURE_REGION'); localStorage.removeItem('BOITE_FINAL_KEY_2026'); location.reload(); }
        function oublierPrenom() { localStorage.removeItem('BOITE_PRENOM'); location.reload(); }
        function oublierAge() { localStorage.removeItem('BOITE_AGE'); location.reload(); }

        document.addEventListener('DOMContentLoaded', () => {
            if (!GEMINI_KEY || !AZURE_KEY) verifierCles();
            document.getElementById('toggle-input').onclick = () => document.getElementById('keyboard-area').classList.toggle('hidden');
            
            document.getElementById('btn-ok').onclick = () => { const val = document.getElementById('manualInput').value.trim(); traiterInput(val); };
            
            document.getElementById('btn-mic').onclick = () => {
               startListening(); // Utilisation de la nouvelle fonction commune
            };
            document.getElementById('btn-stop').onclick = stopAudio;
        });
    </script>
</body>
</html>