<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BatiPilot Studio - L'Assistant BTP</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect x=%225%22 y=%225%22 width=%2290%22 height=%2290%22 fill=%22white%22 stroke=%22%23CBD5E1%22 stroke-width=%225%22 stroke-dasharray=%2210%22 rx=%2210%22/><path d=%22M50 20 L20 80 L50 65 z%22 fill=%22%233B82F6%22/><path d=%22M50 20 L80 80 L50 65 z%22 fill=%22%231E293B%22/></svg>" type="image/svg+xml">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #E5E7EB; color: #1F2937; overflow: hidden; }
        
        /* Mobile adjustment */
        @media (max-width: 768px) {
            body { overflow: auto; height: 100%; }
            .sheet-container { padding: 10px; min-height: 85vh; height: auto !important; } 
            .paper-sheet { padding: 10mm; width: 100%; zoom: 0.7; }
        }
        
        .nav-btn { text-align: left; padding: 12px 16px; width: 100%; border-radius: 8px; font-size: 13px; font-weight: 500; color: #64748B; transition: 0.2s; display: flex; align-items: center; gap: 12px; }
        .nav-btn:hover { background: #F1F5F9; color: #0F172A; }
        .nav-btn.active { background: #0F172A; color: #fff; font-weight: 600; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        .folder-item { padding: 12px 14px; border-bottom: 1px solid #F1F5F9; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; border-left: 4px solid transparent; }
        .folder-item:hover { background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .folder-item.active { background: white; border-right: 1px solid #E5E7EB; }
        
        .file-item { padding: 12px; background: white; border: 1px solid #E2E8F0; border-radius: 8px; cursor: pointer; transition: 0.2s; margin-bottom: 8px; position: relative; }
        .file-item:hover { border-color: #3B82F6; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        .sheet-container { background-color: #525659; padding: 40px; overflow-y: auto; height: 100%; width: 100%; display: flex; justify-content: center; align-items: flex-start; }
        .paper-sheet { background: white; width: 210mm; min-height: 297mm; height: auto; padding: 20mm; box-shadow: 0 4px 20px rgba(0,0,0,0.3); font-family: 'Inter', sans-serif; font-size: 11px; color: #111; line-height: 1.5; box-sizing: border-box; margin-bottom: 50px; overflow: visible; max-width: 100%; }
        
        /* Markdown Styles */
        .markdown-body h1 { font-size: 18px; font-weight: 900; text-transform: uppercase; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
        .markdown-body h2 { font-size: 13px; font-weight: 800; text-transform: uppercase; color: #2563EB; background: #EFF6FF; padding: 5px 10px; margin-top: 20px; border-left: 4px solid #2563EB; }
        .markdown-body table { width: 100% !important; border-collapse: collapse; margin: 15px 0; border: 1px solid #CBD5E1; border-radius: 4px; font-size: 8px; }
        .markdown-body th { background: #1E293B; color: white; padding: 5px 4px; text-align: left; text-transform: uppercase; font-weight: 700; border: 1px solid #334155; }
        .markdown-body td { padding: 5px 4px; border: 1px solid #E2E8F0; vertical-align: middle; text-align: center; }
        .markdown-body td:nth-child(1), .markdown-body td:nth-child(2) { text-align: left; font-weight: bold; }
        .markdown-body td.gantt-x { background-color: #EFF6FF; color: #2563EB; font-weight: 900; }
        .markdown-body img { max-width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 20px 0; }
        
        .checkbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 5px; }
        .check-item { display: flex; align-items: center; gap: 6px; font-size: 10px; color: #475569; cursor: pointer; padding: 4px 6px; border: 1px solid #E2E8F0; border-radius: 4px; transition: 0.2s; background: white; }
        .check-item:hover { border-color: #94A3B8; background: #F8FAFC; }
        .check-item input:checked + span { font-weight: 800; color: #2563EB; }
        
        .drop-zone { border: 2px dashed #CBD5E1; border-radius: 8px; transition: 0.2s; background: #F8FAFC; position: relative; }
        .drop-zone:hover { border-color: #64748B; background: #fff; }
        
        .color-swatch { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .color-swatch.selected { border-color: #000; box-shadow: 0 0 0 2px white, 0 0 0 4px #000; }
        
        .d-none { display: none !important; }
        .grouped-cell { border-top: none !important; color: transparent !important; }

        .chat-bubble-user { background-color: #3B82F6; color: white; border-radius: 12px 12px 0 12px; padding: 10px; font-size: 12px; margin-left: auto; max-width: 80%; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(59,130,246,0.2); }
        .chat-bubble-bot { background-color: #F1F5F9; color: #1E293B; border-radius: 12px 12px 12px 0; padding: 10px; font-size: 12px; margin-right: auto; max-width: 85%; margin-bottom: 8px; border: 1px solid #E2E8F0; }
        #chat-widget.hidden { display: none; }
        #chat-widget:not(.hidden) { display: flex; }

        #config-modal.hidden, #project-modal.hidden, #admin-modal.hidden { display: none; pointer-events: none; opacity: 0; }
        #config-modal:not(.hidden), #project-modal:not(.hidden), #admin-modal:not(.hidden) { display: flex; pointer-events: auto; opacity: 1; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 99; transform: translateY(100px); transition: 0.3s; }
        #toast-container.show { transform: translateY(0); }
        
        /* Animation Menu Mobile */
        .sidebar-mobile-open { transform: translateX(0) !important; }
        .sidebar-mobile-closed { transform: translateX(-100%); }
        .overlay-mobile { background-color: rgba(0,0,0,0.5); position: fixed; inset: 0; z-index: 40; }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden text-sm">

    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center text-white transition-opacity duration-500">
        <div class="bg-white text-slate-900 p-8 rounded-xl shadow-2xl w-[90%] md:w-[400px] relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-emerald-400"></div>
            <div class="flex justify-center mb-2 mt-4">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 120" width="250" height="75">
                    <g stroke="#E2E8F0" stroke-width="1"><line x1="10" y1="30" x2="110" y2="30" /><line x1="10" y1="60" x2="110" y2="60" /><line x1="10" y1="90" x2="110" y2="90" /><line x1="30" y1="10" x2="30" y2="110" /><line x1="60" y1="10" x2="60" y2="110" /><line x1="90" y1="10" x2="90" y2="110" /></g><rect x="15" y="15" width="90" height="90" fill="none" stroke="#CBD5E1" stroke-width="2" stroke-dasharray="6 4" rx="8" /><circle cx="60" cy="25" r="3" fill="none" stroke="#3B82F6" stroke-width="2" /><circle cx="25" cy="85" r="2.5" fill="#10B981" /><circle cx="95" cy="85" r="2.5" fill="#1E293B" /><polygon points="60,25 25,85 60,70" fill="#3B82F6" /><polygon points="60,25 95,85 60,70" fill="#1E293B" /><polygon points="60,25 60,70 68,74" fill="#0F172A" opacity="0.15" /><line x1="60" y1="70" x2="60" y2="105" stroke="#3B82F6" stroke-width="1.5" stroke-dasharray="3 3" /><g stroke="#94A3B8" stroke-width="1"><line x1="25" y1="100" x2="95" y2="100" /><line x1="25" y1="97" x2="25" y2="103" /><line x1="95" y1="97" x2="95" y2="103" /></g>
                    <text x="125" y="72" font-family="'Inter', system-ui, -apple-system, sans-serif" font-size="52" letter-spacing="-1.5"><tspan font-weight="900" fill="#0F172A">Bati</tspan><tspan font-weight="300" fill="#3B82F6">Pilot</tspan><tspan font-weight="900" fill="#10B981">.</tspan></text>
                    <rect x="130" y="82" width="34" height="18" fill="#1E293B" stroke="#334155" stroke-width="1" rx="4"/><text x="135" y="94" font-family="'Inter', system-ui, sans-serif" font-size="10" font-weight="800" fill="#3B82F6" letter-spacing="1">APP</text><text x="175" y="94" font-family="'Inter', system-ui, sans-serif" font-size="10" font-weight="600" fill="#64748B" letter-spacing="0.5">ESPACE DE CONNEXION</text>
                </svg>
            </div>
            <p class="text-[10px] text-slate-400 text-center mb-6 uppercase tracking-widest font-bold"><i class="fa-solid fa-lock text-emerald-500"></i> Accès Réservé</p>
            <label class="text-[10px] font-bold uppercase text-slate-500 mb-1 block">Email</label>
            <input type="email" id="login-email" class="w-full border border-gray-300 rounded px-3 py-2.5 mb-4 text-sm font-bold outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition" placeholder="contact@agence.fr">
            <label class="text-[10px] font-bold uppercase text-slate-500 mb-1 block">Mot de passe</label>
            <input type="password" id="login-pass" class="w-full border border-gray-300 rounded px-3 py-2.5 mb-6 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition" onkeypress="if(event.key === 'Enter') loginApp()">
            <button onclick="loginApp()" id="btn-login" class="w-full bg-slate-900 text-white font-bold py-3 rounded-lg text-xs hover:bg-slate-800 transition shadow-lg transform active:scale-95 mb-2">SE CONNECTER</button>
            <a href="index.html" class="block text-center text-[10px] font-bold text-slate-400 mt-4 hover:text-slate-600 transition">← Retour à l'accueil</a>
            <p id="login-error" class="text-red-500 text-xs text-center mt-4 hidden font-bold"></p>
        </div>
    </div>

    <div id="mobile-overlay" class="hidden overlay-mobile md:hidden" onclick="toggleSidebar()"></div>

    <aside id="main-sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white border-r border-gray-200 flex flex-col transform -translate-x-full transition-transform duration-300 md:relative md:translate-x-0">
        <div class="p-6 border-b border-gray-100 flex flex-col items-start justify-center relative">
             <button onclick="toggleSidebar()" class="absolute top-4 right-4 md:hidden text-slate-400"><i class="fa-solid fa-times text-lg"></i></button>
             
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 120" width="160" height="48" class="mb-1">
                <g stroke="#E2E8F0" stroke-width="1"><line x1="10" y1="30" x2="110" y2="30" /><line x1="10" y1="60" x2="110" y2="60" /><line x1="10" y1="90" x2="110" y2="90" /><line x1="30" y1="10" x2="30" y2="110" /><line x1="60" y1="10" x2="60" y2="110" /><line x1="90" y1="10" x2="90" y2="110" /></g><rect x="15" y="15" width="90" height="90" fill="none" stroke="#CBD5E1" stroke-width="2" stroke-dasharray="6 4" rx="8" /><circle cx="60" cy="25" r="3" fill="none" stroke="#3B82F6" stroke-width="2" /><circle cx="25" cy="85" r="2.5" fill="#10B981" /><circle cx="95" cy="85" r="2.5" fill="#1E293B" /><polygon points="60,25 25,85 60,70" fill="#3B82F6" /><polygon points="60,25 95,85 60,70" fill="#1E293B" /><polygon points="60,25 60,70 68,74" fill="#0F172A" opacity="0.15" /><line x1="60" y1="70" x2="60" y2="105" stroke="#3B82F6" stroke-width="1.5" stroke-dasharray="3 3" /><g stroke="#94A3B8" stroke-width="1"><line x1="25" y1="100" x2="95" y2="100" /><line x1="25" y1="97" x2="25" y2="103" /><line x1="95" y1="97" x2="95" y2="103" /></g>
                <text x="125" y="72" font-family="'Inter', system-ui, -apple-system, sans-serif" font-size="52" letter-spacing="-1.5"><tspan font-weight="900" fill="#0F172A">Bati</tspan><tspan font-weight="300" fill="#3B82F6">Pilot</tspan><tspan font-weight="900" fill="#10B981">.</tspan></text>
                <rect x="130" y="82" width="34" height="18" fill="#EFF6FF" stroke="#BFDBFE" stroke-width="1" rx="4"/><text x="135" y="94" font-family="'Inter', system-ui, sans-serif" font-size="10" font-weight="800" fill="#3B82F6" letter-spacing="1">APP</text><text x="175" y="94" font-family="'Inter', system-ui, sans-serif" font-size="10" font-weight="600" fill="#94A3B8" letter-spacing="0.5">SAAS B2B</text>
            </svg>
        </div>
        <nav class="flex-1 px-3 py-4 space-y-1 overflow-y-auto">
            <div class="text-[10px] font-bold text-gray-400 uppercase px-3 mb-2 tracking-wider">Technique</div>
            <button onclick="switchMode('plu'); toggleSidebar()" id="btn-plu" class="nav-btn active"><i class="fa-solid fa-map w-5"></i> PLU (Localisé)</button>
            <button onclick="switchMode('soil'); toggleSidebar()" id="btn-soil" class="nav-btn"><i class="fa-solid fa-layer-group w-5"></i> Étude de Sol (G2)</button>
            <button onclick="switchMode('control'); toggleSidebar()" id="btn-control" class="nav-btn"><i class="fa-solid fa-shield-halved w-5"></i> Bureau Contrôle</button>
            <button onclick="switchMode('acoustic'); toggleSidebar()" id="btn-acoustic" class="nav-btn"><i class="fa-solid fa-volume-high w-5"></i> Expert Acoustique</button>
            <button onclick="switchMode('cctp'); toggleSidebar()" id="btn-cctp" class="nav-btn"><i class="fa-solid fa-file-contract w-5"></i> CCTP (Générateur)</button>
            <button onclick="switchMode('dpgf'); toggleSidebar()" id="btn-dpgf" class="nav-btn"><i class="fa-solid fa-ruler-combined w-5"></i> Pré-Métré DPGF</button>
            <button onclick="switchMode('devis'); toggleSidebar()" id="btn-devis" class="nav-btn"><i class="fa-solid fa-scale-balanced w-5"></i> Devis Honoraires</button>
            
            <div class="text-[10px] font-bold text-gray-400 uppercase px-3 mb-2 mt-6 tracking-wider">Chantier</div>
            <button onclick="switchMode('meeting'); toggleSidebar()" id="btn-meeting" class="nav-btn"><i class="fa-solid fa-users w-5"></i> CR Réunion</button>
            <button onclick="switchMode('report'); toggleSidebar()" id="btn-report" class="nav-btn"><i class="fa-solid fa-camera w-5"></i> Rapport Chantier</button>
            <button onclick="switchMode('situation'); toggleSidebar()" id="btn-situation" class="nav-btn"><i class="fa-solid fa-percent w-5"></i> Situation Avancement</button>
            <button onclick="switchMode('snag'); toggleSidebar()" id="btn-snag" class="nav-btn"><i class="fa-solid fa-list-check w-5"></i> Levée de Réserves</button>
            <button onclick="switchMode('planning'); toggleSidebar()" id="btn-planning" class="nav-btn"><i class="fa-solid fa-calendar-days w-5"></i> Planning</button>
            
            <div class="text-[10px] font-bold text-gray-400 uppercase px-3 mb-2 mt-6 tracking-wider">Bureau</div>
            <button onclick="switchMode('expertise'); toggleSidebar()" id="btn-expertise" class="nav-btn"><i class="fa-solid fa-book w-5"></i> Normes DTU</button>
            <button onclick="switchMode('legal'); toggleSidebar()" id="btn-legal" class="nav-btn"><i class="fa-solid fa-envelope w-5"></i> Courriers / OS</button>
            <button onclick="switchMode('permit'); toggleSidebar()" id="btn-permit" class="nav-btn"><i class="fa-solid fa-file-signature w-5"></i> Permis (Notice & Cerfa)</button>
            
            <div class="mt-6 pt-4 border-t border-gray-100">
                <a href="tutorial.html" target="_blank" class="nav-btn text-blue-600 font-bold bg-blue-50 block hover:bg-blue-100"><i class="fa-solid fa-circle-info w-5"></i> Manuel d'utilisation</a>
            </div>
        </nav>
        
        <div class="p-4 border-t border-gray-100 bg-slate-50">
            <div class="text-[9px] text-slate-500 font-bold uppercase mb-2 truncate" title="Utilisateur actuel">
                <i class="fa-solid fa-user text-blue-500 mr-1"></i> <span id="current-user-email">Non connecté</span>
            </div>
            <div class="text-[9px] text-slate-400 font-bold uppercase mb-3 truncate flex items-center justify-between">
                <span>Rôle: <span id="current-user-role" class="text-slate-700">...</span></span>
                <span id="current-plan-badge" class="bg-purple-100 text-purple-700 px-2 py-0.5 rounded border border-purple-200">PLAN</span>
            </div>
            <button onclick="UI.toggleConfig()" class="w-full text-left font-bold text-slate-700 hover:text-black flex items-center gap-2 text-xs bg-white p-2 rounded border border-slate-200 shadow-sm"><i class="fa-solid fa-sliders text-blue-500"></i> Paramètres Agence</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col bg-gray-50 min-w-0 h-full">
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4 md:px-6 shadow-sm sticky top-0 z-30 flex-shrink-0">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="md:hidden text-slate-600 hover:text-blue-600 mr-1"><i class="fa-solid fa-bars text-xl"></i></button>
                <span class="text-xs font-bold text-gray-400 uppercase hidden sm:inline">Projet Actif :</span>
                <span id="active-project-display" class="font-bold text-blue-700 bg-blue-50 px-3 py-1.5 rounded-md text-xs truncate max-w-[150px] sm:max-w-none">Général</span>
            </div>
            <div id="header-tools" class="flex gap-2">
                <button onclick="toggleRightPanel()" class="md:hidden bg-slate-100 text-slate-700 px-3 py-2 rounded-md font-bold text-xs"><i class="fa-solid fa-folder"></i></button>

                <button id="mail-btn" onclick="copyEmailContent()" class="hidden bg-slate-100 text-slate-700 px-3 py-2 rounded-md font-bold hover:bg-slate-200 text-xs flex items-center gap-2 transition border border-slate-300"><i class="fa-solid fa-envelope-open-text"></i> <span class="hidden lg:inline">COPIER</span></button>
                <button id="share-btn" onclick="shareToOffice()" class="hidden bg-emerald-600 text-white px-3 py-2 rounded-md font-bold hover:bg-emerald-700 text-xs flex items-center gap-2 transition"><i class="fa-solid fa-paper-plane"></i> <span class="hidden lg:inline">ENVOYER</span></button>
                <button id="excel-btn" onclick="exportToExcel()" class="hidden bg-green-600 text-white px-3 py-2 rounded-md font-bold hover:bg-green-700 text-xs flex items-center gap-2 transition"><i class="fa-solid fa-table"></i> <span class="hidden lg:inline">EXCEL</span></button>
                <button id="word-btn" onclick="exportWord()" class="hidden bg-blue-600 text-white px-3 py-2 rounded-md font-bold hover:bg-blue-700 text-xs flex items-center gap-2 transition"><i class="fa-solid fa-file-word"></i> <span class="hidden lg:inline">WORD</span></button>
                <button id="save-btn" onclick="saveDocument()" class="hidden bg-slate-800 text-white px-3 py-2 rounded-md font-bold hover:bg-slate-700 text-xs flex items-center gap-2 transition"><i class="fa-solid fa-cloud-arrow-up"></i> <span class="hidden lg:inline">SAUVER</span></button>
                <button onclick="exportPDF()" class="bg-slate-900 text-white px-3 py-2 rounded-md font-bold hover:bg-slate-800 text-xs flex items-center gap-2 transition"><i class="fa-solid fa-file-pdf"></i> <span class="hidden lg:inline">PDF</span></button>
            </div>
        </header>

        <div class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
            
            <div id="left-panel" class="w-full md:w-80 bg-white border-r border-gray-200 p-5 overflow-y-auto flex flex-col gap-5 z-20 shadow-md flex-shrink-0 transition-all duration-300 relative">
                
                <button id="mobile-edit-btn" onclick="window.showMobileInputs()" class="hidden w-full bg-blue-50 text-blue-600 font-bold py-3 rounded-lg border border-blue-200 shadow-sm text-xs mb-4 flex items-center justify-center gap-2 sticky top-0 z-50">
                    <i class="fa-solid fa-pen"></i> Modifier les réglages / Relancer
                </button>

                <div id="mobile-input-wrapper" class="flex flex-col gap-5 h-full">
                    
                    <div id="mode-helper" class="bg-slate-50 p-4 rounded-lg border border-slate-100 flex-shrink-0">
                        <h3 id="help-title" class="font-bold text-slate-800 text-xs mb-1 uppercase">Mode</h3>
                        <p id="help-desc" class="text-[10px] text-slate-500 leading-relaxed">Info...</p>
                    </div>

                    <div id="plu-form" class="d-none flex-col gap-4"><div><label class="text-[10px] font-bold uppercase text-gray-400">Adresse (Optionnel si défini dans le projet)</label><div class="flex gap-2"><input type="text" id="plu-address" class="w-full border border-gray-200 rounded p-2 text-xs"><button onclick="locateZone()" class="bg-blue-600 text-white px-3 rounded text-xs"><i class="fa-solid fa-location-dot"></i></button></div></div><div><label class="text-[10px] font-bold uppercase text-gray-400">Zone (ex: UA)</label><input type="text" id="plu-zone" class="w-full border-b border-gray-300 py-1 text-sm font-bold outline-none focus:border-black"></div></div>
                    <div id="devis-form" class="d-none flex-col gap-4"><div class="flex bg-slate-100 p-1 rounded-lg mb-2"><button id="btn-devis-gen" onclick="toggleDevisMode('gen')" class="flex-1 py-2 text-[10px] font-bold uppercase rounded bg-white shadow text-blue-600 transition">Créer Devis (Honoraires)</button><button id="btn-devis-ana" onclick="toggleDevisMode('ana')" class="flex-1 py-2 text-[10px] font-bold uppercase rounded text-slate-500 hover:text-slate-700 transition">Analyser (Devis Ent.)</button></div><div id="devis-gen-section" class="flex flex-col gap-4"><div><label class="text-[10px] font-bold uppercase text-gray-400">Client / Destinataire</label><input type="text" id="devis-client" placeholder="Nom et adresse du client..." class="w-full border-b border-gray-300 py-1 text-sm font-bold outline-none text-blue-700"></div><div><label class="text-[10px] font-bold uppercase text-gray-400 mb-1 block">Phases de la mission et montants (HT)</label><div class="flex flex-col gap-2"><div class="flex items-center justify-between border border-gray-200 rounded p-2 bg-white"><div class="flex items-center gap-2"><input type="checkbox" id="phase-esq" value="ESQ (Esquisse)" class="devis-phase-cb" checked onchange="toggleDevisInput('esq')"><label for="phase-esq" class="text-[11px] font-bold cursor-pointer text-slate-700">ESQ</label></div><div class="flex items-center gap-1" id="wrap-amount-esq"><input type="number" id="amount-esq" placeholder="Prix" class="w-20 border-b border-gray-300 text-xs font-bold outline-none focus:border-blue-500 text-right text-blue-600"><span class="text-xs font-bold text-gray-500">€</span></div></div><div class="flex items-center justify-between border border-gray-200 rounded p-2 bg-white"><div class="flex items-center gap-2"><input type="checkbox" id="phase-aps" value="APS (Avant-Projet Sommaire)" class="devis-phase-cb" checked onchange="toggleDevisInput('aps')"><label for="phase-aps" class="text-[11px] font-bold cursor-pointer text-slate-700">APS</label></div><div class="flex items-center gap-1" id="wrap-amount-aps"><input type="number" id="amount-aps" placeholder="Prix" class="w-20 border-b border-gray-300 text-xs font-bold outline-none focus:border-blue-500 text-right text-blue-600"><span class="text-xs font-bold text-gray-500">€</span></div></div><div class="flex items-center justify-between border border-gray-200 rounded p-2 bg-white"><div class="flex items-center gap-2"><input type="checkbox" id="phase-apd" value="APD (Avant-Projet Définitif)" class="devis-phase-cb" checked onchange="toggleDevisInput('apd')"><label for="phase-apd" class="text-[11px] font-bold cursor-pointer text-slate-700">APD</label></div><div class="flex items-center gap-1" id="wrap-amount-apd"><input type="number" id="amount-apd" placeholder="Prix" class="w-20 border-b border-gray-300 text-xs font-bold outline-none focus:border-blue-500 text-right text-blue-600"><span class="text-xs font-bold text-gray-500">€</span></div></div><div class="flex items-center justify-between border border-gray-200 rounded p-2 bg-white"><div class="flex items-center gap-2"><input type="checkbox" id="phase-dpc" value="DPC (Dossier Permis de Construire)" class="devis-phase-cb" checked onchange="toggleDevisInput('dpc')"><label for="phase-dpc" class="text-[11px] font-bold cursor-pointer text-slate-700">DPC</label></div><div class="flex items-center gap-1" id="wrap-amount-dpc"><input type="number" id="amount-dpc" placeholder="Prix" class="w-20 border-b border-gray-300 text-xs font-bold outline-none focus:border-blue-500 text-right text-blue-600"><span class="text-xs font-bold text-gray-500">€</span></div></div><div class="flex items-center justify-between border border-gray-200 rounded p-2 bg-white"><div class="flex items-center gap-2"><input type="checkbox" id="phase-pro" value="PRO/DCE (Conception Générale / Dossier Consultation)" class="devis-phase-cb" onchange="toggleDevisInput('pro')"><label for="phase-pro" class="text-[11px] font-bold cursor-pointer text-slate-700">PRO/DCE</label></div><div class="flex items-center gap-1" id="wrap-amount-pro" style="opacity: 0.3; pointer-events: none;"><input type="number" id="amount-pro" placeholder="Prix" class="w-20 border-b border-gray-300 text-xs font-bold outline-none focus:border-blue-500 text-right text-blue-600"><span class="text-xs font-bold text-gray-500">€</span></div></div><div class="flex items-center justify-between border border-gray-200 rounded p-2 bg-white"><div class="flex items-center gap-2"><input type="checkbox" id="phase-act" value="ACT (Assistance Contrats Travaux)" class="devis-phase-cb" onchange="toggleDevisInput('act')"><label for="phase-act" class="text-[11px] font-bold cursor-pointer text-slate-700">ACT</label></div><div class="flex items-center gap-1" id="wrap-amount-act" style="opacity: 0.3; pointer-events: none;"><input type="number" id="amount-act" placeholder="Prix" class="w-20 border-b border-gray-300 text-xs font-bold outline-none focus:border-blue-500 text-right text-blue-600"><span class="text-xs font-bold text-gray-500">€</span></div></div><div class="flex items-center justify-between border border-gray-200 rounded p-2 bg-white"><div class="flex items-center gap-2"><input type="checkbox" id="phase-visa" value="VISA (Visa des études d'exécution)" class="devis-phase-cb" onchange="toggleDevisInput('visa')"><label for="phase-visa" class="text-[11px] font-bold cursor-pointer text-slate-700">VISA</label></div><div class="flex items-center gap-1" id="wrap-amount-visa" style="opacity: 0.3; pointer-events: none;"><input type="number" id="amount-visa" placeholder="Prix" class="w-20 border-b border-gray-300 text-xs font-bold outline-none focus:border-blue-500 text-right text-blue-600"><span class="text-xs font-bold text-gray-500">€</span></div></div><div class="flex items-center justify-between border border-gray-200 rounded p-2 bg-white"><div class="flex items-center gap-2"><input type="checkbox" id="phase-det" value="DET (Direction de l'Exécution des Travaux)" class="devis-phase-cb" onchange="toggleDevisInput('det')"><label for="phase-det" class="text-[11px] font-bold cursor-pointer text-slate-700">DET</label></div><div class="flex items-center gap-1" id="wrap-amount-det" style="opacity: 0.3; pointer-events: none;"><input type="number" id="amount-det" placeholder="Prix" class="w-20 border-b border-gray-300 text-xs font-bold outline-none focus:border-blue-500 text-right text-blue-600"><span class="text-xs font-bold text-gray-500">€</span></div></div><div class="flex items-center justify-between border border-gray-200 rounded p-2 bg-white"><div class="flex items-center gap-2"><input type="checkbox" id="phase-aor" value="AOR (Assistance Opérations Réception)" class="devis-phase-cb" onchange="toggleDevisInput('aor')"><label for="phase-aor" class="text-[11px] font-bold cursor-pointer text-slate-700">AOR</label></div><div class="flex items-center gap-1" id="wrap-amount-aor" style="opacity: 0.3; pointer-events: none;"><input type="number" id="amount-aor" placeholder="Prix" class="w-20 border-b border-gray-300 text-xs font-bold outline-none focus:border-blue-500 text-right text-blue-600"><span class="text-xs font-bold text-gray-500">€</span></div></div></div></div><div class="pt-2"><button onclick="triggerDevisAction('generate')" class="w-full bg-blue-50 text-blue-700 py-3 rounded text-[10px] font-bold border border-blue-100 hover:bg-blue-100 transition shadow-sm"><i class="fa-solid fa-file-invoice-dollar mb-1 block text-sm"></i> GÉNÉRER LE DEVIS</button></div></div><div id="devis-ana-section" class="hidden flex-col gap-4"><div class="pt-2"><button onclick="triggerDevisAction('analyze')" class="w-full bg-slate-100 text-slate-700 py-3 rounded text-[10px] font-bold border border-slate-200 hover:bg-slate-200 transition shadow-sm"><i class="fa-solid fa-code-compare mb-1 block text-sm"></i> COMPARER DEVIS VS CCTP</button></div></div></div>
                    <div id="cctp-form" class="d-none flex-col gap-4"><div class="flex bg-slate-100 p-1 rounded-lg mb-2"><button id="btn-cctp-gen" onclick="toggleCctpMode('gen')" class="flex-1 py-2 text-[10px] font-bold uppercase rounded bg-white shadow text-blue-600 transition">Rédiger CCTP</button><button id="btn-cctp-ana" onclick="toggleCctpMode('ana')" class="flex-1 py-2 text-[10px] font-bold uppercase rounded text-slate-500 hover:text-slate-700 transition">Analyser CCTP</button></div><div id="cctp-gen-section" class="flex flex-col gap-4"><div><label class="text-[10px] font-bold uppercase text-gray-400">Nature des travaux</label><select id="cctp-nature-gen" class="w-full border-b border-gray-300 py-1 text-sm font-bold outline-none bg-transparent"><option value="Construction Neuve">Neuf</option><option value="Rénovation">Rénovation</option><option value="Extension">Extension</option></select></div><div><label class="text-[10px] font-bold uppercase text-gray-400 mb-1">Lots à rédiger</label><div class="checkbox-grid"><label class="check-item"><input type="checkbox" value="Terrassement" checked><span>Terrass.</span></label><label class="check-item"><input type="checkbox" value="Fondations" checked><span>Fondations</span></label><label class="check-item"><input type="checkbox" value="Maçonnerie" checked><span>Maçonnerie</span></label><label class="check-item"><input type="checkbox" value="Charpente/Couv"><span>Charp./Couv.</span></label><label class="check-item"><input type="checkbox" value="Menuiseries Ext"><span>Men. Ext.</span></label><label class="check-item"><input type="checkbox" value="Menuiseries Intérieures"><span>Men. Int.</span></label><label class="check-item"><input type="checkbox" value="Enduit"><span>Enduit</span></label><label class="check-item"><input type="checkbox" value="Bardage"><span>Bardage</span></label><label class="check-item"><input type="checkbox" value="Isolation/Placo"><span>Iso/Placo</span></label><label class="check-item"><input type="checkbox" value="Electricité"><span>Élec</span></label><label class="check-item"><input type="checkbox" value="Plomberie"><span>Plomberie</span></label><label class="check-item"><input type="checkbox" value="Carrelage"><span>Carrelage</span></label><label class="check-item"><input type="checkbox" value="Peinture"><span>Peinture</span></label><label class="check-item"><input type="checkbox" value="VRD/Extérieur"><span>VRD</span></label></div></div><div class="pt-2"><button onclick="triggerCctpAction('generate')" class="w-full bg-blue-50 text-blue-700 py-3 rounded text-[10px] font-bold border border-blue-100 hover:bg-blue-100 transition shadow-sm"><i class="fa-solid fa-pen-nib mb-1 block text-sm"></i> GÉNÉRER LE CCTP</button></div></div><div id="cctp-ana-section" class="hidden flex-col gap-4"><div><label class="text-[10px] font-bold uppercase text-gray-400">Lot ciblé pour l'analyse</label><input type="text" id="cctp-lot-ana" placeholder="Ex: Général, Plomberie..." class="w-full border-b border-gray-300 py-1 text-sm font-bold outline-none text-slate-700"></div><div class="pt-2"><button onclick="triggerCctpAction('analyze')" class="w-full bg-slate-100 text-slate-700 py-3 rounded text-[10px] font-bold border border-slate-200 hover:bg-slate-200 transition shadow-sm"><i class="fa-solid fa-magnifying-glass mb-1 block text-sm"></i> ANALYSER LE CCTP</button></div></div></div>
                    <div id="planning-form" class="d-none flex-col gap-4"><div><label class="text-[10px] font-bold uppercase text-gray-400">Détail (Indiquer Surface)</label><input type="text" id="plan-desc" placeholder="Ex: Maison 150m2..." class="w-full border-b border-gray-300 py-1 text-sm font-bold outline-none focus:border-black"></div><div><label class="text-[10px] font-bold uppercase text-gray-400">Date Démarrage</label><input type="date" id="plan-date" class="w-full border border-gray-200 rounded p-2 text-xs font-bold focus:border-black"></div><div><label class="text-[10px] font-bold uppercase text-gray-400 mb-1">Lots (Pour mode Chantier)</label><div class="checkbox-grid"><label class="check-item"><input type="checkbox" value="Terrassement" checked><span>Terrassement</span></label><label class="check-item"><input type="checkbox" value="Fondations" checked><span>Fondations</span></label><label class="check-item"><input type="checkbox" value="Maçonnerie" checked><span>Maçonnerie</span></label><label class="check-item"><input type="checkbox" value="Charpente/Couv" checked><span>Charp./Couv.</span></label><label class="check-item"><input type="checkbox" value="Menuiseries Ext" checked><span>Men. Ext.</span></label><label class="check-item"><input type="checkbox" value="Menuiseries Intérieures"><span>Men. Int.</span></label><label class="check-item"><input type="checkbox" value="Enduit" checked><span>Enduit</span></label><label class="check-item"><input type="checkbox" value="Bardage"><span>Bardage</span></label><label class="check-item"><input type="checkbox" value="Isolation/Placo" checked><span>Iso/Placo</span></label><label class="check-item"><input type="checkbox" value="Electricité" checked><span>Élec</span></label><label class="check-item"><input type="checkbox" value="Plomberie" checked><span>Plomberie</span></label><label class="check-item"><input type="checkbox" value="Carrelage" checked><span>Carrelage</span></label><label class="check-item"><input type="checkbox" value="Peinture" checked><span>Peinture</span></label><label class="check-item"><input type="checkbox" value="Cuisine"><span>Cuisine</span></label><label class="check-item"><input type="checkbox" value="VRD/Extérieur"><span>VRD</span></label></div></div><div class="flex gap-2 pt-2"><button onclick="triggerPlanningAction('etudes')" class="flex-1 bg-indigo-50 text-indigo-700 py-3 rounded text-[10px] font-bold border border-indigo-100 hover:bg-indigo-100 transition shadow-sm"><i class="fa-solid fa-pen-ruler mb-1 block text-sm"></i> ÉTUDES</button><button onclick="triggerPlanningAction('chantier')" class="flex-1 bg-amber-50 text-amber-700 py-3 rounded text-[10px] font-bold border border-amber-100 hover:bg-amber-100 transition shadow-sm"><i class="fa-solid fa-person-digging mb-1 block text-sm"></i> CHANTIER</button></div></div>
                    <div id="permit-form" class="d-none flex-col gap-4"><div><label class="text-[10px] font-bold uppercase text-gray-400">Destination (Classement)</label><select id="permit-class" class="w-full border-b border-gray-300 py-1 text-sm font-bold outline-none bg-transparent"><option value="MI">Maison Individuelle</option><option value="LC">Logement Collectif</option><option value="BUR">Bureaux / Espace de Travail</option><option value="ERP">Commerce / Artisanat</option><option value="HOTEL">Hébergement hôtelier</option><option value="RESTO">Restauration</option><option value="INDUS">Industrie / Entrepôt</option><option value="AGRI">Exploitation Agricole</option><option value="SANTE">Équipement d'intérêt collectif</option><option value="ANNEXE">Annexe (Garage, Piscine)</option></select></div><div><label class="text-[10px] font-bold uppercase text-gray-400">Type de Travaux</label><select id="permit-work" class="w-full border-b border-gray-300 py-1 text-sm font-bold outline-none bg-transparent"><option value="NEUF">Construction Neuve</option><option value="EXT_S">Extension < 40m²</option><option value="EXT_L">Extension > 40m²</option><option value="FACADE">Modif. Façade / Toiture</option><option value="CHANGE">Changement de destination</option><option value="DIV">Division parcellaire</option></select></div><div class="flex gap-2 pt-2"><button onclick="triggerPermitAction('notice')" class="flex-1 bg-blue-50 text-blue-700 py-3 rounded text-[10px] font-bold border border-blue-100 hover:bg-blue-100 transition shadow-sm"><i class="fa-solid fa-pen-fancy mb-1 block text-sm"></i> NOTICE</button><button onclick="triggerPermitAction('cerfa')" class="flex-1 bg-slate-100 text-slate-700 py-3 rounded text-[10px] font-bold border border-slate-200 hover:bg-slate-200 transition shadow-sm"><i class="fa-solid fa-file-contract mb-1 block text-sm"></i> CERFA ?</button></div></div>
                    <div id="control-form" class="d-none flex-col gap-4"><div><label class="text-[10px] font-bold uppercase text-gray-400">Réglementation</label><select id="ctrl-reg" class="w-full border-b border-gray-300 py-1 text-sm font-bold outline-none bg-transparent"><option value="ERP_5">ERP 5ème Cat.</option><option value="ERP_G">ERP 1-4 Cat.</option><option value="CDT">Code du Travail (ERT)</option><option value="HAB">Habitation</option><option value="ICPE">ICPE</option></select></div><div class="grid grid-cols-2 gap-4"><div><label class="text-[10px] font-bold uppercase text-gray-400">Activité (Si ERP)</label><input type="text" id="ctrl-type" placeholder="Ex: Magasin (M)..." class="w-full border-b border-gray-300 py-1 text-sm font-bold outline-none"></div><div><label class="text-[10px] font-bold uppercase text-gray-400">Effectif</label><input type="number" id="ctrl-effectif" placeholder="Ex: 50" class="w-full border-b border-gray-300 py-1 text-sm font-bold outline-none text-blue-600"></div></div><div class="grid grid-cols-2 gap-2 pt-2"><button onclick="triggerControlAction('general')" class="col-span-2 bg-red-50 text-red-700 py-3 rounded text-[10px] font-bold border border-red-100 hover:bg-red-100 transition shadow-sm"><i class="fa-solid fa-clipboard-check mb-1 block text-sm"></i> AUDIT GLOBAL (COMPLET)</button><button onclick="triggerControlAction('evac')" class="bg-orange-50 text-orange-700 py-2 rounded text-[10px] font-bold border border-orange-100 hover:bg-orange-100 transition"><i class="fa-solid fa-person-running mb-1 block"></i> ÉVACUATION</button><button onclick="triggerControlAction('smoke')" class="bg-gray-100 text-gray-700 py-2 rounded text-[10px] font-bold border border-gray-200 hover:bg-gray-200 transition"><i class="fa-solid fa-wind mb-1 block"></i> DÉSENFUMAGE</button><button onclick="triggerControlAction('pmr')" class="col-span-2 bg-blue-50 text-blue-700 py-2 rounded text-[10px] font-bold border border-blue-200 hover:bg-blue-200 transition"><i class="fa-solid fa-wheelchair mb-1 block"></i> AUDIT ACCÈS PMR</button></div></div>
                    <div id="acoustic-form" class="d-none flex-col gap-4"><div><label class="text-[10px] font-bold uppercase text-gray-400">Type de Bâtiment</label><select id="acou-type" class="w-full border-b border-gray-300 py-1 text-sm font-bold outline-none bg-transparent"><option value="BUREAU">Bureaux (NF S 31-080)</option><option value="LOGEMENT">Logement (NRA 2000)</option><option value="ECOLE">Enseignement</option><option value="HOTEL">Hôtel</option><option value="SANTE">Santé</option></select></div><div><label class="text-[10px] font-bold uppercase text-gray-400">Environnement Extérieur</label><select id="acou-env" class="w-full border-b border-gray-300 py-1 text-sm font-bold outline-none bg-transparent"><option value="CALME">Calme (Campagne/Résid.)</option><option value="BR2">Bruyant (Rue - 30dB)</option><option value="BR3">Très Bruyant (Voie rapide - 35dB)</option><option value="BR4">Point Noir Bruit (Ferroviaire)</option></select></div><div class="flex gap-2 pt-2"><button onclick="triggerAcousticAction('audit')" class="flex-1 bg-indigo-50 text-indigo-700 py-3 rounded text-[10px] font-bold border border-indigo-100 hover:bg-indigo-100 transition shadow-sm"><i class="fa-solid fa-ear-listen mb-1 block text-sm"></i> AUDIT PLAN</button><button onclick="triggerAcousticAction('partition')" class="flex-1 bg-slate-100 text-slate-700 py-3 rounded text-[10px] font-bold border border-slate-200 hover:bg-slate-200 transition shadow-sm"><i class="fa-solid fa-layer-group mb-1 block text-sm"></i> CLOISONS ?</button></div></div>
                    <div id="legal-form" class="d-none flex-col gap-4"><div><label class="text-[10px] font-bold uppercase text-gray-400">Type de document</label><select id="legal-type" class="w-full border-b border-gray-300 py-1 text-sm font-bold outline-none bg-transparent text-blue-700"><option value="OS">Ordre de Service (OS)</option><option value="MED">Mise en Demeure</option><option value="CR">Courrier de Réserve / Remarque</option></select></div><div><label class="text-[10px] font-bold uppercase text-gray-400">Entreprise Destinataire</label><input type="text" id="legal-contractor" placeholder="Ex: SARL Maçonnerie Dupont" class="w-full border-b border-gray-300 py-1 text-sm font-bold outline-none"></div><div><label class="text-[10px] font-bold uppercase text-gray-400">Adresse / Contact (Optionnel)</label><input type="text" id="legal-contractor-address" placeholder="Ex: 15 rue des Artisans..." class="w-full border-b border-gray-300 py-1 text-sm outline-none"></div><div><label class="text-[10px] font-bold uppercase text-gray-400">Objet / Motif principal</label><input type="text" id="legal-subject" placeholder="Ex: Reprise des malfaçons sur le mur Nord" class="w-full border border-gray-200 rounded p-2 text-xs focus:border-black mt-1"></div></div>

                    <div id="inputs-files">
                        <div id="zone-a" class="flex flex-col mb-4">
                            <label id="label-a" class="text-[10px] font-bold uppercase text-gray-400 mb-1">Source A</label>
                            <div class="drop-zone h-20 flex flex-col items-center justify-center cursor-pointer group" onclick="document.getElementById('input-a').click()">
                                <input type="file" id="input-a" class="hidden" onchange="loadFile(this, 'A')">
                                <div id="ph-a" class="text-center text-gray-400"><i class="fa-solid fa-file-arrow-up mb-1 text-lg"></i><div class="text-[9px] font-bold">FICHIER</div></div>
                                <div id="ok-a" class="hidden text-center w-full relative px-2">
                                    <span id="name-a" class="text-emerald-600 font-bold text-[10px] truncate block px-4"></span>
                                    <button onclick="clearFile(event, 'A')" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition bg-white rounded-full"><i class="fa-solid fa-times-circle text-lg"></i></button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="zone-b" class="hidden flex-col mb-4">
                            <label id="label-b" class="text-[10px] font-bold uppercase text-gray-400 mb-1">Comparatif B</label>
                            <div class="drop-zone h-20 flex flex-col items-center justify-center cursor-pointer group" onclick="document.getElementById('input-b').click()">
                                <input type="file" id="input-b" class="hidden" onchange="loadFile(this, 'B')">
                                <div id="ph-b" class="text-center text-gray-400"><i class="fa-solid fa-upload"></i></div>
                                <div id="ok-b" class="hidden text-center w-full relative px-2">
                                    <span id="name-b" class="text-blue-600 font-bold text-[10px] truncate block px-4"></span>
                                    <button onclick="clearFile(event, 'B')" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition bg-white rounded-full"><i class="fa-solid fa-times-circle text-lg"></i></button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="zone-img" class="hidden flex-col mb-4">
                            <label id="label-img" class="text-[10px] font-bold uppercase text-gray-400 mb-1">Photos</label>
                            <div class="drop-zone p-2 flex flex-col items-center justify-center cursor-pointer relative group" onclick="document.getElementById('input-img').click()">
                                <input type="file" id="input-img" multiple class="hidden" onchange="loadImages(this.files)">
                                <div id="ph-img" class="text-center text-gray-400 py-2"><i class="fa-solid fa-camera text-xl"></i></div>
                                <div id="prev-img" class="hidden w-full relative p-2">
                                    <div id="img-grid" class="grid grid-cols-3 gap-1"></div>
                                    <button onclick="clearFile(event, 'IMG')" class="absolute -top-3 -right-2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition bg-white rounded-full shadow"><i class="fa-solid fa-times-circle text-xl"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="text-input-zone" class="flex-1 flex flex-col min-h-[100px]">
                        <div class="flex justify-between items-center mb-1">
                            <label id="label-prompt" class="text-[10px] font-bold uppercase text-gray-400">Notes / Instructions</label>
                            <button onclick="toggleDictation()" id="mic-btn" class="text-[10px] font-bold text-gray-400 hover:text-red-500 flex items-center gap-1"><i class="fa-solid fa-microphone"></i></button>
                        </div>
                        
                        <div id="quick-tags" class="flex flex-wrap gap-1 mb-2 hidden"></div>
                        
                        <textarea id="prompt-input" class="w-full p-3 border border-gray-200 rounded-lg text-xs flex-1 resize-none outline-none focus:border-slate-800 bg-slate-50 focus:bg-white transition" placeholder="Instructions..."></textarea>
                    </div>
                    <button onclick="runAI()" id="run-btn" class="w-full py-4 bg-slate-900 text-white rounded-lg font-bold text-xs shadow-lg hover:bg-slate-800 transition transform active:scale-95 flex-shrink-0 mt-auto">LANCER</button>
                </div>
            </div>

            <div class="flex-1 overflow-hidden relative bg-gray-600 flex flex-col">
                <div id="sheet-wrapper" class="sheet-container">
                    <div class="paper-sheet relative">
                        <div id="loader" class="hidden absolute inset-0 bg-white/95 flex flex-col items-center justify-center z-10 rounded-xl"><div class="w-10 h-10 border-4 border-slate-200 border-t-slate-800 rounded-full animate-spin mb-4"></div><span class="text-[10px] font-bold uppercase tracking-widest text-slate-500">Traitement...</span></div>
                        <div id="result-output" contenteditable="true" class="markdown-body"></div>
                        <div id="empty-state" class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-10"><i class="fa-solid fa-print text-9xl"></i></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <aside id="right-panel" class="hidden md:flex w-72 bg-white border-l border-gray-200 flex-col z-20">
        <div class="flex-1 flex flex-col overflow-hidden border-b border-gray-200"><div class="p-4 bg-slate-50 border-b border-gray-200 flex justify-between items-center"><span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">PROJETS DE L'AGENCE</span><button onclick="openProjectModal()" class="bg-slate-900 text-white w-6 h-6 rounded flex items-center justify-center hover:bg-slate-700 shadow"><i class="fa-solid fa-plus text-xs"></i></button></div><div id="folder-list" class="flex-1 overflow-y-auto"></div></div>
        <div class="h-2/5 flex flex-col overflow-hidden"><div class="p-3 bg-slate-50 border-b border-gray-200 flex justify-between items-center"><span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">DOCUMENTS PARTAGÉS</span></div><div id="file-list" class="flex-1 overflow-y-auto bg-slate-50/50"></div></div>
    </aside>

    <div id="right-panel-mobile" class="hidden fixed inset-0 z-50 bg-black/50 md:hidden justify-end">
        <aside class="w-4/5 h-full bg-white shadow-2xl flex flex-col">
            <div class="p-4 bg-slate-100 border-b border-gray-200 flex justify-between items-center">
                <span class="font-bold text-slate-700">Dossiers & Fichiers</span>
                <button onclick="toggleRightPanel()" class="text-slate-500"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="flex-1 flex flex-col overflow-hidden border-b border-gray-200">
                <div class="p-3 bg-slate-50 flex justify-between items-center"><span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">PROJETS</span><button onclick="openProjectModal()" class="bg-slate-900 text-white w-6 h-6 rounded flex items-center justify-center hover:bg-slate-700 shadow"><i class="fa-solid fa-plus text-xs"></i></button></div>
                <div id="folder-list-mobile" class="flex-1 overflow-y-auto"></div>
            </div>
            <div class="h-1/2 flex flex-col overflow-hidden">
                <div class="p-3 bg-slate-50 flex justify-between items-center"><span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">DOCUMENTS</span></div>
                <div id="file-list-mobile" class="flex-1 overflow-y-auto bg-slate-50/50"></div>
            </div>
        </aside>
    </div>

    <div id="chat-widget" class="hidden fixed bottom-20 right-6 w-96 h-[500px] bg-white rounded-xl shadow-2xl z-50 flex-col overflow-hidden border border-slate-200">
        <div class="bg-slate-900 text-white p-4 flex justify-between items-center">
            <h3 class="font-bold text-sm"><i class="fa-solid fa-helmet-safety text-yellow-400 mr-2"></i> Expert BTP</h3>
            <button onclick="toggleChat()" class="text-white hover:text-slate-300"><i class="fa-solid fa-times"></i></button>
        </div>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 bg-slate-50 flex flex-col">
            <div class="chat-bubble-bot">Bonjour ! Je suis BatiPilot. Posez-moi une question technique (DTU, matériaux, règles de l'art).</div>
        </div>
        <div class="p-3 bg-white border-t border-slate-200">
            <div class="flex gap-2">
                <input type="text" id="chat-input" class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-xs focus:border-blue-500 outline-none" placeholder="Ex: Hauteur garde-corps ?" onkeypress="if(event.key === 'Enter') sendChatMessage()">
                <button onclick="sendChatMessage()" class="bg-blue-600 text-white rounded-lg px-3 hover:bg-blue-700 transition"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
            <div class="text-[9px] text-slate-400 text-center mt-2">
                <span id="chat-count">0</span>/<span id="chat-limit">20</span> questions
            </div>
        </div>
    </div>

    <button onclick="toggleChat()" class="fixed bottom-6 right-6 w-12 h-12 bg-blue-600 text-white rounded-full shadow-xl hover:bg-blue-700 transition z-40 flex items-center justify-center transform hover:scale-110">
        <i class="fa-regular fa-comment-dots text-xl"></i>
    </button>

    <div id="project-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl w-96 shadow-2xl">
            <h3 class="font-bold text-lg mb-4">Nouveau Projet</h3>
            <label class="text-[10px] font-bold uppercase text-gray-400 mb-1 block">Nom du projet</label>
            <input id="new-project-name" type="text" class="w-full border-b-2 border-gray-200 py-2 mb-4 font-bold outline-none focus:border-blue-500" placeholder="Ex: Rénovation Villa Martin">
            <label class="text-[10px] font-bold uppercase text-gray-400 mb-1 block">Adresse du projet (Optionnel)</label>
            <input id="new-project-address" type="text" class="w-full border-b-2 border-gray-200 py-2 mb-6 outline-none focus:border-blue-500" placeholder="Ex: 12 Route de la Plage, 85100">
            <p class="text-[10px] font-bold uppercase text-gray-400 mb-2">Couleur de repère</p>
            <div class="flex justify-between mb-6" id="color-picker">
                <div class="color-swatch bg-blue-500 selected" data-color="blue" onclick="selectColor(this)"></div>
                <div class="color-swatch bg-emerald-500" data-color="emerald" onclick="selectColor(this)"></div>
                <div class="color-swatch bg-orange-500" data-color="orange" onclick="selectColor(this)"></div>
                <div class="color-swatch bg-purple-500" data-color="purple" onclick="selectColor(this)"></div>
                <div class="color-swatch bg-pink-500" data-color="pink" onclick="selectColor(this)"></div>
                <div class="color-swatch bg-slate-500" data-color="slate" onclick="selectColor(this)"></div>
            </div>
            <div class="flex gap-2">
                <button onclick="closeProjectModal()" class="flex-1 bg-gray-100 py-2 rounded text-xs font-bold">Annuler</button>
                <button onclick="createNewProject()" class="flex-1 bg-black text-white py-2 rounded text-xs font-bold shadow">Créer le projet</button>
            </div>
        </div>
    </div>
    
    <div id="config-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl w-[450px] shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-xl">Espace Agence</h3>
                <button onclick="UI.toggleConfig()" class="text-gray-400 hover:text-black"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="space-y-4 mb-6">
                <div>
                    <label class="text-[10px] font-bold uppercase text-gray-400 block mb-1">Logo officiel de votre entreprise</label>
                    <input type="file" accept="image/*" class="text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 w-full" onchange="encodeImg(this, 'logo')">
                    <img id="cfg-logo-preview" class="mt-2 h-12 object-contain hidden border border-gray-200 p-1 rounded">
                </div>
                <div><label class="text-[10px] font-bold uppercase text-gray-400 block mb-1">Nom de l'entreprise</label><input id="cfg-name" type="text" class="w-full border border-gray-300 rounded px-3 py-2 text-sm font-bold outline-none focus:border-blue-500"></div>
                <div><label class="text-[10px] font-bold uppercase text-gray-400 block mb-1">Adresse complète</label><input id="cfg-address" type="text" class="w-full border border-gray-300 rounded px-3 py-2 text-sm outline-none focus:border-blue-500"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-bold uppercase text-gray-400 block mb-1">Code Postal</label><input id="cfg-zip" type="text" class="w-full border border-gray-300 rounded px-3 py-2 text-sm outline-none focus:border-blue-500"></div>
                    <div><label class="text-[10px] font-bold uppercase text-gray-400 block mb-1">Ville</label><input id="cfg-city" type="text" class="w-full border border-gray-300 rounded px-3 py-2 text-sm outline-none focus:border-blue-500"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-bold uppercase text-gray-400 block mb-1">Téléphone</label><input id="cfg-phone" type="text" class="w-full border border-gray-300 rounded px-3 py-2 text-sm outline-none focus:border-blue-500"></div>
                    <div><label class="text-[10px] font-bold uppercase text-gray-400 block mb-1">Email</label><input id="cfg-email" type="text" class="w-full border border-gray-300 rounded px-3 py-2 text-sm outline-none focus:border-blue-500"></div>
                </div>
                <button onclick="saveConfig()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg text-xs hover:bg-blue-700 transition shadow-md shadow-blue-600/20 mt-2">ENREGISTRER SUR LE CLOUD</button>
            </div>
            
            <div id="collab-section" class="border-t border-gray-100 pt-6 mb-6 hidden">
                <h4 class="font-bold text-sm mb-3"><i class="fa-solid fa-users text-purple-600"></i> Créer un accès Collaborateur</h4>
                <div class="bg-purple-50 p-4 rounded-lg border border-purple-100">
                    <p class="text-[10px] text-purple-600 mb-3 leading-tight">En tant qu'Admin, vous pouvez créer des accès pour vos collaborateurs.</p>
                    <input type="email" id="new-user-email" class="w-full border border-gray-300 rounded px-3 py-2 text-sm mb-3 outline-none focus:border-purple-500" placeholder="collab@agence.fr">
                    <input type="text" id="new-user-pass" class="w-full border border-gray-300 rounded px-3 py-2 text-sm mb-3 outline-none focus:border-purple-500" placeholder="MotDePasse123">
                    <button onclick="createCollaborator()" class="w-full bg-purple-700 text-white font-bold py-2 rounded text-xs hover:bg-purple-800 transition shadow">CRÉER L'ACCÈS COLLABORATEUR</button>
                    <p id="create-user-msg" class="text-xs text-center mt-2 font-bold hidden"></p>
                </div>
            </div>
            
            <div id="upgrade-msg" class="border-t border-gray-100 pt-6 mb-6 hidden">
                <h4 class="font-bold text-sm mb-3 text-slate-400"><i class="fa-solid fa-users-slash mr-2"></i> Collaborateurs</h4>
                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 text-center">
                    <p class="text-xs text-slate-500 mb-2">Cette fonctionnalité est réservée au plan Agence.</p>
                    <a href="index.html#pricing" class="text-[10px] font-bold text-blue-600 uppercase hover:underline">Passer au plan Agence</a>
                </div>
            </div>

            <div class="border-t border-gray-100 pt-6 mb-6">
                <h4 class="font-bold text-sm mb-3 text-slate-700">Aide & Contact</h4>
                <div class="grid grid-cols-2 gap-3">
                    <a href="mailto:support@batipilot.app?subject=Demande d'aide technique" class="flex items-center justify-center gap-2 bg-slate-100 text-slate-700 py-2.5 rounded-lg text-xs font-bold hover:bg-slate-200 transition">
                        <i class="fa-solid fa-headset"></i> Support
                    </a>
                    <a href="mailto:support@batipilot.app?subject=Suggestion d'amélioration" class="flex items-center justify-center gap-2 bg-emerald-50 text-emerald-700 py-2.5 rounded-lg text-xs font-bold hover:bg-emerald-100 transition border border-emerald-100">
                        <i class="fa-solid fa-lightbulb"></i> Suggestion
                    </a>
                </div>
            </div>

            <div class="border-t border-gray-100 pt-6">
                <button onclick="logoutApp()" class="w-full bg-red-50 text-red-600 py-3 rounded-lg text-xs font-bold hover:bg-red-100 transition border border-red-200"><i class="fa-solid fa-power-off mr-1"></i> DÉCONNEXION DE BATI-PILOT</button>
            </div>
        </div>
    </div>
    
    <div id="admin-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl w-[600px] max-h-[80vh] overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                <h3 class="font-black text-xl text-red-600"><i class="fa-solid fa-user-shield mr-2"></i> SUPER ADMIN</h3>
                <button onclick="document.getElementById('admin-modal').classList.add('hidden')" class="text-gray-400 hover:text-black"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-bold text-sm text-slate-700 uppercase"><i class="fa-solid fa-plus-circle text-green-500 mr-2"></i> Créer une Agence manuellement</h4>
                    <button onclick="document.getElementById('admin-create-form').classList.toggle('hidden')" class="text-xs text-blue-600 font-bold hover:underline">Afficher/Masquer</button>
                </div>
                
                <div id="admin-create-form" class="hidden space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <input id="admin-new-name" type="text" placeholder="Nom de l'Agence" class="w-full border border-gray-300 rounded px-3 py-2.5 text-xs">
                        <select id="admin-new-plan" class="w-full border border-gray-300 rounded px-3 py-2.5 text-xs font-bold bg-white">
                            <option value="solo">Plan SOLO</option>
                            <option value="agency">Plan AGENCE</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <input id="admin-new-email" type="email" placeholder="Email du client" class="w-full border border-gray-300 rounded px-3 py-2.5 text-xs">
                        <input id="admin-new-pass" type="text" placeholder="Mot de passe provisoire" class="w-full border border-gray-300 rounded px-3 py-2.5 text-xs">
                    </div>
                    <button onclick="adminCreateUser()" class="w-full bg-green-600 text-white font-bold py-2 rounded text-xs hover:bg-green-700 shadow">CRÉER LE COMPTE MAINTENANT</button>
                    <p id="admin-create-msg" class="text-center text-xs font-bold hidden"></p>
                </div>
            </div>

            <div class="mb-4">
                <h4 class="font-bold text-sm uppercase text-slate-500 mb-2">Liste des Agences inscrites</h4>
                <div id="admin-agency-list" class="space-y-2">
                    <p class="text-xs text-slate-400">Chargement...</p>
                </div>
            </div>
        </div>
    </div>

    <button id="btn-open-admin" onclick="openAdminPanel()" class="hidden fixed bottom-4 left-4 z-50 bg-red-600 text-white w-10 h-10 rounded-full shadow-lg hover:bg-red-700 font-bold border-2 border-white flex items-center justify-center transition hover:scale-110" title="Panneau Admin">
        <i class="fa-solid fa-lock"></i>
    </button>
    
    <div id="toast-container" class="bg-slate-900 text-white px-5 py-3 rounded-lg shadow-xl flex items-center gap-3"><span id="toast-msg" class="text-xs font-bold">OK</span></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDOjXwxvmllhEW79ldTSSB-U_NbjOBvkms", authDomain: "archiadmin-6be75.firebaseapp.com", projectId: "archiadmin-6be75", storageBucket: "archiadmin-6be75.firebasestorage.app", messagingSenderId: "126740785188", appId: "1:126740785188:web:a0c2241767bc191f2d50b1" };
        firebase.initializeApp(firebaseConfig); const auth = firebase.auth(); const db = firebase.firestore();

        let folders = []; let docs = []; let config = {name: "AGENCE"}; let currentFolder = "Général"; let currentMode = "plu", inputA = "", inputB = "", inputImgs = [], selectedColor = 'blue';
        let currentAgencyId = null; let currentUserRole = "user"; let currentAgencyPlan = "solo";

        // GESTION MOBILE
        function toggleSidebar() {
            const sidebar = document.getElementById('main-sidebar');
            const overlay = document.getElementById('mobile-overlay');
            if (sidebar.classList.contains('sidebar-mobile-open')) {
                sidebar.classList.remove('sidebar-mobile-open');
                sidebar.classList.add('sidebar-mobile-closed');
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            } else {
                sidebar.classList.add('sidebar-mobile-open');
                sidebar.classList.remove('sidebar-mobile-closed');
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            }
        }

        function toggleRightPanel() {
            const panel = document.getElementById('right-panel-mobile');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                panel.classList.add('flex');
            } else {
                panel.classList.add('hidden');
                panel.classList.remove('flex');
            }
        }

        // --- NOUVELLES FONCTIONS UX MOBILE ROBUSTE ---
        
        // Expose la fonction globalement pour être sûr que le onclick HTML la trouve
        window.showMobileInputs = function() {
            // On ne fait rien sur PC
            if (window.innerWidth >= 768) return; 
            
            const wrapper = document.getElementById('mobile-input-wrapper');
            const btnEdit = document.getElementById('mobile-edit-btn');
            
            // On affiche le wrapper
            if (wrapper) wrapper.classList.remove('hidden');
            
            // On cache le bouton
            if (btnEdit) btnEdit.classList.add('hidden');
            
            // Scroll fluide vers le haut pour voir le formulaire
            const leftPanel = document.getElementById('left-panel');
            if(leftPanel) {
                leftPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        // ----------------------------------------------

        // GESTION DES TAGS RAPIDES
        const modeTags = {
            legal: ["Mise en demeure sous 48h", "Ton très ferme", "Rappel aux normes DTU", "Menace de pénalités de retard"],
            cctp: ["Matériaux biosourcés", "Gamme Premium / Haut de gamme", "Respect strict RE2020", "Variantes interdites"],
            report: ["Focus Sécurité sur chantier", "Retard constaté sur le planning", "Problème d'approvisionnement", "Chantier propre"],
            permit: ["Style architectural contemporain", "Intégration paysagère soignée", "Toiture tuile terre cuite", "Menuiseries Aluminium RAL 7016"],
            devis: ["Acompte de 30% à la signature", "Paiement à 30 jours", "TVA réduite applicable"],
            snag: ["Retenue de garantie applicable", "Intervention urgente requise", "Refus de réception en l'état"]
        };

        // --- TRADUCTION DES MODES POUR L'AFFICHAGE ---
        const modeLabels = {
            plu: "PLU",
            soil: "Étude de Sol",
            control: "Contrôle",
            acoustic: "Acoustique",
            cctp: "CCTP",
            dpgf: "DPGF",
            devis: "Devis",
            meeting: "Réunion",
            report: "Rapport",
            situation: "Situation",
            snag: "Réserves",
            planning: "Planning",
            expertise: "Normes",
            legal: "Courrier",
            permit: "Permis"
        };
        
        // --- COULEURS DES BADGES (NOUVEAU) ---
        const modeColors = {
            // BLEU (Technique / Architecture)
            plu: "bg-blue-100 text-blue-800 border-blue-200",
            cctp: "bg-blue-100 text-blue-800 border-blue-200",
            dpgf: "bg-teal-100 text-teal-800 border-teal-200",
            devis: "bg-teal-100 text-teal-800 border-teal-200",

            // AMBRE (Sol / Terrain)
            soil: "bg-amber-100 text-amber-800 border-amber-200",

            // ROUGE (Contrôle / Sécurité)
            control: "bg-red-100 text-red-800 border-red-200",

            // INDIGO (Acoustique)
            acoustic: "bg-indigo-100 text-indigo-800 border-indigo-200",

            // ORANGE (Chantier)
            meeting: "bg-orange-100 text-orange-800 border-orange-200",
            report: "bg-orange-100 text-orange-800 border-orange-200",
            situation: "bg-orange-100 text-orange-800 border-orange-200",
            snag: "bg-orange-100 text-orange-800 border-orange-200",
            planning: "bg-orange-100 text-orange-800 border-orange-200",

            // GRIS (Administratif)
            expertise: "bg-slate-100 text-slate-700 border-slate-200",
            legal: "bg-slate-100 text-slate-700 border-slate-200",
            permit: "bg-slate-100 text-slate-700 border-slate-200"
        };

        function addTag(el, tag) {
            const input = document.getElementById('prompt-input');
            input.value = input.value ? input.value + " | " + tag : tag;
            el.style.opacity = '0.5';
            el.style.pointerEvents = 'none';
        }

        function exportWord() {
            const contentElement = document.getElementById('result-output');
            if(!contentElement.innerHTML) return;

            const clone = contentElement.cloneNode(true);
            const images = clone.getElementsByTagName('img');
            
            let imageContent = "";
            let boundary = "mht_boundary_line";
            
            for (let i = 0; i < images.length; i++) {
                let img = images[i];
                let src = img.src;
                if (src.startsWith('data:image')) {
                    let parts = src.split(',');
                    let mimeType = parts[0].match(/:(.*?);/)[1];
                    let base64Data = parts[1];
                    let ext = mimeType.split('/')[1];
                    let imgName = 'image' + i + '.' + ext;
                    
                    img.src = imgName;
                    img.style.maxWidth = "100%";
                    img.style.height = "auto";
                    
                    imageContent += "--" + boundary + "\n";
                    imageContent += "Content-Location: " + imgName + "\n";
                    imageContent += "Content-Type: " + mimeType + "\n";
                    imageContent += "Content-Transfer-Encoding: base64\n\n";
                    imageContent += base64Data + "\n\n";
                }
            }

            let htmlContent = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export BatiPilot</title><style>body{font-family: Arial, sans-serif;} table{border-collapse:collapse;width:100%;} th,td{border:1px solid #000;padding:5px;} img{max-width:100%; height:auto; display:block; margin: 10px 0;}</style></head><body>${clone.innerHTML}</body></html>`;

            let mhtml = "MIME-Version: 1.0\n";
            mhtml += "Content-Type: multipart/related; boundary=\"" + boundary + "\"\n\n";
            mhtml += "--" + boundary + "\n";
            mhtml += "Content-Type: text/html; charset=\"utf-8\"\n";
            mhtml += "Content-Transfer-Encoding: 8bit\n\n";
            mhtml += htmlContent + "\n\n";
            mhtml += imageContent;
            mhtml += "--" + boundary + "--";

            const blob = new Blob([mhtml], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const filename = (currentFolder || 'Document_BatiPilot') + '_' + currentMode + '.doc';
            const downloadLink = document.createElement("a");
            downloadLink.href = url;
            downloadLink.download = filename;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url);
        }

        auth.onAuthStateChanged(async user => {
            const MY_ADMIN_EMAIL = "bretonniere.damien@gmail.com"; 
            
            if (user && user.email === MY_ADMIN_EMAIL) {
                document.getElementById('btn-open-admin').classList.remove('hidden');
            }

            if (user) {
                document.getElementById('login-screen').style.opacity = '0'; setTimeout(() => document.getElementById('login-screen').classList.add('hidden'), 500); document.getElementById('current-user-email').innerText = user.email;
                try {
                    const userDoc = await db.collection("users").doc(user.uid).get();
                    if (!userDoc.exists) {
                        const newAgencyRef = await db.collection("agencies").add({ 
                            name: "Nouvelle Agence", 
                            plan: "solo", 
                            ownerEmail: user.email,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp() 
                        });
                        currentAgencyId = newAgencyRef.id; currentUserRole = "admin"; currentAgencyPlan = "solo";
                        await db.collection("users").doc(user.uid).set({ email: user.email, agencyId: currentAgencyId, role: currentUserRole });
                        await db.collection("agencies").doc(currentAgencyId).collection("folders").doc("Général").set({name: "Général", address: "", color: "blue"});
                    } else {
                        const userData = userDoc.data(); currentAgencyId = userData.agencyId; currentUserRole = userData.role;
                        const agencyDoc = await db.collection("agencies").doc(currentAgencyId).get(); if(agencyDoc.exists) currentAgencyPlan = agencyDoc.data().plan || "solo";
                    }
                    
                    document.getElementById('current-user-role').innerText = currentUserRole.toUpperCase();
                    document.getElementById('current-plan-badge').innerText = "PLAN " + currentAgencyPlan.toUpperCase();
                    document.getElementById('current-plan-badge').className = currentAgencyPlan === "agency" ? "bg-purple-100 text-purple-700 px-2 py-0.5 rounded font-bold text-[8px]" : "bg-slate-200 text-slate-700 px-2 py-0.5 rounded font-bold text-[8px]";
                    
                    const collabSection = document.getElementById('collab-section');
                    const upgradeMsg = document.getElementById('upgrade-msg');
                    
                    if(currentUserRole === 'admin' && currentAgencyPlan === 'agency') { 
                        collabSection.classList.remove('hidden'); 
                        upgradeMsg.classList.add('hidden');
                    } else { 
                        collabSection.classList.add('hidden'); 
                        if(currentUserRole === 'admin') upgradeMsg.classList.remove('hidden');
                    }
                    
                    document.getElementById('chat-limit').innerText = currentAgencyPlan === 'agency' ? '100' : '20';
                    
                    loadDataFromFirebase();
                } catch (error) { console.error(error); }
            } else { document.getElementById('login-screen').classList.remove('hidden'); document.getElementById('login-screen').style.opacity = '1'; document.getElementById('current-user-email').innerText = "Non connecté"; currentAgencyId = null; }
        });

        function loginApp() { const email = document.getElementById('login-email').value; const pass = document.getElementById('login-pass').value; const errorP = document.getElementById('login-error'); const btn = document.getElementById('btn-login'); if(!email || !pass) return; btn.innerText = "CONNEXION EN COURS..."; auth.signInWithEmailAndPassword(email, pass).then(() => { errorP.classList.add('hidden'); btn.innerText = "SE CONNECTER"; document.getElementById('login-pass').value = ''; }).catch((error) => { errorP.innerText = "Identifiants incorrects."; errorP.classList.remove('hidden'); btn.innerText = "SE CONNECTER"; }); }
        
        function logoutApp() { 
            auth.signOut().then(() => { 
                window.location.href = "index.html"; 
            }); 
        }
        
        function createCollaborator() { const email = document.getElementById('new-user-email').value; const pass = document.getElementById('new-user-pass').value; const msg = document.getElementById('create-user-msg'); if(!email || !pass || !currentAgencyId) return; msg.classList.remove('hidden'); msg.className = "text-xs text-center mt-2 font-bold text-blue-500"; msg.innerText = "Création en cours..."; let secondaryApp; try { secondaryApp = firebase.app("SecondaryApp"); } catch (e) { secondaryApp = firebase.initializeApp(firebaseConfig, "SecondaryApp"); } secondaryApp.auth().createUserWithEmailAndPassword(email, pass).then(async (userCredential) => { const newUid = userCredential.user.uid; await db.collection("users").doc(newUid).set({ email: email, agencyId: currentAgencyId, role: "user" }); secondaryApp.auth().signOut(); msg.className = "text-xs text-center mt-2 font-bold text-emerald-500"; msg.innerText = "Accès créé !"; document.getElementById('new-user-email').value = ""; document.getElementById('new-user-pass').value = ""; setTimeout(() => msg.classList.add('hidden'), 5000); }).catch(error => { msg.className = "text-xs text-center mt-2 font-bold text-red-500"; msg.innerText = "Erreur."; }); }
        
        function loadDataFromFirebase() { if(!currentAgencyId) return; db.collection("agencies").doc(currentAgencyId).onSnapshot(doc => { if (doc.exists) { const data = doc.data(); if(data.config) { config = data.config; applyConfigUI(); } } }); db.collection("agencies").doc(currentAgencyId).collection("folders").onSnapshot(snap => { folders = []; snap.forEach(doc => folders.push(doc.data())); if (folders.length > 0) { if (!folders.find(f => f.name === currentFolder)) { currentFolder = folders[0].name; } renderFolders(); renderDocs(); } }); db.collection("agencies").doc(currentAgencyId).collection("docs").orderBy("id", "desc").onSnapshot(snap => { docs = []; snap.forEach(doc => docs.push(doc.data())); renderDocs(); }); }
        function applyConfigUI() { document.getElementById('cfg-name').value = config.name || ''; document.getElementById('cfg-address').value = config.address || ''; document.getElementById('cfg-zip').value = config.zip || ''; document.getElementById('cfg-city').value = config.city || ''; document.getElementById('cfg-phone').value = config.phone || ''; document.getElementById('cfg-email').value = config.email || ''; if(config.logo) { const img = document.getElementById('cfg-logo-preview'); img.src = config.logo; img.classList.remove('hidden'); } }
        function getHeaderHTML() { let logoContent = config.logo ? `<img src="${config.logo}" style="max-height: 50px; max-width: 180px; object-fit: contain;">` : `<h2 style="margin:0; font-size: 20px; font-weight: 900; color: #0F172A; text-transform: uppercase; letter-spacing: -0.5px;">${config.name || 'AGENCE'}</h2>`; const projInfo = folders.find(f => f.name === currentFolder) || {}; const projName = projInfo.name || currentFolder; const projAddressHTML = projInfo.address ? `<div style="font-size: 11px; color: #475569; margin-top: 4px;"><i class="fa-solid fa-location-dot" style="margin-right: 5px; color: #3B82F6;"></i>${projInfo.address}</div>` : ""; const cpVilleHtml = `${config.zip || ''} ${config.city || ''}`.trim(); return `<div style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #E2E8F0; padding-bottom: 20px; margin-bottom: 25px;"><div style="flex: 0 0 50%;">${logoContent}</div><div style="flex: 0 0 50%; text-align: right; font-size: 10px; color: #64748B; line-height: 1.5; font-family: 'Inter', sans-serif;"><strong style="color: #0F172A; font-size: 12px; text-transform: uppercase;">${config.name || 'AGENCE'}</strong><br>${config.address ? `${config.address}<br>` : ''}${cpVilleHtml ? `${cpVilleHtml}<br>` : ''}${config.phone ? `${config.phone} &bull; ` : ''} ${config.email ? `${config.email}` : ''}</div></div><div style="margin-bottom: 30px; padding: 15px 20px; background-color: #F8FAFC; border-left: 4px solid #3B82F6; border-radius: 4px;"><div style="font-size: 9px; color: #64748B; text-transform: uppercase; font-weight: bold; letter-spacing: 1px; margin-bottom: 4px;">Dossier Projet</div><h3 style="margin:0; font-size: 16px; font-weight: 800; color: #0F172A; text-transform: uppercase;">${projName}</h3>${projAddressHTML}</div>`; }
        
        // RENDER FOLDERS (DESKTOP & MOBILE)
        function renderFolders() { 
            const listDesktop = document.getElementById('folder-list'); 
            const listMobile = document.getElementById('folder-list-mobile');
            listDesktop.innerHTML = ""; 
            listMobile.innerHTML = "";

            folders.forEach(f => { 
                const div = document.createElement('div'); 
                const colorClass = `border-l-${f.color}-500`; 
                const bgClass = f.name === currentFolder ? `bg-${f.color}-50` : ''; 
                const textClass = f.name === currentFolder ? `text-${f.color}-700` : 'text-slate-600'; 
                div.className = `folder-item ${bgClass} ${textClass} ${f.name === currentFolder ? colorClass : 'border-l-transparent'}`; 
                let html = `<span onclick="selectFolder('${f.name}')" class="truncate flex items-center gap-2"><i class="fa-regular fa-folder opacity-50"></i> ${f.name}</span>`; 
                if(f.name !== "Général" && f.name !== "General") { html += `<i onclick="deleteFolder('${f.name}')" class="fa-solid fa-times opacity-20 hover:opacity-100 hover:text-red-500"></i>`; } 
                div.innerHTML = html; 
                
                // Append to desktop and clone for mobile
                listDesktop.appendChild(div);
                listMobile.appendChild(div.cloneNode(true));
            }); 
            document.getElementById('active-project-display').innerText = currentFolder; 
        }

        // RENDER DOCS (DESKTOP & MOBILE)
        function renderDocs() { 
            const listDesktop = document.getElementById('file-list'); 
            const listMobile = document.getElementById('file-list-mobile');
            listDesktop.innerHTML = ""; 
            listMobile.innerHTML = "";

            const filtered = docs.filter(d => d.folder === currentFolder); 
            
            // Empty state
            if(filtered.length === 0) { 
                const noDoc = "<p class='text-[10px] text-slate-300 text-center mt-4'>Aucun document</p>";
                listDesktop.innerHTML = noDoc;
                listMobile.innerHTML = noDoc;
                return; 
            } 

            filtered.forEach(d => { 
                // TRADUCTION DU LABEL (Nouveau code)
                const label = modeLabels[d.mode] || d.mode;
                
                // COULEUR DU LABEL (Nouveau code)
                const colorClass = modeColors[d.mode] || "bg-blue-100 text-blue-800 border-blue-200";

                // Common HTML content
                const htmlContent = `<div class="flex justify-between items-center mb-2"><span class="uppercase text-[10px] font-black ${colorClass} px-2 py-0.5 rounded shadow-sm border truncate max-w-[65%]">${label}</span><span class="text-[9px] font-bold text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded flex items-center"><i class="fa-regular fa-calendar-days mr-1 opacity-70"></i>${d.date}</span></div><div class="flex justify-between items-center"><span class="text-[11px] font-bold text-slate-700 group-hover:text-blue-700 transition flex items-center"><i class="fa-solid fa-file-lines text-slate-400 group-hover:text-blue-500 mr-1.5"></i> Consulter le document</span><button onclick="event.stopPropagation(); deleteDoc('${d.id}')" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition p-1"><i class="fa-solid fa-trash"></i></button></div>`;

                // Desktop Element
                const divDesktop = document.createElement('div'); 
                divDesktop.className = "file-item group"; 
                divDesktop.innerHTML = htmlContent;
                divDesktop.onclick = () => { loadDoc(d.id); }; // Just load
                listDesktop.appendChild(divDesktop);

                // Mobile Element
                const divMobile = document.createElement('div'); 
                divMobile.className = "file-item group"; 
                divMobile.innerHTML = htmlContent;
                divMobile.onclick = () => { loadDoc(d.id); toggleRightPanel(); }; // Load AND Close panel
                listMobile.appendChild(divMobile);
            }); 
        }
        
        function createNewProject() { if(!currentAgencyId) return; const name = document.getElementById('new-project-name').value; const address = document.getElementById('new-project-address').value; if(name && name.trim()) { const cleanName = name.trim(); if(!folders.find(f => f.name === cleanName)) { db.collection("agencies").doc(currentAgencyId).collection("folders").doc(cleanName).set({ name: cleanName, address: address ? address.trim() : "", color: selectedColor }); selectFolder(cleanName); closeProjectModal(); document.getElementById('new-project-name').value = ""; document.getElementById('new-project-address').value = ""; } else { alert("Ce projet existe déjà."); } } }
        function deleteFolder(name) { if(!currentAgencyId) return; if(confirm("Supprimer ce projet et tous ses documents pour toute l'agence ?")) { db.collection("agencies").doc(currentAgencyId).collection("folders").doc(name).delete(); docs.filter(d => d.folder === name).forEach(d => { db.collection("agencies").doc(currentAgencyId).collection("docs").doc(d.id.toString()).delete(); }); } }
        function saveConfig() { if(!currentAgencyId || currentUserRole !== 'admin') { return alert("Seul l'administrateur peut modifier ces paramètres."); } config.name = document.getElementById('cfg-name').value; config.address = document.getElementById('cfg-address').value; config.zip = document.getElementById('cfg-zip').value; config.city = document.getElementById('cfg-city').value; config.phone = document.getElementById('cfg-phone').value; config.email = document.getElementById('cfg-email').value; db.collection("agencies").doc(currentAgencyId).update({ config: config }).then(() => { UI.toast("Agence synchronisée"); }); }
        function saveDocument() { if(!currentAgencyId) return; const content = document.getElementById('result-output').innerHTML; if(!content || content.length < 50) return; const docId = Date.now().toString(); const newDoc = { id: docId, folder: currentFolder, mode: currentMode, date: new Date().toLocaleDateString(), content: content }; db.collection("agencies").doc(currentAgencyId).collection("docs").doc(docId).set(newDoc).then(() => { UI.toast("Sauvegardé sur le Cloud"); }); }
        function deleteDoc(id) { if(!currentAgencyId || !id) return; if(confirm("Supprimer ce document pour toute l'agence ?")) { db.collection("agencies").doc(currentAgencyId).collection("docs").doc(id.toString()).delete(); } }
        function selectFolder(name) { currentFolder = name; renderFolders(); renderDocs(); } function openProjectModal() { document.getElementById('project-modal').classList.remove('hidden'); document.getElementById('new-project-name').focus(); } function closeProjectModal() { document.getElementById('project-modal').classList.add('hidden'); } function selectColor(el) { document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected')); el.classList.add('selected'); selectedColor = el.dataset.color; }
        
        async function locateZone() { const addr = document.getElementById('plu-address').value; if(!addr) return alert("Veuillez entrer une adresse."); try { const response = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(addr)}&limit=1`); const data = await response.json(); if (data.features && data.features.length > 0) { const coords = data.features[0].geometry.coordinates; window.open(`https://www.geoportail-urbanisme.gouv.fr/map/#tile=1&lon=${coords[0]}&lat=${coords[1]}&zoom=18`, '_blank'); } else alert("Adresse non trouvée."); } catch (e) { alert("Erreur réseau."); } }
        function getWeekNumber(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); return Math.ceil((((d - yearStart) / 86400000) + 1) / 7); }
        
        function formatModernText(text) { 
            let clean = text.replace(/```(?:markdown|html)?\n?/gi, '').replace(/```\n?/g, '').trim(); 
            let lines = clean.split('\n');
            let inTable = false;
            let htmlLines = [];
            let tableHTML = "";
            
            for(let i=0; i<lines.length; i++) {
                let line = lines[i].trim();
                if(line.startsWith('|') && line.endsWith('|')) {
                    if(!inTable) { inTable = true; tableHTML = '<div class="table-responsive"><table>'; }
                    if(line.replace(/\|/g, '').replace(/-/g, '').replace(/:/g, '').trim() === '') { continue; }
                    let cells = line.split('|'); cells.shift(); cells.pop();   
                    let isHeader = tableHTML === '<div class="table-responsive"><table>';
                    tableHTML += '<tr>';
                    cells.forEach(c => {
                        let content = c.trim();
                        let cellTag = isHeader ? 'th' : 'td';
                        if (content === '[ ]') { content = '<span style="font-size:16px; font-weight:bold; color:#94A3B8;">☐</span>'; } 
                        else if (content === '[X]' || content === '[x]') { content = '<span style="font-size:16px; font-weight:bold; color:#10B981;">☑</span>'; } 
                        else if (!isHeader && (content === 'X' || content === 'x')) { cellTag = 'td class="gantt-x"'; }
                        tableHTML += `<${cellTag}>${content}</${cellTag}>`;
                    });
                    tableHTML += '</tr>';
                } else {
                    if(inTable) { inTable = false; tableHTML += '</table></div>'; htmlLines.push(tableHTML); }
                    htmlLines.push(line);
                }
            }
            if(inTable) { tableHTML += '</table></div>'; htmlLines.push(tableHTML); }
            clean = htmlLines.join('\n');
            clean = clean.replace(/^# (.*$)/gim, '<h1>$1</h1>').replace(/^## (.*$)/gim, '<h2>$1</h2>').replace(/^### (.*$)/gim, '<h3>$1</h3>').replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>').replace(/\n/g, '<br>');
            clean = clean.replace(/<br><div class="table-responsive">/g, '<div class="table-responsive">').replace(/<\/div><br>/g, '</div>');
            return clean; 
        }

        function optimizeTable() { const table = document.querySelector('table'); if(!table) return; const rows = table.querySelectorAll('tr'); let lastPhase = ""; for(let i=1; i<rows.length; i++) { const cell = rows[i].cells[0]; if(currentMode === 'planning' && cell) { const txt = cell.innerText.trim(); if(txt === lastPhase && txt !== "") { cell.classList.add('grouped-cell'); } else { lastPhase = txt; } } } }

        const modeInfos = {
            plu: { t: "Analyse PLU (Localisée)", d: "Indiquez la Zone et l'Adresse pour une analyse contextuelle." },
            soil: { t: "Analyse d'Étude de Sol (G2)", d: "Extrait le type de fondations, la garde au gel et les risques majeurs du rapport géotechnique." },
            cctp: { t: "Analyse & Rédaction CCTP", d: "Générez un nouveau CCTP ou vérifiez les failles d'un CCTP existant." },
            devis: { t: "Devis d'honoraires & Comparatif", d: "Créez vos devis de Maîtrise d'Œuvre ou comparez les devis des artisans." },
            meeting: { t: "Compte-Rendu de Réunion", d: "Transformez vos notes brouillonnes en un tableau structuré (Décisions, Entreprises, Délais)." },
            situation: { t: "Situation", d: "Validation avancement." },
            report: { t: "Rapport de Chantier", d: "Compte-rendu avec photos." },
            snag: { t: "PV de Levée de Réserves", d: "Générez une liste de réserves avec cases à cocher par artisan à partir de vos photos." },
            planning: { t: "Planning Expert", d: "Calcul chronologique des phases Études ou Chantier." },
            expertise: { t: "Expertise", d: "Questions techniques DTU." },
            legal: { t: "Juridique & OS", d: "Rédigez formellement des Ordres de Service ou Mises en demeure." },
            permit: { t: "Notice & Cerfa", d: "Chargez vos images 3D/Façades pour rédiger la Notice ou trouver le Cerfa." },
            control: { t: "Bureau de Contrôle", d: "Audit réglementaire complet (Incendie, Évacuation, Désenfumage et Accessibilité PMR) sur Plan." },
            acoustic: { t: "Expert Acoustique", d: "Vérification des isolements (Façade, Cloisons) et points de vigilance phonique." },
            dpgf: { t: "Pré-Métré DPGF", d: "Extraction détaillée des quantitatifs et ouvrages depuis votre plan pour préparer le budget." }
        };

        function clearFile(e, slot) { if(e) e.stopPropagation(); if (slot === 'A') { inputA = ""; document.getElementById('input-a').value = ""; document.getElementById('ok-a').classList.add('hidden'); document.getElementById('ph-a').classList.remove('hidden'); } else if (slot === 'B') { inputB = ""; document.getElementById('input-b').value = ""; document.getElementById('ok-b').classList.add('hidden'); document.getElementById('ph-b').classList.remove('hidden'); } else if (slot === 'IMG') { inputImgs = []; document.getElementById('input-img').value = ""; document.getElementById('prev-img').classList.add('hidden'); document.getElementById('ph-img').classList.remove('hidden'); document.getElementById('img-grid').innerHTML = ""; } }
        async function loadFile(input, slot) { const file = input.files[0]; if(!file) return; const okDiv = document.getElementById(`ok-${slot.toLowerCase()}`); const nameSpan = document.getElementById(`name-${slot.toLowerCase()}`); document.getElementById(`ph-${slot.toLowerCase()}`).classList.add('hidden'); nameSpan.innerText = "Lecture..."; okDiv.classList.remove('hidden'); setTimeout(async () => { try { if(file.type.includes('pdf')) { const data=await file.arrayBuffer(); const pdf=await pdfjsLib.getDocument({data}).promise; let txt=""; for(let i=1;i<=pdf.numPages;i++) { txt+=(await (await pdf.getPage(i)).getTextContent()).items.map(s=>s.str).join(' '); } if(slot==='A') { inputA=txt; } else inputB=txt; } else { if(slot==='A') { inputA="[Image chargée]"; } } nameSpan.innerText = file.name; } catch(e) { nameSpan.innerText = "Erreur"; } }, 50); }
        function loadImages(files) { if(!files || files.length === 0) return; inputImgs=[]; const grid=document.getElementById('img-grid'); grid.innerHTML=""; document.getElementById('ph-img').classList.add('hidden'); document.getElementById('prev-img').classList.remove('hidden'); Array.from(files).forEach(f=>{ const r=new FileReader(); r.onload=e=>{ inputImgs.push(e.target.result.split(',')[1]); grid.innerHTML+=`<img src="${e.target.result}" class="h-10 w-full object-cover rounded border">`; }; r.readAsDataURL(f); }); }

        function toggleDevisInput(id) { const cb = document.getElementById('phase-' + id); const wrap = document.getElementById('wrap-amount-' + id); if(cb.checked) { wrap.style.opacity = '1'; wrap.style.pointerEvents = 'auto'; } else { wrap.style.opacity = '0.3'; wrap.style.pointerEvents = 'none'; document.getElementById('amount-' + id).value = ''; } }

        function toggleDevisMode(mode) {
            const btnGen = document.getElementById('btn-devis-gen'); const btnAna = document.getElementById('btn-devis-ana');
            const secGen = document.getElementById('devis-gen-section'); const secAna = document.getElementById('devis-ana-section');
            if(mode === 'gen') {
                btnGen.className = "flex-1 py-2 text-[10px] font-bold uppercase rounded bg-white shadow text-blue-600 transition";
                btnAna.className = "flex-1 py-2 text-[10px] font-bold uppercase rounded text-slate-500 hover:text-slate-700 transition";
                secGen.classList.remove('hidden'); secGen.classList.add('flex');
                secAna.classList.add('hidden'); secAna.classList.remove('flex');
                document.getElementById('inputs-files').classList.add('d-none');
                document.getElementById('text-input-zone').classList.remove('d-none');
                document.getElementById('label-prompt').innerText = "Notes / Modalités de paiement spécifiques";
            } else {
                btnAna.className = "flex-1 py-2 text-[10px] font-bold uppercase rounded bg-white shadow text-slate-700 transition";
                btnGen.className = "flex-1 py-2 text-[10px] font-bold uppercase rounded text-slate-500 hover:text-slate-700 transition";
                secAna.classList.remove('hidden'); secAna.classList.add('flex');
                secGen.classList.add('hidden'); secGen.classList.remove('flex');
                document.getElementById('inputs-files').classList.remove('d-none');
                document.getElementById('zone-a').style.display = 'flex';
                document.getElementById('label-a').innerText = "CCTP (Ref) PDF";
                document.getElementById('zone-b').style.display = 'flex';
                document.getElementById('label-b').innerText = "Devis Entreprise (PDF)";
                document.getElementById('text-input-zone').classList.remove('d-none');
                document.getElementById('label-prompt').innerText = "Instructions (Ex: Vérifie spécifiquement les menuiseries)";
            }
        }

        function triggerDevisAction(action) {
            let instruction = "";
            if (action === 'generate') {
                const client = document.getElementById('devis-client').value || "[Nom du Client]";
                let phasesText = "";
                const phases = ['esq', 'aps', 'apd', 'dpc', 'pro', 'act', 'visa', 'det', 'aor'];
                phases.forEach(p => {
                    const cb = document.getElementById('phase-' + p);
                    if (cb && cb.checked) {
                        const amount = document.getElementById('amount-' + p).value || "À définir";
                        phasesText += `- ${cb.value} : ${amount} € HT\n`;
                    }
                });
                instruction = `ACTION: GENERATE_DEVIS\nCLIENT: ${client}\nPHASES ET PRIX:\n${phasesText}`;
            } else {
                instruction = `ACTION: ANALYZE_DEVIS`;
            }
            runAI(instruction);
        }

        function triggerPlanningAction(type) { const desc = document.getElementById('plan-desc').value || "Projet standard"; const dateVal = document.getElementById('plan-date').value; const lots = Array.from(document.querySelectorAll('#planning-form .checkbox-grid input:checked')).map(cb => cb.value).join(", "); let startWeek = "S01"; let year = new Date().getFullYear(); if(dateVal) { const d = new Date(dateVal); const w = getWeekNumber(d); year = d.getFullYear(); startWeek = `S${w < 10 ? '0'+w : w}`; } let instruction = ""; if (type === 'chantier') instruction = `AGIS COMME: Planificateur Expert BTP. PROJET: ${desc}. DÉBUT: Semaine ${startWeek} (${year}). LOTS: ${lots}. CONSIGNE: Tableau Markdown GANTT en cascade (waterfall). Une tâche commence quand la précédente finit. Ajoute "Séchage Maçonnerie" (3 sem) après Maçonnerie. Format: | Phase | Tâche | Durée (sem) | ${startWeek} | ... | Remplis avec 'X' les semaines actives, laisse vide sinon.`; else if (type === 'etudes') instruction = `AGIS COMME: Architecte Directeur. PROJET: ${desc}. DÉBUT: Semaine ${startWeek} (${year}). MISSION: Planning Loi MOP Client. Estime les durées selon l'ampleur "${desc}". CHRONOLOGIE STRICTE: 1.Relevé > 2.ESQ > 3.APS > 4.APD > 5.DPC > 6.Instruction Mairie (8-12 sem) > 7.PRO/DCE > 8.ACT. Format: | Phase | Tâche | Durée (sem) | ${startWeek} | ... | Remplis avec 'X' les semaines actives, laisse vide sinon.`; runAI(instruction); }
        
        function triggerControlAction(subMode) { 
            const reg = document.getElementById('ctrl-reg').value; 
            const type = document.getElementById('ctrl-type').value || "Non spécifié"; 
            const effectif = document.getElementById('ctrl-effectif').value; 
            let rulesContext = ""; 
            if(reg === "CDT") {
                rulesContext = `CADRE JURIDIQUE STRICT : CODE DU TRAVAIL (ERT - Établissement Recevant des Travailleurs). ⚠️ INTERDICTION FORMELLE D'APPLIQUER LA RÉGLEMENTATION ERP (Type W). Ce n'est pas un bâtiment ouvert au public. RÈGLES SPÉCIFIQUES À APPLIQUER (Articles R.4216 et suivants) : 1. Distances maximales : 30m si cul-de-sac (ou 1 seule issue), 40m si choix entre plusieurs issues. 2. Dégagements : Calculés selon l'effectif salarié uniquement (Pas de notion d'UP 0.60m comme en ERP). 3. Portes : Ouverture vers l'extérieur obligatoire seulement si effectif > 50 personnes. 4. Escaliers : Règles Code du Travail (Pas de giron/hauteur ERP stricts sauf si PMR).`;
            } else if(reg.includes("HAB")) { rulesContext = "RÉGLEMENTATION : HABITATION (CCH et Arrêté du 31 janvier 1986). Culs-de-sac max : 10m à l'air libre ou 15m (selon cas)."; } else if(reg.includes("ERP")) { rulesContext = `RÉGLEMENTATION : ERP (Arrêté du 25 juin 1980). Calcul en Unités de Passage (UP). 1 UP = 0.90m. 2 UP = 1.40m. Culs-de-sac max : 10m (stricte).`; } 
            let effectifStr = effectif ? `EFFECTIF DÉCLARÉ : ${effectif} personnes. (Consigne stricte: Base-toi sur ce chiffre pour tes calculs de largeurs). ` : `EFFECTIF : Non renseigné. `; 
            let instruction = `MISSION: BUREAU DE CONTRÔLE / AUDIT SÉCURITÉ. RÉGLEMENTATION APPLICABLE : ${reg} (${type}). ${effectifStr} CONTEXTE RÉGLEMENTAIRE DÉTAILLÉ : ${rulesContext} TACHE : Audit plan détaillé. IGNORE les joints de dilatation graphiques. MÉTHODE : Cherche les textes 'IS', 'Issue', 'Sortie' ou les portes donnant sur l'extérieur comme points de fuite pour mesurer les distances.`; 
            if (subMode === 'general') instruction += `\nFOCUS : AUDIT GLOBAL (Incendie, Évacuation, Désenfumage ET Accessibilité).`; else if (subMode === 'evac') instruction += `\nFOCUS : Évacuation & Culs-de-sac (Vérifie les distances R.4216 si ERT).`; else if (subMode === 'smoke') instruction += `\nFOCUS : Désenfumage (Naturel/Mécanique).`; else if (subMode === 'pmr') instruction += `\nFOCUS : Accessibilité PMR (Rotation, Pentes, Largeurs portes).`; 
            runAI(instruction); 
        }

        function triggerAcousticAction(action) { const type = document.getElementById('acou-type').value; const env = document.getElementById('acou-env').value; let instruction = `RÔLE : Ingénieur Acousticien. PROJET : ${type}. ENVIRONNEMENT : ${env}. MISSION : Analyse plan.`; if (action === 'audit') instruction += `\n1. Conflits acoustiques (WC/Chambre). 2. Isolement Façade. 3. Isolement Intérieur.`; else if (action === 'partition') instruction += `\nFOCUS CLOISONS : Préconise matériaux (SAD, Placostil) et portes (dB).`; runAI(instruction); }
        function triggerPermitAction(action) { const destElement = document.getElementById('permit-class'); const workElement = document.getElementById('permit-work'); const dest = destElement.options[destElement.selectedIndex].text; const work = workElement.options[workElement.selectedIndex].text; let instruction = `MISSION: Permis de Construire. DESTINATION DU PROJET: ${dest}. NATURE DES TRAVAUX: ${work}.`; if (action === 'cerfa') { instruction += ` ACTION: IDENTIFICATION CERFA. Détermine précisément le formulaire Cerfa adapté en fonction de la destination et des travaux. Liste ensuite de façon claire les pièces graphiques obligatoires à fournir (PCMI1, PCMI2, etc.).`; } else { instruction += ` ACTION: REDACTION NOTICE (PC4 / DP11). Rédige la notice architecturale et paysagère. Structure le texte avec ces parties : 1. L'état initial du terrain. 2. Aménagements prévus. 3. Implantation et volume. 4. Matériaux et couleurs. 5. Espaces libres et plantations. N'invente pas de données, utilise l'image fournie.`; } runAI(instruction); }
        
        function toggleCctpMode(mode) {
            const btnGen = document.getElementById('btn-cctp-gen'); const btnAna = document.getElementById('btn-cctp-ana');
            const secGen = document.getElementById('cctp-gen-section'); const secAna = document.getElementById('cctp-ana-section');
            if(mode === 'gen') {
                btnGen.className = "flex-1 py-2 text-[10px] font-bold uppercase rounded bg-white shadow text-blue-600 transition";
                btnAna.className = "flex-1 py-2 text-[10px] font-bold uppercase rounded text-slate-500 hover:text-slate-700 transition";
                secGen.classList.remove('hidden'); secGen.classList.add('flex');
                secAna.classList.add('hidden'); secAna.classList.remove('flex');
                document.getElementById('label-a').innerText = "Notice ou Plan (Optionnel)";
                document.getElementById('label-prompt').innerText = "Spécificités techniques / Instructions";
            } else {
                btnAna.className = "flex-1 py-2 text-[10px] font-bold uppercase rounded bg-white shadow text-slate-700 transition";
                btnGen.className = "flex-1 py-2 text-[10px] font-bold uppercase rounded text-slate-500 hover:text-slate-700 transition";
                secAna.classList.remove('hidden'); secAna.classList.add('flex');
                secGen.classList.add('hidden'); secGen.classList.remove('flex');
                document.getElementById('label-a').innerText = "CCTP existant (PDF)";
                document.getElementById('label-prompt').innerText = "Points d'attention spécifiques";
            }
        }

        function triggerCctpAction(action) {
            let instruction = "";
            if (action === 'generate') {
                const nature = document.getElementById('cctp-nature-gen').value;
                const lots = Array.from(document.querySelectorAll('#cctp-gen-section .checkbox-grid input:checked')).map(cb => cb.value).join(", ") || "Généralités";
                instruction = `MISSION : Rédige le Cahier des Clauses Techniques Particulières (CCTP) complet. LOT(S) CIBLE(S) : ${lots}. NATURE DES TRAVAUX : ${nature}. STRUCTURE OBLIGATOIRE : # CCTP - ${lots} ## 1. Généralités et Étendue des travaux ## 2. Textes de référence, Normes et DTU applicables ## 3. Provenance et caractéristiques des matériaux ## 4. Description détaillée des ouvrages et mise en œuvre Sois exhaustif, prescriptif et utilise le vocabulaire normatif du bâtiment.`;
            } else if (action === 'analyze') {
                const lot = document.getElementById('cctp-lot-ana').value || "Général";
                instruction = `MISSION : Analyse experte d'un CCTP existant. LOT(S) CIBLE(S) : ${lot}. TACHE : Vérifie la cohérence du document fourni en pièce jointe. Identifie les incohérences, les oublis de normes (DTU) et les éventuelles ambiguïtés qui pourraient poser problème sur le chantier ou lors de la facturation. STRUCTURE ATTENDUE : 1. Points d'alerte critiques 2. Normes ou DTU manquants 3. Précisions à demander au rédacteur.`;
            }
            runAI(instruction);
        }

        function loadDoc(id) { 
            const d = docs.find(doc => doc.id.toString() === id.toString()); 
            if(!d) return;
            switchMode(d.mode); 
            document.getElementById('result-output').innerHTML = d.content; 
            document.getElementById('empty-state').classList.add('hidden'); 
            document.getElementById('sheet-wrapper').classList.remove('d-none'); 
            document.getElementById('save-btn').classList.remove('hidden'); 
            document.getElementById('share-btn').classList.remove('hidden'); 
            document.getElementById('mail-btn').classList.remove('hidden'); 
            document.getElementById('word-btn').classList.remove('hidden'); 
            if(d.content.includes('<table')) { document.getElementById('excel-btn').classList.remove('hidden'); setTimeout(optimizeTable, 100); } 
            else { document.getElementById('excel-btn').classList.add('hidden'); } 
            
            // --- MODIF : SI ON CHARGE UN DOC, ON VEUT LE VOIR (PAS LE FORMULAIRE) ---
            if(window.innerWidth < 768) {
                document.getElementById('mobile-input-wrapper').classList.add('hidden');
                document.getElementById('mobile-edit-btn').classList.remove('hidden');
                document.getElementById('sheet-wrapper').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        async function copyEmailContent() {
            const content = document.getElementById('result-output').innerText;
            if(!content) return;
            document.getElementById('loader').classList.remove('hidden');
            const p = `Rédige un e-mail d'accompagnement très court et professionnel (vouvoiement) pour envoyer le document ci-dessous en pièce jointe. Ne mets pas d'objet. Le texte du document est : "${content.substring(0, 500)}..."`;
            try {
                const res = await fetch('/api/archi_tool', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ mode: "expertise", inputData: p }) });
                const mailText = await res.text();
                await navigator.clipboard.writeText(mailText.replace(/```(?:markdown|html)?\n?/gi, '').replace(/```\n?/g, '').trim());
                UI.toast("E-mail copié dans le presse-papier !");
            } catch(e) { UI.toast("Erreur lors de la génération de l'e-mail."); } finally { document.getElementById('loader').classList.add('hidden'); }
        }

        async function runAI(hiddenInstruction = null) {
            document.getElementById('loader').classList.remove('hidden');
            let p = ""; let userInput = document.getElementById('prompt-input').value;
            const currentFolderData = folders.find(f => f.name === currentFolder) || {}; const projectAddr = currentFolderData.address || "";

            // --- REPLI AUTOMATIQUE SUR MOBILE APRES LANCEMENT ---
            if(window.innerWidth < 768) {
                // On cache les inputs
                const wrapper = document.getElementById('mobile-input-wrapper');
                if (wrapper) wrapper.classList.add('hidden');
                
                // On montre le bouton "Modifier"
                const btnEdit = document.getElementById('mobile-edit-btn');
                if (btnEdit) btnEdit.classList.remove('hidden');
                
                // On scrolle vers le résultat
                setTimeout(() => {
                    const resultZone = document.getElementById('sheet-wrapper');
                    if (resultZone) resultZone.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
            // ----------------------------------------------

            if (hiddenInstruction) { p = hiddenInstruction + "\n\nCONTEXTE UTILISATEUR & NOTES : " + userInput; } 
            else if (currentMode === "plu") { const zone = document.getElementById('plu-zone').value || "Non definie"; const adresse = document.getElementById('plu-address').value || "Non definie"; p = `ROLE: Extracteur Juridique. SOURCE: Texte joint. CONTEXTE: Zone "${zone}" à "${adresse}". TACHE: Analyse les regles pour cette zone. FORMAT TABLEAU 3 COLONNES: | Regle | Preuve (Texte exact) | Valeur Cle (Resultat court) | Lignes: Vocation, Implantation Voies, Implantation Limites, Emprise Sol, Hauteur Max, Stationnement, Espaces Verts. IMPORTANT: Dans 'Valeur Cle', ne mets QUE le chiffre. Preuve = Phrase complete.`; } 
            else if (currentMode === "legal") { const typeVal = document.getElementById('legal-type').value; const typeTexte = typeVal === "OS" ? "un Ordre de Service (OS)" : typeVal === "MED" ? "une Mise en Demeure formelle" : "un Courrier de Réserve"; const contractor = document.getElementById('legal-contractor').value || "[Entreprise non spécifiée]"; const contractorAddr = document.getElementById('legal-contractor-address').value; const subject = document.getElementById('legal-subject').value || "Non spécifié"; const cpVilleText = `${config.zip || ''} ${config.city || ''}`.trim(); const senderInfo = [ config.name || "Le Maître d'Œuvre", config.address, cpVilleText, config.phone ? 'Tél : ' + config.phone : '', config.email ? 'Email : ' + config.email : '' ].filter(Boolean).join('\n'); p = `ROLE: Juriste BTP / Maître d'Œuvre. TACHE: Rédige ${typeTexte}. ÉMETTEUR : ${senderInfo} DESTINATAIRE: ${contractor} ${contractorAddr ? '\nAdresse: ' + contractorAddr : ''}. OBJET: ${subject}. CONTEXTE ET INSTRUCTIONS DU MOE: "${userInput}". CONSIGNE: Utilise un ton professionnel et ferme. Organise le courrier avec un en-tête typique, un corps de texte clair et structuré (Rappels des faits, Constats, Injonctions, Délais applicables), et une formule de politesse avec signature de l'émetteur. N'invente pas de détails hors contexte.`; }
            else if (currentMode === "devis") {
                if (hiddenInstruction && hiddenInstruction.includes("ACTION: GENERATE_DEVIS")) {
                    const cpVilleText = `${config.zip || ''} ${config.city || ''}`.trim();
                    const senderInfo = [config.name || "Le Maître d'Œuvre", config.address, cpVilleText, config.phone ? 'Tél : ' + config.phone : '', config.email ? 'Email : ' + config.email : ''].filter(Boolean).join('\n');
                    const today = new Date().toLocaleDateString('fr-FR');
                    p = `INFORMATIONS OBLIGATOIRES POUR L'EN-TÊTE DU DEVIS :\n- DATE DU DEVIS : ${today}\n- ÉMETTEUR (Tes coordonnées) : \n${senderInfo}\n\n` + p;
                }
            }
            else { p = userInput; }
            
            try {
                const res = await fetch('/api/archi_tool', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ mode: currentMode, projectName: currentFolder, projectAddress: projectAddr, pdfContent: inputA, quoteContent: inputB, images: inputImgs, inputData: p, currentDate: new Date().toLocaleDateString() }) });
                const rawText = await res.text();
                let html = formatModernText(rawText); html = getHeaderHTML() + html;
                if(currentMode === "plu") { const addr = document.getElementById('plu-address').value; if(addr) html = html.replace(getHeaderHTML(), getHeaderHTML() + `<h1>ANALYSE URBAINE - ${addr.toUpperCase()}</h1>`); }
                if ((currentMode === "report" || currentMode === "legal" || currentMode === "snag") && inputImgs.length > 0) { html += `<h2 style="margin-top: 40px; border-bottom: 2px solid #000; padding-bottom: 10px;">ANNEXE PHOTOGRAPHIQUE</h2><div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">`; inputImgs.forEach((imgBase64, idx) => { html += `<div style="break-inside: avoid;"><img src="data:image/jpeg;base64,${imgBase64}" style="width: 100%; border-radius: 8px; border: 1px solid #CBD5E1;"><p style="text-align: center; font-size: 9px; font-weight: bold; color: #64748B; margin-top: 5px;">Photo ${idx + 1}</p></div>`; }); html += `</div>`; } 
                else if ((currentMode === "permit" || currentMode === "control" || currentMode === "acoustic" || currentMode === "dpgf" || currentMode === "cctp") && inputImgs.length > 0) { html += `<h2 style="margin-top: 40px; border-bottom: 2px solid #000; padding-bottom: 10px;">DOCUMENTS GRAPHIQUES / PLANS</h2><div style="margin-top: 15px; text-align: center;">`; inputImgs.forEach((imgBase64) => { html += `<img src="data:image/jpeg;base64,${imgBase64}" style="max-width: 100%; max-height: 800px; border-radius: 8px; border: 1px solid #CBD5E1; margin-bottom: 15px; display: inline-block; break-inside: avoid;">`; }); html += `</div>`; }
                document.getElementById('result-output').innerHTML = html;
                document.getElementById('empty-state').classList.add('hidden'); document.getElementById('save-btn').classList.remove('hidden'); document.getElementById('share-btn').classList.remove('hidden'); document.getElementById('mail-btn').classList.remove('hidden'); document.getElementById('word-btn').classList.remove('hidden'); if(document.getElementById('result-output').innerHTML.includes('<table')) { document.getElementById('excel-btn').classList.remove('hidden'); setTimeout(optimizeTable, 100); }
            } catch(e) { alert("Erreur Assistant IA"); } finally { document.getElementById('loader').classList.add('hidden'); }
        }

        async function shareToOffice() { const content = document.getElementById('result-output').innerText; if(!content || content.length < 10) return alert("Rien"); const title = `BatiPilot - ${currentMode.toUpperCase()} - ${currentFolder}`; if (navigator.share) { try { await navigator.share({ title: title, text: content }); } catch (err) {} } else { window.location.href = `mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(content)}`; } }

        function switchMode(mode) {
            currentMode = mode; 
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); 
            const btn = document.getElementById('btn-'+mode); if(btn) btn.classList.add('active');
            
            const info = modeInfos[mode] || { t: "Document sauvegardé", d: "Consultation d'archive" }; 
            document.getElementById('help-title').innerText = info.t; 
            document.getElementById('help-desc').innerText = info.d;
            
            document.getElementById('result-output').innerHTML = ""; document.getElementById('prompt-input').value = ""; 
            document.getElementById('empty-state').classList.remove('hidden'); document.getElementById('save-btn').classList.add('hidden'); document.getElementById('share-btn').classList.add('hidden'); document.getElementById('mail-btn').classList.add('hidden'); document.getElementById('word-btn').classList.add('hidden'); document.getElementById('excel-btn').classList.add('hidden'); document.getElementById('run-btn').classList.remove('d-none'); 

            document.getElementById('planning-form').classList.add('d-none'); document.getElementById('plu-form').classList.add('d-none'); document.getElementById('permit-form').classList.add('d-none'); document.getElementById('control-form').classList.add('d-none'); document.getElementById('acoustic-form').classList.add('d-none'); document.getElementById('legal-form').classList.add('d-none'); document.getElementById('cctp-form').classList.add('d-none'); document.getElementById('devis-form').classList.add('d-none'); 
            
            document.getElementById('inputs-files').classList.add('d-none'); document.getElementById('text-input-zone').classList.add('d-none'); document.getElementById('zone-a').style.display = 'none'; document.getElementById('zone-b').style.display = 'none'; document.getElementById('zone-img').style.display = 'none';

            // --- MODIF IMPORTANTE : RESET L'AFFICHAGE MOBILE POUR MONTRER LE FORMULAIRE ---
            if(window.innerWidth < 768) {
                document.getElementById('mobile-input-wrapper').classList.remove('hidden');
                document.getElementById('mobile-edit-btn').classList.add('hidden');
                document.getElementById('left-panel').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            // --------------------------------------------------------------------------

            const tagsContainer = document.getElementById('quick-tags');
            const tags = modeTags[mode];
            if (tags && tags.length > 0) {
                tagsContainer.innerHTML = tags.map(t => `<span onclick="addTag(this, '${t}')" class="bg-blue-50 text-blue-600 border border-blue-200 px-2 py-1 rounded text-[10px] font-bold cursor-pointer hover:bg-blue-100 transition shadow-sm">+ ${t}</span>`).join('');
                tagsContainer.classList.remove('hidden');
            } else {
                tagsContainer.classList.add('hidden');
                tagsContainer.innerHTML = "";
            }

            if(mode === 'planning') { document.getElementById('planning-form').classList.remove('d-none'); document.getElementById('planning-form').style.display = 'flex'; document.getElementById('run-btn').classList.add('d-none'); }
            else if(mode === 'plu') { document.getElementById('plu-form').classList.remove('d-none'); document.getElementById('inputs-files').classList.remove('d-none'); document.getElementById('label-a').innerText = "Règlement (PDF)"; document.getElementById('zone-a').style.display = 'flex'; document.getElementById('text-input-zone').classList.remove('d-none'); document.getElementById('label-prompt').innerText = "Instructions Supplémentaires"; }
            else if(mode === 'permit') { document.getElementById('permit-form').classList.remove('d-none'); document.getElementById('permit-form').style.display = 'flex'; document.getElementById('inputs-files').classList.remove('d-none'); document.getElementById('text-input-zone').classList.remove('d-none'); document.getElementById('zone-img').style.display = 'flex'; document.getElementById('label-img').innerText = "Façades / 3D"; document.getElementById('label-prompt').innerText = "Notes Visuelles"; document.getElementById('run-btn').classList.add('d-none'); }
            else if (mode === 'control') { document.getElementById('control-form').classList.remove('d-none'); document.getElementById('control-form').style.display = 'flex'; document.getElementById('inputs-files').classList.remove('d-none'); document.getElementById('text-input-zone').classList.remove('d-none'); document.getElementById('zone-img').style.display = 'flex'; document.getElementById('label-img').innerText = "PLAN (Image)"; document.getElementById('zone-a').style.display = 'flex'; document.getElementById('label-a').innerText = "Plan (PDF)"; document.getElementById('label-prompt').innerText = "Notes Techniques"; document.getElementById('run-btn').classList.add('d-none'); }
            else if (mode === 'acoustic') { document.getElementById('acoustic-form').classList.remove('d-none'); document.getElementById('acoustic-form').style.display = 'flex'; document.getElementById('inputs-files').classList.remove('d-none'); document.getElementById('text-input-zone').classList.remove('d-none'); document.getElementById('zone-img').style.display = 'flex'; document.getElementById('label-img').innerText = "PLAN (Image)"; document.getElementById('zone-a').style.display = 'flex'; document.getElementById('label-a').innerText = "Plan (PDF)"; document.getElementById('label-prompt').innerText = "Notes Acoustiques"; document.getElementById('run-btn').classList.add('d-none'); }
            else if (mode === 'dpgf') { document.getElementById('inputs-files').classList.remove('d-none'); document.getElementById('text-input-zone').classList.remove('d-none'); document.getElementById('zone-img').style.display = 'flex'; document.getElementById('label-img').innerText = "PLAN (Image)"; document.getElementById('zone-a').style.display = 'flex'; document.getElementById('label-a').innerText = "Plan (PDF)"; document.getElementById('label-prompt').innerText = "Lots spécifiques ou Instructions"; }
            else if (mode === 'cctp') { document.getElementById('cctp-form').classList.remove('d-none'); document.getElementById('cctp-form').style.display = 'flex'; document.getElementById('inputs-files').classList.remove('d-none'); document.getElementById('text-input-zone').classList.remove('d-none'); document.getElementById('zone-img').style.display = 'flex'; document.getElementById('zone-a').style.display = 'flex'; document.getElementById('run-btn').classList.add('d-none'); toggleCctpMode('gen'); }
            else if (mode === 'devis') { document.getElementById('devis-form').classList.remove('d-none'); document.getElementById('devis-form').style.display = 'flex'; document.getElementById('run-btn').classList.add('d-none'); toggleDevisMode('gen'); }
            else if (mode === 'legal') { document.getElementById('legal-form').classList.remove('d-none'); document.getElementById('legal-form').style.display = 'flex'; document.getElementById('inputs-files').classList.remove('d-none'); document.getElementById('text-input-zone').classList.remove('d-none'); document.getElementById('zone-a').style.display = 'flex'; document.getElementById('label-a').innerText = "Pièce jointe / CCTP (PDF)"; document.getElementById('zone-img').style.display = 'flex'; document.getElementById('label-img').innerText = "Photos (Annexe)"; document.getElementById('label-prompt').innerText = "Détails / Délais / Contexte"; }
            else if (mode === 'soil') { document.getElementById('inputs-files').classList.remove('d-none'); document.getElementById('text-input-zone').classList.remove('d-none'); document.getElementById('zone-a').style.display = 'flex'; document.getElementById('label-a').innerText = "Étude de Sol (PDF)"; document.getElementById('label-prompt').innerText = "Questions spécifiques (Optionnel)"; document.getElementById('prompt-input').placeholder = "Ex: Peux-tu me résumer le type de fondation ?"; }
            else if (mode === 'meeting') { document.getElementById('inputs-files').classList.remove('d-none'); document.getElementById('text-input-zone').classList.remove('d-none'); document.getElementById('zone-a').style.display = 'flex'; document.getElementById('label-a').innerText = "Ordre du jour (PDF/Optionnel)"; document.getElementById('label-prompt').innerText = "Notes brutes de la réunion (Dictez ou tapez)"; document.getElementById('prompt-input').placeholder = "Ex: Le maçon doit refaire l'arase pour mardi. Plombier absent..."; }
            else if (mode === 'snag') { document.getElementById('inputs-files').classList.remove('d-none'); document.getElementById('text-input-zone').classList.remove('d-none'); document.getElementById('zone-img').style.display = 'flex'; document.getElementById('label-img').innerText = "Photos des défauts"; document.getElementById('label-prompt').innerText = "Liste des réserves en vrac"; document.getElementById('prompt-input').placeholder = "Ex: Peinture écaillée porte entrée. Joint manquant baignoire..."; }
            else if (['comparison', 'situation', 'report', 'expertise'].includes(mode)) { 
                document.getElementById('inputs-files').classList.remove('d-none'); document.getElementById('text-input-zone').classList.remove('d-none'); const isC = (mode==='comparison'||mode==='situation'), isR = (mode==='report'||mode==='situation'); document.getElementById('zone-b').style.display = isC?'flex':'none'; document.getElementById('zone-img').style.display = isR?'flex':'none'; if(isR) document.getElementById('label-img').innerText = "Photos Chantier"; document.getElementById('zone-a').style.display = (isR&&!isC)?'none':'flex'; document.getElementById('label-a').innerText = isC?'CCTP / Ref':'Fichier'; document.getElementById('prompt-input').placeholder = "Instructions..."; document.getElementById('label-prompt').innerText = "NOTES"; 
            }
        }
        
        const UI = { toggleConfig: () => document.getElementById('config-modal').classList.toggle('hidden'), toast: (m) => { document.getElementById('toast-msg').innerText=m; document.getElementById('toast-container').classList.add('show'); setTimeout(()=>document.getElementById('toast-container').classList.remove('show'), 2000); } };
        function encodeImg(input, key) { const r = new FileReader(); r.onload = e => { config[key] = e.target.result; if(key === 'logo') { const img = document.getElementById('cfg-logo-preview'); img.src = e.target.result; img.classList.remove('hidden'); } }; r.readAsDataURL(input.files[0]); }
        let recognition; if('webkitSpeechRecognition' in window) { recognition=new webkitSpeechRecognition(); recognition.continuous=true; recognition.onresult=e=>{ let t=""; for(let i=e.resultIndex;i<e.results.length;++i) if(e.results[i].isFinal) t+=e.results[i][0].transcript; document.getElementById('prompt-input').value+=t+" "; }; }
        function toggleDictation() { const b=document.getElementById('mic-btn'); if(b.classList.contains('mic-active')) { recognition.stop(); b.classList.remove('mic-active'); } else { recognition.start(); b.classList.add('mic-active'); } }

        function openAdminPanel() {
            document.getElementById('admin-modal').classList.remove('hidden');
            const list = document.getElementById('admin-agency-list');
            list.innerHTML = '<div class="flex justify-center p-4"><i class="fa-solid fa-circle-notch fa-spin text-slate-300"></i></div>';

            db.collection("agencies").orderBy("createdAt", "desc").get().then((querySnapshot) => {
                list.innerHTML = "";
                if (querySnapshot.empty) {
                    list.innerHTML = "<p class='text-xs'>Aucune agence trouvée.</p>";
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const agencyId = doc.id;
                    const isAgency = data.plan === 'agency';
                    const emailDisplay = data.ownerEmail ? `<div class="text-xs text-blue-600 font-bold mb-1"><i class="fa-regular fa-envelope mr-1"></i>${data.ownerEmail}</div>` : '<div class="text-xs text-gray-400 italic mb-1">Email non enregistré</div>';
                    
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center p-3 bg-slate-50 rounded border border-slate-200 hover:bg-white transition mb-2";
                    div.innerHTML = `
                        <div>
                            <div class="font-bold text-sm text-slate-900">${data.name || 'Sans nom'}</div>
                            ${emailDisplay}
                            <div class="text-[9px] text-slate-400 font-mono">ID: ${agencyId}</div>
                            <div class="mt-1">
                                <span class="px-2 py-0.5 rounded text-[9px] font-bold uppercase ${isAgency ? 'bg-purple-100 text-purple-700 border border-purple-200' : 'bg-slate-200 text-slate-600 border border-slate-300'}">
                                    ${isAgency ? 'PLAN AGENCE' : 'PLAN SOLO'}
                                </span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            ${!isAgency ? 
                                `<button onclick="switchPlan('${agencyId}', 'agency')" class="bg-purple-600 text-white px-3 py-2 rounded text-[10px] font-bold hover:bg-purple-700 shadow flex items-center gap-1"><i class="fa-solid fa-arrow-up"></i> UPGRADE</button>` : 
                                `<button onclick="switchPlan('${agencyId}', 'solo')" class="bg-white text-slate-600 border border-slate-300 px-3 py-2 rounded text-[10px] font-bold hover:bg-slate-50">DOWNGRADE</button>`
                            }
                        </div>
                    `;
                    list.appendChild(div);
                });
            });
        }

        function adminCreateUser() {
            const name = document.getElementById('admin-new-name').value;
            const email = document.getElementById('admin-new-email').value;
            const pass = document.getElementById('admin-new-pass').value;
            const plan = document.getElementById('admin-new-plan').value;
            const msg = document.getElementById('admin-create-msg');

            if(!name || !email || !pass) {
                msg.innerText = "Tous les champs sont requis.";
                msg.className = "text-center text-xs font-bold text-red-500 mt-2 block";
                return;
            }

            msg.innerText = "Création en cours...";
            msg.className = "text-center text-xs font-bold text-blue-500 mt-2 block";

            let secondaryApp;
            try { secondaryApp = firebase.app("SecondaryApp"); } 
            catch (e) { secondaryApp = firebase.initializeApp(firebaseConfig, "SecondaryApp"); }

            secondaryApp.auth().createUserWithEmailAndPassword(email, pass)
                .then(async (userCredential) => {
                    const newUid = userCredential.user.uid;
                    const newAgencyRef = await db.collection("agencies").add({ 
                        name: name, 
                        plan: plan, 
                        ownerEmail: email, 
                        createdAt: firebase.firestore.FieldValue.serverTimestamp() 
                    });
                    await db.collection("users").doc(newUid).set({ 
                        email: email, 
                        agencyId: newAgencyRef.id, 
                        role: "admin" 
                    });
                    await db.collection("agencies").doc(newAgencyRef.id).collection("folders").doc("Général").set({
                        name: "Général", address: "", color: "blue"
                    });
                    secondaryApp.auth().signOut();
                    msg.innerText = "Compte créé avec succès !";
                    msg.className = "text-center text-xs font-bold text-emerald-500 mt-2 block";
                    document.getElementById('admin-new-name').value = "";
                    document.getElementById('admin-new-email').value = "";
                    document.getElementById('admin-new-pass').value = "";
                    openAdminPanel(); 
                })
                .catch(error => {
                    msg.innerText = "Erreur: " + error.message;
                    msg.className = "text-center text-xs font-bold text-red-500 mt-2 block";
                });
        }

        function switchPlan(agencyId, newPlan) {
            if(!confirm(`Confirmer le passage en plan ${newPlan.toUpperCase()} pour ce client ?`)) return;
            db.collection("agencies").doc(agencyId).update({ plan: newPlan }).then(() => { alert("Plan modifié avec succès !"); openAdminPanel(); }).catch((error) => { alert("Erreur : " + error.message); });
        }

        let chatOpen = false;
        function toggleChat() {
            const chat = document.getElementById('chat-widget');
            chatOpen = !chatOpen;
            if(chatOpen) { chat.classList.remove('hidden'); } else { chat.classList.add('hidden'); }
        }

        function appendMessage(role, text) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = role === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot';
            div.innerHTML = text.replace(/\n/g, '<br>');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function checkDailyLimit() {
            const today = new Date().toLocaleDateString();
            let storedDate = localStorage.getItem('chat_date');
            let count = parseInt(localStorage.getItem('chat_count') || '0');
            if(storedDate !== today) { count = 0; localStorage.setItem('chat_date', today); }
            const limit = currentAgencyPlan === 'agency' ? 100 : 20;
            document.getElementById('chat-count').innerText = count;
            document.getElementById('chat-limit').innerText = limit;
            return count < limit;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;
            if(!checkDailyLimit()) { appendMessage('bot', "Limite journalière atteinte."); return; }
            appendMessage('user', msg);
            input.value = "";
            const loadingId = 'bot-load-' + Date.now();
            const container = document.getElementById('chat-messages');
            const loaderDiv = document.createElement('div');
            loaderDiv.id = loadingId;
            loaderDiv.className = 'chat-bubble-bot';
            loaderDiv.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';
            container.appendChild(loaderDiv);
            container.scrollTop = container.scrollHeight;
            try {
                const res = await fetch('/api/archi_tool', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ mode: "chat_btp", inputData: `AGIS COMME : Expert BTP Senior. QUESTION : "${msg}". REPONSE TECHNIQUE.` }) });
                const text = await res.text();
                document.getElementById(loadingId).remove();
                appendMessage('bot', text.replace(/```/g, ''));
                let count = parseInt(localStorage.getItem('chat_count') || '0');
                count++;
                localStorage.setItem('chat_count', count);
                checkDailyLimit();
            } catch(e) {
                document.getElementById(loadingId).remove();
                appendMessage('bot', "Erreur de connexion.");
            }
        }
    </script>
</body>
</html>